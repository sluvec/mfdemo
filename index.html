<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM System - Relocation Company v1.0</title>
    
    <!-- Document Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    
    <style>
        :root {
            /* Standard CRM Professional Color Palette */
            --primary-color: #3b82f6;
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;
            
            --secondary-50: #f8fafc;
            --secondary-100: #f1f5f9;
            --secondary-200: #e2e8f0;
            --secondary-300: #cbd5e1;
            --secondary-400: #94a3b8;
            --secondary-500: #64748b;
            --secondary-600: #475569;
            --secondary-700: #334155;
            --secondary-800: #1e293b;
            --secondary-900: #0f172a;
            
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-200: #bbf7d0;
            --success-300: #86efac;
            --success-400: #4ade80;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;
            --success-800: #166534;
            --success-900: #14532d;
            
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-200: #fde68a;
            --warning-300: #fcd34d;
            --warning-400: #fbbf24;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --warning-700: #b45309;
            --warning-800: #92400e;
            --warning-900: #78350f;
            
            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-200: #fecaca;
            --error-300: #fca5a5;
            --error-400: #f87171;
            --error-500: #ef4444;
            --error-600: #dc2626;
            --error-700: #b91c1c;
            --error-800: #991b1b;
            --error-900: #7f1d1d;
            
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
        }



        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--secondary-50) 50%, var(--neutral-50) 100%);
            color: var(--neutral-800);
            line-height: 1.6;
            font-size: 14px;
            font-weight: 400;
            min-height: 100vh;
        }
        
        .navbar { 
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white; 
            padding: var(--space-lg) var(--space-xl);
            box-shadow: var(--shadow-lg);
            border-bottom: 1px solid var(--primary-500);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar .nav-left {
            display: flex;
            align-items: center;
        }
        .navbar .nav-right {
            display: flex;
            align-items: center;
        }
        .navbar h1 { 
            display: inline-block; 
            margin-right: var(--space-2xl);
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        .navbar button { 
            background: rgba(255, 255, 255, 0.1);
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: var(--space-sm) var(--space-lg);
            margin: 0 var(--space-xs);
            cursor: pointer;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-sm);
        }
        .navbar button:hover { 
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .navbar button.active { 
            background: rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .container { 
            max-width: 1200px; 
            margin: var(--space-xl) auto; 
            padding: 0 var(--space-lg);
        }
        .page { 
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active { 
            display: block; 
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        .card h2 { 
            margin-bottom: var(--space-lg);
            color: var(--neutral-900);
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--neutral-900) 0%, var(--neutral-700) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Success and Error Messages */
        .success-msg {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-500);
            color: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            font-weight: 500;
        }
        
        .error-msg {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--error-500);
            color: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            font-weight: 500;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Form Validation Styles */
        .input-error {
            border-color: var(--error-500) !important;
            box-shadow: 0 0 0 2px var(--error-100) !important;
        }
        
        .input-error:focus {
            border-color: var(--error-600) !important;
            box-shadow: 0 0 0 2px var(--error-200) !important;
        }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }
        
        @media (max-width: 1200px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
        }
        .stat-card { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(249, 250, 251, 0.9) 100%);
            backdrop-filter: blur(10px);
            padding: var(--space-lg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            text-align: center;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary-400) 0%, var(--secondary-400) 100%);
        }
        .stat-card.clickable {
            cursor: pointer;
        }
        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }
        .stat-card h3 { 
            color: var(--neutral-600);
            font-size: 0.875rem;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .value { 
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--neutral-900);
            margin-bottom: var(--space-xs);
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            word-break: break-word;
        }
        
        button { 
            background: var(--primary-500);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            cursor: pointer;
            margin-right: var(--space-sm);
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-sm);
            border: 1px solid transparent;
        }
        button:hover { 
            background: var(--primary-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary { 
            background: var(--neutral-100);
            color: var(--neutral-700);
            border: 1px solid var(--neutral-300);
        }
        button.secondary:hover { 
            background: var(--neutral-200);
            color: var(--neutral-800);
            border-color: var(--neutral-400);
        }
        button.danger { 
            background: var(--error-600);
        }
        button.danger:hover { 
            background: var(--error-700);
        }
        button.success { 
            background: var(--success-600);
        }
        button.success:hover { 
            background: var(--success-700);
        }
        
        /* Adjust table action buttons to match Edit button height but wider */
        #pc-list button.success {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
            white-space: nowrap;
        }
        
        /* Action button groups for table rows */
        .action-btn-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .action-btn-group button {
            margin: 0;
            white-space: nowrap;
        }
        
        .warning { 
            background: var(--warning-600);
        }
        .warning { 
            background: var(--warning-600);
        }
        .warning:hover { 
            background: var(--warning-700);
        }
        
        input, select, textarea { 
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
        }
        
        /* Fix for dropdown z-index issue - ensure dropdowns appear above sticky elements */
        select {
            position: relative;
            z-index: 1000;
        }
        
        /* Ensure dropdown options appear above sticky elements */
        .line-item select {
            position: relative;
            z-index: 1001;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        input[readonly] { 
            background: var(--neutral-100);
            color: var(--neutral-600);
            cursor: not-allowed;
            border-color: var(--neutral-300);
        }
        label { 
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--neutral-700);
            font-size: 0.875rem;
        }
        
        .input-error {
            background-color: var(--error-50) !important;
            border-color: var(--error-500) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }
        
        /* Delicate borders for PC form fields */
        #new-pc input, #new-pc select, #new-pc textarea {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            background: #ffffff;
            transition: all 0.2s ease;
        }
        
        #new-pc input:focus, #new-pc select:focus, #new-pc textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        #new-pc input:hover, #new-pc select:hover, #new-pc textarea:hover {
            border-color: #9ca3af;
        }
        
        table { 
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        th, td { 
            padding: var(--space-md);
            text-align: left;
            border-bottom: 1px solid var(--neutral-200);
        }
        th { 
            background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-50) 100%);
            font-weight: 600;
            color: var(--neutral-800);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:hover td {
            background: var(--primary-50);
        }
        
        .modal { 
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        .modal.active { 
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content { 
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: var(--space-xl);
            border-radius: var(--radius-xl);
            width: 95%;
            max-width: 1600px;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* Responsive modal content */
        @media (max-width: 1600px) {
            .modal-content {
                width: 98%;
                max-width: 1400px;
                padding: var(--space-lg);
            }
        }
        
        @media (max-width: 1200px) {
            .modal-content {
                width: 98%;
                max-width: 1000px;
                padding: var(--space-lg);
            }
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 100%;
                max-width: none;
                margin: 1rem;
                padding: var(--space-md);
                max-height: calc(100vh - 2rem);
            }
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .quote-builder { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .quote-left-column { display: flex; flex-direction: column; gap: 1rem; }
        .line-item { 
            display: grid; 
            grid-template-columns: 2.5fr 0.8fr 1.5fr 0.8fr 1fr auto; 
            gap: 0.5rem; 
            align-items: center; 
            margin-bottom: 0.5rem; 
        }
        .line-item input, .line-item select { 
            margin-bottom: 0; 
            padding: 0.5rem; 
        }
        .line-item .line-item-unit {
             padding: 0.5rem;
             font-size: 0.9em;
             color: #333;
             text-align: center;
        }
        .line-item .manual-price-control { display: flex; align-items: center; gap: 0.5rem; }
        .line-item .manual-price-control input[type="number"] { flex-grow: 1; min-width: 80px; }
        .line-item .manual-price-control label { font-size: 0.8em; display: flex; align-items: center; margin-bottom: 0; }
        .line-item .manual-price-control input[type="checkbox"] { width: auto; margin-right: 5px; }

        .remove-btn { 
            background: #e74c3c; 
            padding: 0.5rem; 
            color: white;
            border: none;
            cursor: pointer;
        }
        .remove-btn:hover { 
            background: #c0392b; 
        }
        
        .category-section { background: #f8f9fa; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .summary { 
            background: #f8f9fa; 
            padding: 1.5rem; 
            border-radius: 8px; 
            position: sticky; 
            top: 1rem; 
            height: fit-content;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .summary-total { border-top: 2px solid #ddd; padding-top: 1rem; margin-top: 1rem; font-weight: bold; }
        
        .success-msg { 
            background: var(--success-50);
            color: var(--success-800);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--success-200);
            font-weight: 500;
        }
        .error-msg { 
            background: var(--error-50);
            color: var(--error-800);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--error-200);
            font-weight: 500;
        }
        
        .activity-status { 
            display: inline-block; 
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid transparent;
        }
        .activity-status.pending { 
            background: var(--warning-100);
            color: var(--warning-800);
            border-color: var(--warning-200);
        }
        .activity-status.scheduled { 
            background: var(--primary-100);
            color: var(--primary-800);
            border-color: var(--primary-200);
        }
        .activity-status.in-progress { 
            background: var(--secondary-100);
            color: var(--secondary-800);
            border-color: var(--secondary-200);
        }
        .activity-status.completed { 
            background: var(--success-100);
            color: var(--success-800);
            border-color: var(--success-200);
        }
        .activity-status.cancelled { 
            background: var(--error-100);
            color: var(--error-800);
            border-color: var(--error-200);
        }
        /* New Status Styles */
        .activity-status.draft {
            background-color: var(--neutral-200);
            color: var(--neutral-700);
        }
        
        .activity-status.ready {
            background-color: var(--warning-200);
            color: var(--warning-800);
        }
        
        .activity-status.sent {
            background-color: var(--primary-200);
            color: var(--primary-800);
        }
        
        .activity-status.pending {
            background-color: var(--warning-200);
            color: var(--warning-800);
        }
        
        .activity-status.synced {
            background-color: var(--success-200);
            color: var(--success-800);
        }
        
        .activity-status.failed {
            background-color: var(--error-200);
            color: var(--error-800);
        }
        
        .activity-status.retry {
            background-color: var(--warning-300);
            color: var(--warning-900);
        }
        
        .activity-form-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 0.75rem; 
        }
        
        /* Responsive grid for activity form */
        @media (max-width: 1400px) {
            .activity-form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1000px) {
            .activity-form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .activity-form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .activity-form-grid .full-width { grid-column: 1 / -1; }
        .activity-form-grid .span-2 { grid-column: span 2; }
        .activity-form-grid .span-3 { grid-column: span 3; }
        
        .activity-form-grid input, 
        .activity-form-grid select, 
        .activity-form-grid textarea { 
            margin-bottom: 0.25rem; 
            padding: 0.5rem; 
            font-size: 0.85rem;
        }
        
        .activity-form-grid label { 
            margin-bottom: 0.2rem; 
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--neutral-700);
        }
        
        .activity-form-grid textarea { 
            min-height: 40px; 
            resize: vertical; 
        }
        
        .activity-section {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .activity-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-700);
            border-bottom: 2px solid var(--primary-200);
            padding-bottom: 0.5rem;
        }
        
        .activity-section .section-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        
        @media (max-width: 1400px) {
            .activity-section .section-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1000px) {
            .activity-section .section-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .activity-section .section-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .resources-section {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        
        .resources-category-section {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin-bottom: 0;
        }
        
        .resources-category-section h5 {
            margin: 0 0 0.4rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-700);
        }
        
        .resources-category-section p {
            margin: 0 0 0.5rem 0;
            font-size: 0.75rem;
            color: var(--neutral-600);
            font-style: italic;
        }
        
        /* Team Instructions Alert Styles */
        .team-instructions-section {
            border-left: 4px solid var(--warning-500);
            background: var(--warning-50);
        }
        
        .team-instructions-section h4 {
            color: var(--warning-800);
            border-bottom-color: var(--warning-300);
        }
        
        .alert-warning {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            background: var(--warning-100);
            border: 1px solid var(--warning-300);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 0.5rem;
        }
        
        .alert-icon {
            font-size: 1.2rem;
            color: var(--warning-600);
            flex-shrink: 0;
            margin-top: 0.1rem;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-content label {
            display: block;
            font-weight: 600;
            color: var(--warning-800);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .alert-content textarea {
            width: 100%;
            border: 1px solid var(--warning-400);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            font-size: 0.9rem;
            background: white;
            resize: vertical;
            min-height: 80px;
        }
        
        .alert-content textarea:focus {
            outline: none;
            border-color: var(--warning-600);
            box-shadow: 0 0 0 2px var(--warning-200);
        }
        
        .alert-content textarea::placeholder {
            color: var(--warning-600);
            font-style: italic;
        }
        
        .resource-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .resource-item input, .resource-item select {
            padding: 0.4rem;
            font-size: 0.85rem;
            margin: 0;
        }
        
        .resource-selection-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .resource-selection-item label {
            margin: 0;
            font-weight: normal;
            font-size: 0.85rem;
        }
        
        .resource-selection-item input {
            padding: 0.3rem;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .resource-remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .resource-remove-btn:hover {
            background: #c0392b;
        }
        
        /* Calendar Styles - Optimized */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--neutral-200);
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .calendar-header {
            background: var(--primary-600);
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.25px;
        }
        
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            border-right: 1px solid var(--neutral-100);
            border-bottom: 1px solid var(--neutral-100);
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day:hover {
            background: var(--primary-50);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .calendar-day-number {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--neutral-800);
            margin-bottom: 0.375rem;
            text-align: right;
        }
        
        .calendar-day.other-month {
            background: var(--neutral-50);
            color: var(--neutral-400);
        }
        
        .calendar-day.other-month .calendar-day-number {
            color: var(--neutral-400);
        }
        
        .calendar-day.today {
            background: var(--primary-50);
            border: 2px solid var(--primary-500);
        }
        
        .calendar-day.today .calendar-day-number {
            color: var(--primary-700);
            font-weight: 700;
        }
        
        .calendar-activities-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            overflow: hidden;
        }
        
        .calendar-activity {
            background: var(--primary-500);
            color: white;
            padding: 0.25rem 0.375rem;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.15s ease;
            border-left: 2px solid var(--primary-700);
        }
        
        .calendar-activity:hover {
            transform: translateX(1px);
            box-shadow: var(--shadow-sm);
        }
        
        .calendar-activity.pending { 
            background: var(--warning-500); 
            border-left-color: var(--warning-700);
        }
        .calendar-activity.scheduled { 
            background: var(--primary-500); 
            border-left-color: var(--primary-700);
        }
        .calendar-activity.in-progress { 
            background: var(--success-500); 
            border-left-color: var(--success-700);
        }
        .calendar-activity.completed { 
            background: var(--neutral-500); 
            border-left-color: var(--neutral-700);
        }
        .calendar-activity.cancelled { 
            background: var(--error-500); 
            border-left-color: var(--error-700);
        }
        
        .calendar-more-activities {
            background: var(--neutral-200);
            color: var(--neutral-600);
            padding: 0.2rem 0.375rem;
            border-radius: var(--radius-sm);
            font-size: 0.65rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .calendar-more-activities:hover {
            background: var(--neutral-300);
            color: var(--neutral-700);
        }
        
        .calendar-week-view {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 2px;
            background: var(--neutral-200);
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .calendar-time-slot {
            background: var(--primary-500);
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            border-right: 1px solid var(--neutral-300);
        }
        
        .calendar-week-day {
            background: white;
            position: relative;
            border-right: 1px solid var(--neutral-100);
            min-height: 60px;
            padding: 0.25rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        
        .calendar-week-day:hover {
            background: var(--primary-50);
        }
        
        /* Day View Styles */
        .calendar-day-view {
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .day-summary {
            background: var(--primary-500);
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .day-summary h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }
        
        .day-summary p {
            margin: 0;
            opacity: 0.9;
        }
        
        .no-activities {
            padding: 2rem;
            text-align: center;
            color: var(--neutral-500);
        }
        
        .day-activities {
            padding: 1rem;
        }
        
        .day-time-slot {
            display: flex;
            border-bottom: 1px solid var(--neutral-200);
            min-height: 60px;
        }
        
        .day-time-slot:last-child {
            border-bottom: none;
        }
        
        .time-label {
            width: 80px;
            padding: 0.75rem 0.5rem;
            background: var(--neutral-100);
            border-right: 1px solid var(--neutral-200);
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            color: var(--neutral-700);
        }
        
        .time-activities {
            flex: 1;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .time-empty {
            color: var(--neutral-400);
            font-style: italic;
            text-align: center;
            padding: 0.5rem;
        }
        
        .day-activity {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
            border-left: 4px solid var(--primary-500);
        }
        
        .day-activity:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .day-activity.pending { 
            border-left-color: var(--warning-500); 
            background: var(--warning-50);
        }
        .day-activity.scheduled { 
            border-left-color: var(--primary-500); 
            background: var(--primary-50);
        }
        .day-activity.in-progress { 
            border-left-color: var(--success-500); 
            background: var(--success-50);
        }
        .day-activity.completed { 
            border-left-color: var(--neutral-500); 
            background: var(--neutral-50);
        }
        .day-activity.cancelled { 
            border-left-color: var(--error-500); 
            background: var(--error-50);
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: var(--neutral-600);
            font-weight: normal;
        }
        
        .activity-client {
            font-size: 0.85rem;
            color: var(--neutral-700);
            margin-bottom: 0.25rem;
        }
        
        .activity-status {
            font-size: 0.8rem;
            color: var(--neutral-600);
            margin-bottom: 0.25rem;
        }
        
        .activity-instructions {
            font-size: 0.8rem;
            color: var(--neutral-600);
            font-style: italic;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--neutral-200);
        }
        
        /* Responsive Calendar */
        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 0.5rem 0.25rem;
            }
            
            .calendar-day-number {
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }
            
            .calendar-activity {
                padding: 0.25rem 0.375rem;
                font-size: 0.7rem;
            }
            
            .calendar-header {
                padding: 0.75rem 0.25rem;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .calendar-day {
                min-height: 60px;
                padding: 0.375rem 0.125rem;
            }
            
            .calendar-day-number {
                font-size: 0.75rem;
                margin-bottom: 0.125rem;
            }
            
            .calendar-activity {
                padding: 0.125rem 0.25rem;
                font-size: 0.65rem;
            }
            
            .calendar-header {
                padding: 0.5rem 0.125rem;
                font-size: 0.7rem;
            }
        }
        
        /* Calendar Controls - Optimized */
        .calendar-controls {
            background: white;
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
        }
        
        .calendar-view-buttons {
            display: flex;
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }
        
        .calendar-view-buttons button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--neutral-300);
            background: white;
            color: var(--neutral-700);
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .calendar-view-buttons button:hover {
            background: var(--neutral-50);
            border-color: var(--neutral-400);
        }
        
        .calendar-view-buttons button.active {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }
        
        .calendar-navigation {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .calendar-navigation h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--neutral-800);
            min-width: 120px;
            text-align: center;
        }
        
        .calendar-navigation .nav-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--neutral-300);
            background: white;
            color: var(--neutral-700);
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 32px;
        }
        
        .calendar-navigation .nav-btn:hover {
            background: var(--neutral-50);
            border-color: var(--neutral-400);
        }
        
        .calendar-navigation .nav-btn.primary {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }
        
        .calendar-navigation .nav-btn.primary:hover {
            background: var(--primary-600);
            border-color: var(--primary-600);
        }
        
        .calendar-filter {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            flex: 1;
            max-width: 350px;
        }
        
        .search-box input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            transition: all 0.15s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 2px var(--primary-100);
        }
        
        .search-box .clear-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--neutral-300);
            background: white;
            color: var(--neutral-600);
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .search-box .clear-btn:hover {
            background: var(--neutral-50);
            color: var(--neutral-700);
        }
        
        #calendar-filter-info {
            font-size: 0.8rem;
            color: var(--neutral-600);
            font-weight: 500;
        }
        
        #calendar-container {
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
        }
        
        @media (max-width: 768px) {
            .calendar-controls {
                padding: 0.75rem;
            }
            
            .calendar-view-buttons {
                flex-wrap: wrap;
            }
            
            .calendar-view-buttons button {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }
            
            .calendar-navigation {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .calendar-navigation h3 {
                font-size: 0.9rem;
                min-width: auto;
            }
            
            .calendar-filter {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
            }
        }
        
        .timeline { position: relative; padding-left: 2rem; }
        .timeline-item { position: relative; padding-bottom: 2rem; }
        .timeline-item::before { 
            content: ''; 
            position: absolute; 
            left: -1.5rem; 
            top: 0; 
            width: 1rem; 
            height: 1rem; 
            background: #3498db; 
            border-radius: 50%; 
        }
        .timeline-item::after { 
            content: ''; 
            position: absolute; 
            left: -1rem; 
            top: 1rem; 
            width: 2px; 
            height: calc(100% - 1rem); 
            background: #ddd; 
        }
        .timeline-item:last-child::after { display: none; }
        .timeline-content { background: white; padding: 1rem; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .timeline-date { font-size: 0.85rem; color: #7f8c8d; margin-bottom: 0.5rem; }
        
        .filter-bar { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; }
        .filter-bar select, .filter-bar input { margin-bottom: 0; width: auto; }
        
        .resources-category-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .resources-grid {
            display: grid;
            gap: 0.4rem;
        }
        
        .resource-grid-header {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 0.4rem;
            font-weight: bold;
            font-size: 0.8rem;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid #ddd;
            margin-bottom: 0.4rem;
            color: var(--neutral-700);
        }
        
        .resource-grid-row {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 0.4rem;
            align-items: center;
        }
        
        .resource-grid-row select,
        .resource-grid-row input {
            margin: 0;
            padding: 0.3rem 0.4rem;
            font-size: 0.8rem;
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-sm);
        }
        
        .resource-grid-row select:focus,
        .resource-grid-row input:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 2px var(--primary-100);
        }
        
        .resource-quantity {
            text-align: center;
            min-width: 60px;
            max-width: 80px;
        }
        
        .resource-select {
            min-width: 120px;
        }
        
        @media (max-width: 768px) {
            .activity-form-grid { 
                grid-template-columns: 1fr; 
            }
            .modal-content {
                width: 95%;
                padding: 1rem;
                max-height: 90vh;
            }
            .line-item {
                grid-template-columns: 1fr;
            }
        }
        
        /* Document Generation Styles */
        .document-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 210mm; /* A4 width */
            margin: 0 auto;
        }
        
        .document-template {
            font-family: 'Arial', sans-serif;
            line-height: 1.4;
            color: #333;
        }
        
        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #2c3e50;
        }
        
        .company-logo {
            max-width: 150px;
            max-height: 80px;
        }
        
        .company-info {
            text-align: right;
            font-size: 0.9rem;
        }
        
        .document-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 1.5rem 0;
            text-align: center;
        }
        
        .client-section, .quote-section {
            margin: 1.5rem 0;
        }
        
        .client-section h3, .quote-section h3 {
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .items-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .items-table td {
            padding: 0.75rem;
            border: 1px solid #ddd;
        }
        
        .items-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .totals-section {
            margin-top: 2rem;
            text-align: right;
        }
        
        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .total-line.final {
            font-weight: bold;
            font-size: 1.1rem;
            border-top: 2px solid #2c3e50;
            border-bottom: 2px solid #2c3e50;
            margin-top: 0.5rem;
        }
        
        .document-footer {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
            font-size: 0.85rem;
            color: #666;
        }
        
        .edit-controls {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .edit-controls h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .control-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group label {
            font-weight: bold;
            margin-bottom: 0;
            min-width: 120px;
        }
        
        .control-group input, .control-group select {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        
        .pdf-button {
            background: #e74c3c;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .pdf-button:hover {
            background: #c0392b;
        }
        
        .preview-button {
            background: #3498db;
            color: white;
        }
        
        .preview-button:hover {
            background: #2980b9;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar {
                padding: var(--space-md);
                flex-wrap: wrap;
            }
            .navbar .nav-left {
                flex-wrap: wrap;
            }
            .navbar h1 {
                font-size: 1.25rem;
                margin-right: var(--space-md);
                margin-bottom: var(--space-sm);
            }
            .navbar button {
                padding: var(--space-xs) var(--space-sm);
                font-size: 0.75rem;
                margin: var(--space-xs) var(--space-xs);
            }

            .container {
                padding: 0 var(--space-sm);
                margin: var(--space-md) auto;
            }
            .stats {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            .stat-card {
                padding: var(--space-lg);
            }
            .stat-card .value {
                font-size: 1.8rem;
            }
            .card {
                padding: var(--space-lg);
                margin-bottom: var(--space-lg);
            }
            .modal-content {
                width: 95%;
                padding: var(--space-lg);
                max-height: 95vh;
            }
            .quote-builder {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
            }
            .line-item {
                grid-template-columns: 1fr;
                gap: var(--space-xs);
            }
            table {
                font-size: 0.75rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                border-radius: var(--radius-md);
            }
            table thead,
            table tbody,
            table th,
            table td,
            table tr {
                display: block;
            }
            table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            table tr {
                border: 1px solid var(--neutral-200);
                margin-bottom: var(--space-sm);
                border-radius: var(--radius-md);
                padding: var(--space-sm);
                background: rgba(255, 255, 255, 0.8);
            }
            table td {
                border: none;
                position: relative;
                padding: var(--space-xs) var(--space-sm) var(--space-xs) 30%;
                white-space: normal;
                text-align: left;
            }
            table td:before {
                content: attr(data-label) ": ";
                position: absolute;
                left: var(--space-sm);
                width: 25%;
                padding-right: var(--space-sm);
                white-space: nowrap;
                font-weight: 600;
                color: var(--neutral-600);
            }
            th, td {
                padding: var(--space-sm);
            }
        }

        @media print {
            .edit-controls {
                display: none;
            }
            
            .document-preview {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
            }
        }
        
        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 2s infinite;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Focus visible for accessibility */
        button:focus-visible, 
        input:focus-visible, 
        select:focus-visible, 
        textarea:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }
        

        
        /* Resources & Activities Styles */
        .activity-day-item {
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease-in-out;
            box-shadow: var(--shadow-sm);
        }
        .activity-day-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .activity-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            font-weight: 700;
            color: var(--neutral-900);
            font-size: 1.1rem;
        }
        
        .activity-day-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }
        
        .activity-tasks, .activity-resources {
            background: rgba(255, 255, 255, 0.8);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            border: 1px solid var(--neutral-200);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease-in-out;
        }
        .activity-tasks:hover, .activity-resources:hover {
            box-shadow: var(--shadow-md);
        }
        
        .activity-tasks h5, .activity-resources h5 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-size: 0.9rem;
        }
        
        .task-item, .resource-item-ra {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .task-item:last-child, .resource-item-ra:last-child {
            border-bottom: none;
        }
        
        .task-input, .resource-input {
            flex: 1;
            margin-right: 0.5rem;
            padding: 0.25rem;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 0.85rem;
        }
        
        .remove-task-btn, .remove-resource-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.2rem 0.4rem;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.7rem;
        }
        
        .add-task-btn, .add-resource-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        /* Resources & Activities in PDF */
        .ra-schedule-section {
            margin: 2rem 0;
            page-break-inside: avoid;
        }
        
        .ra-schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .ra-schedule-table th {
            background: #2c3e50;
            color: white;
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .ra-schedule-table td {
            padding: 0.5rem;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        
        .ra-day-header {
            font-weight: bold;
            background: #f8f9fa;
        }
        
        .ra-tasks-list, .ra-resources-list {
            margin: 0;
            padding-left: 1rem;
            font-size: 0.85rem;
        }
        
        .ra-tasks-list li, .ra-resources-list li {
            margin-bottom: 0.25rem;
        }

        /* Authentication System Styles */
        .auth-overlay, .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(44, 62, 80, 0.95) 0%, 
                rgba(52, 73, 94, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .auth-card, .admin-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            max-width: 400px;
            width: 90%;
            animation: slideInUp 0.5s ease;
        }

        .admin-card {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .auth-form .form-group {
            margin-bottom: 1.5rem;
        }

        .auth-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .auth-form input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .auth-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 1rem;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .auth-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
        }

        .auth-footer {
            text-align: center;
            margin-top: 1.5rem;
        }

        .auth-footer small {
            color: var(--text-secondary);
        }

        /* Admin Panel Styles */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .admin-header h3 {
            color: var(--primary-color);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background: var(--hover-bg);
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-value {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .admin-users {
            margin-bottom: 2rem;
        }

        .admin-users h4 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        #admin-user-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        #admin-user-table th {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        #admin-user-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #admin-user-table tr:last-child td {
            border-bottom: none;
        }

        .admin-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .admin-action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .admin-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .admin-action-btn.warning {
            background: #f39c12;
            color: white;
        }

        .admin-action-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .admin-action-btn.secondary {
            background: var(--secondary-color);
            color: white;
        }

        .admin-action-btn.success {
            background: #27ae60;
            color: white;
        }

        /* User Info in Navbar */
        .user-info {
            color: var(--text-color);
            font-size: 0.9rem;
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }

        .status-offline {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }

        .status-alert {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* Action Buttons in Table */
        .table-action-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 0 0.25rem;
            transition: all 0.2s ease;
        }

        .table-action-btn:hover {
            background: var(--hover-bg);
        }

        .table-action-btn.kick {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .table-action-btn.reset {
            color: #f39c12;
            border-color: #f39c12;
        }

        /* Mobile Responsiveness for Auth */
        @media (max-width: 768px) {
            .auth-card, .admin-card {
                padding: 1.5rem;
                margin: 1rem;
            }

            .admin-stats {
                grid-template-columns: 1fr;
            }

            .admin-actions {
                flex-direction: column;
            }

            .admin-action-btn {
                width: 100%;
            }

            #admin-user-table {
                font-size: 0.8rem;
            }

            #admin-user-table th,
            #admin-user-table td {
                padding: 0.5rem;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 15000;
        }

        .modal-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-body {
            margin-bottom: 2rem;
        }

        .modal-body .form-group {
            margin-bottom: 1.5rem;
        }

        .modal-body label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .modal-body input,
        .modal-body select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .modal-body input:focus,
        .modal-body select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-body small {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }

        .user-stats {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-row span:first-child {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-row span:last-child {
            color: var(--text-color);
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .modal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .modal-btn.secondary {
            background: var(--secondary-color);
            color: white;
        }

        .modal-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .admin-user-management {
            margin-bottom: 1rem;
        }

        .admin-user-management h4 {
            color: var(--text-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        /* Enhanced table action buttons */
        .table-action-btn.edit {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Mobile modal responsiveness */
        @media (max-width: 768px) {
            .modal-card {
                padding: 1.5rem;
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-btn {
                width: 100%;
                min-width: auto;
            }

            .modal-header h3 {
                font-size: 1.1rem;
            }
        }

        /* New PC Form Styles */
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .form-section h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .form-section h4 {
            color: var(--secondary-700);
            margin: 1rem 0 1rem 0;
            font-size: 1rem;
            font-weight: 500;
        }

        .subsection {
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border-color);
        }

        .form-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .form-actions button.primary {
            background: var(--primary-color);
            color: white;
            border: none;
        }

        .form-actions button.primary:hover {
            background: var(--primary-600);
            transform: translateY(-1px);
        }

        .form-actions button.secondary {
            background: var(--secondary-200);
            color: var(--secondary-700);
            border: 1px solid var(--secondary-300);
        }

        .form-actions button.secondary:hover {
            background: var(--secondary-300);
        }

        /* Input error styling */
        .input-error {
            border-color: var(--error-500) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        /* Detail section styling */
        .detail-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .detail-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-section h4 {
            color: var(--secondary-700);
            margin: 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .detail-section p {
            margin: 0.5rem 0;
            line-height: 1.4;
        }

        .detail-section strong {
            color: var(--text-color);
            font-weight: 600;
        }

        /* Mobile responsiveness for form */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-section {
                padding: 1rem;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay - DISABLED -->
    <div id="auth-overlay" class="auth-overlay" style="display: none !important;">
        <div class="auth-card">
            <div class="auth-header">
                <h2> Wireframe Access</h2>
                <p>Enter your assigned credentials</p>
            </div>
            
            <div class="auth-form">
                <div class="form-group">
                    <label>User ID:</label>
                    <input type="text" id="auth-user-id" placeholder="WIRE001" maxlength="7" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label>Access Code:</label>
                    <input type="password" id="auth-password" placeholder="Your assigned password" autocomplete="off">
                </div>
                
                <button onclick="attemptLogin()" class="auth-btn">
                    Access Wireframe
                </button>
                
                <div id="auth-error" class="auth-error" style="display: none;"></div>
            </div>
            
            <div class="auth-footer">
                <small>Contact admin if you need access credentials</small>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-overlay" style="display: none;">
        <div class="admin-card">
            <div class="admin-header">
                <h3> Session Monitor</h3>
                <button onclick="closeAdminPanel()" class="close-btn"></button>
            </div>
            
            <div class="admin-stats">
                <div class="stat-item">
                    <span class="stat-label">Active Users:</span>
                    <span id="admin-active-count" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Sessions Today:</span>
                    <span id="admin-session-count" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Security Alerts:</span>
                    <span id="admin-alert-count" class="stat-value">0</span>
                </div>
            </div>
            
            <div class="admin-users">
                <h4>User Status:</h4>
                <table id="admin-user-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-user-body"></tbody>
                </table>
            </div>
            
            <div class="admin-user-management">
                <h4>User Management:</h4>
                <div class="admin-actions">
                    <button onclick="showAddUserModal()" class="admin-action-btn success"> Add New User</button>
                    <button onclick="generateNewPasswords()" class="admin-action-btn warning"> Regenerate All Passwords</button>
                    <button onclick="kickAllUsers()" class="admin-action-btn danger"> Kick All Users</button>
                                    <button onclick="exportLogs()" class="admin-action-btn secondary"> Export Logs</button>
                <button onclick="exportUsersJSON()" class="admin-action-btn secondary"> Export Users JSON</button>
                <button onclick="clearSecurityLogs()" class="admin-action-btn secondary"> Clear Logs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div class="modal-header">
                <h3> Add New User</h3>
                <button onclick="closeAddUserModal()" class="close-btn"></button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>User ID:</label>
                    <input type="text" id="new-user-id" placeholder="WIRE004" maxlength="10" style="text-transform: uppercase;">
                    <small>Must be unique (e.g., WIRE004, TEST001)</small>
                </div>
                
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="new-user-name" placeholder="Jane Doe">
                </div>
                
                <div class="form-group">
                    <label>Password:</label>
                    <input type="text" id="new-user-password" placeholder="SecurePass123!">
                    <small>Minimum 8 characters</small>
                </div>
                
                <div class="form-group">
                    <label>Role:</label>
                    <select id="new-user-role">
                        <option value="tester">Tester</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions">
                <button onclick="addNewUser()" class="modal-btn primary">Create User</button>
                <button onclick="closeAddUserModal()" class="modal-btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div class="modal-header">
                <h3> Edit User</h3>
                <button onclick="closeEditUserModal()" class="close-btn"></button>
            </div>
            
            <div class="modal-body">
                <input type="hidden" id="edit-user-original-id">
                
                <div class="form-group">
                    <label>User ID:</label>
                    <input type="text" id="edit-user-id" maxlength="10" style="text-transform: uppercase;">
                </div>
                
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="edit-user-name">
                </div>
                
                <div class="form-group">
                    <label>New Password:</label>
                    <input type="text" id="edit-user-password" placeholder="Leave empty to keep current">
                </div>
                
                <div class="form-group">
                    <label>Role:</label>
                    <select id="edit-user-role">
                        <option value="tester">Tester</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                
                <div class="user-stats">
                    <div class="stat-row">
                        <span>Login Count:</span>
                        <span id="edit-user-login-count">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Last Activity:</span>
                        <span id="edit-user-last-activity">Never</span>
                    </div>
                    <div class="stat-row">
                        <span>Status:</span>
                        <span id="edit-user-status">Offline</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button onclick="saveUserChanges()" class="modal-btn primary">Save Changes</button>
                <button onclick="deleteUser()" class="modal-btn danger">Delete User</button>
                <button onclick="closeEditUserModal()" class="modal-btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <nav class="navbar" id="main-navbar">
        <div class="nav-left">
            <h1 onclick="handleLogoClick()"> MF CRM</h1>
            <button onclick="window.showPage('dashboard')" class="nav-btn active">Dashboard</button>
            <button onclick="window.showPage('pcnumbers')" class="nav-btn">PC Numbers</button>
            <button onclick="window.showPage('quotes')" class="nav-btn">Quotes</button>
            <button onclick="window.showPage('activities')" class="nav-btn">Activities</button>
            <button onclick="window.showPage('calendar')" class="nav-btn">Calendar</button>
            <button onclick="window.showPage('resources')" class="nav-btn">Resources</button>
            <button onclick="window.showPage('resource-details')" class="nav-btn">Resources - Details</button>
            <button onclick="window.showPage('pricelists')" class="nav-btn">Price Lists</button>
        </div>
        <div class="nav-right">
            <span id="current-user-info" class="user-info" style="display: none;"></span>
        </div>
    </nav>

    <div id="dashboard" class="page active">
        <div class="container">
            <h1>Dashboard</h1>
            
            <div class="stats">
                <div class="stat-card clickable" onclick="window.showPage('pcnumbers')">
                    <h3>PC NUMBERS</h3>
                    <div class="value" id="stat-pc">0</div>
                </div>
                <div class="stat-card clickable" onclick="window.showPage('quotes')">
                    <h3>QUOTES</h3>
                    <div class="value" id="stat-quotes">0</div>
                </div>
                <div class="stat-card clickable" onclick="window.showPage('activities')">
                    <h3>ACTIVITIES</h3>
                    <div class="value" id="stat-activities">0</div>
                </div>
                <div class="stat-card">
                    <h3>TOTAL VALUE</h3>
                    <div class="value" id="stat-value">0</div>
                </div>
                <div class="stat-card" onclick="window.showStorageReport()" style="cursor: pointer;">
                    <h3>DATABASE SIZE</h3>
                    <div class="value" id="stat-db-size">0 KB</div>
                    <div style="font-size: 0.7rem; margin-top: 0.5rem; color: #7f8c8d;">
                        <div id="storage-usage-bar" style="width: 100%; height: 4px; background: #ecf0f1; border-radius: 2px; margin-bottom: 0.25rem;">
                            <div id="storage-usage-fill" style="height: 100%; background: #3498db; border-radius: 2px; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <span id="storage-usage-text">0% used</span>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.2rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="event.stopPropagation(); window.testLocalStorage();" style="font-size: 0.6rem; padding: 0.2rem 0.3rem; background: #3498db; color: white; border: none; border-radius: 2px; cursor: pointer;">Test</button>
                            <button onclick="event.stopPropagation(); window.exportDatabase();" style="font-size: 0.6rem; padding: 0.2rem 0.3rem; background: #ddd; color: #333; border: 1px solid #ccc; border-radius: 2px; cursor: pointer;">Export</button>
                            <button onclick="event.stopPropagation(); window.showImportModal();" style="font-size: 0.6rem; padding: 0.2rem 0.3rem; background: #ddd; color: #333; border: 1px solid #ccc; border-radius: 2px; cursor: pointer;">Import</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Quick Actions</h2>
                <button onclick="window.showPage('new-pc')">+ New PC Number</button>
                <button onclick="window.showNewQuoteModal()">+ New Quote</button>
                <button onclick="window.showActivityModal()">+ New Activity</button>
            </div>



            <div class="card">
                <h2>Recent PC Numbers</h2>
                <table>
                    <thead>
                        <tr>
                            <th>PC Number</th>
                            <th>Company</th>
                            <th>Reference</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="recent-pc"></tbody>
                </table>
            </div>

            <div class="card">
                <h2>Upcoming Activities</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Activity</th>
                            <th>Company</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="upcoming-activities"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="pcnumbers" class="page">
        <div class="container">
            <h1>PC Numbers</h1>
            <button onclick="window.showPage('new-pc')">+ New PC Number</button>
            
            <!-- Search Filters -->
            <div class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="margin-bottom: 0.5rem; display: block;"> Search Company</label>
                        <input type="text" id="pc-company-filter" placeholder="Enter company name..." oninput="window.filterPCNumbers()" style="width: 100%;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="margin-bottom: 0.5rem; display: block;"> Search Contact</label>
                        <input type="text" id="pc-contact-filter" placeholder="Enter contact name..." oninput="window.filterPCNumbers()" style="width: 100%;">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button onclick="window.clearPCFilters()" class="secondary" style="padding: 0.5rem 1rem; white-space: nowrap;">Clear Filters</button>
                        <div id="pc-results-count" style="font-size: 0.9em; color: #666; text-align: center;"></div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>PC Number</th>
                            <th>Company</th>
                            <th>Reference</th>
                            <th>Contact</th>
                            <th>Quotes</th>
                            <th>Activities</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pc-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="new-pc" class="page">
        <div class="container">
            <h1 id="pc-form-title">New PC Number</h1>
            
            <div class="card">
                <input type="hidden" id="pc-id">
                
                <!-- PC Number -->
                <div class="form-section">
                    <h3> PC Number</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>PC Number *</label>
                            <input type="text" id="pc-number" placeholder="Auto-generated" readonly style="background-color: #f1f1f1;">
                        </div>
                    </div>
                </div>

                <!-- Company Section -->
                <div class="form-section">
                    <h3> Company</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company Name *</label>
                            <input type="text" id="pc-company" placeholder="Enter company name" required>
                        </div>
                        <div class="form-group">
                            <label>Crown Branch</label>
                            <input type="text" id="pc-crown-branch" placeholder="e.g. London Branch">
                        </div>
                        <div class="form-group">
                            <label>Client Category</label>
                            <select id="pc-client-category">
                                <option value="">Select category...</option>
                                <option value="Corporate">Corporate</option>
                                <option value="Government">Government</option>
                                <option value="NHS">NHS</option>
                                <option value="Education">Education</option>
                                <option value="Retail">Retail</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Client Source</label>
                            <select id="pc-client-source">
                                <option value="">Select source...</option>
                                <option value="Website">Website</option>
                                <option value="Referral">Referral</option>
                                <option value="Cold Call">Cold Call</option>
                                <option value="Trade Show">Trade Show</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Referral Type</label>
                            <select id="pc-referral-type">
                                <option value="">Select referral type...</option>
                                <option value="Client Referral">Client Referral</option>
                                <option value="Partner Referral">Partner Referral</option>
                                <option value="Employee Referral">Employee Referral</option>
                                <option value="Industry Contact">Industry Contact</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Project Section -->
                <div class="form-section">
                    <h3> Project</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project Name *</label>
                            <input type="text" id="pc-project-name" placeholder="Enter project name" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="pc-description" rows="3" placeholder="Project description"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Account Manager *</label>
                            <input type="text" id="pc-account-manager" placeholder="Account manager name" required>
                        </div>
                        <div class="form-group">
                            <label>Surveyor</label>
                            <input type="text" id="pc-surveyor" placeholder="Surveyor name">
                        </div>
                        <div class="form-group">
                            <label>Property Type</label>
                            <select id="pc-property-type">
                                <option value="">Select property type...</option>
                                <option value="Office">Office</option>
                                <option value="Warehouse">Warehouse</option>
                                <option value="Retail">Retail</option>
                                <option value="Industrial">Industrial</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Education">Education</option>
                                <option value="Residential">Residential</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>SIC Code 1</label>
                            <input type="text" id="pc-sic-code-1" placeholder="e.g. 62012">
                        </div>
                        <div class="form-group">
                            <label>SIC Code 2</label>
                            <input type="text" id="pc-sic-code-2" placeholder="e.g. 62012">
                        </div>
                        <div class="form-group">
                            <label>SIC Code 3</label>
                            <input type="text" id="pc-sic-code-3" placeholder="e.g. 62012">
                        </div>
                    </div>
                </div>

                <!-- Collection Section -->
                <div class="form-section">
                    <h3> Collection</h3>
                    
                    <!-- Collection Contact -->
                    <div class="subsection">
                        <h4>Collection Contact</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" id="pc-collection-first-name" placeholder="First name">
                            </div>
                            <div class="form-group">
                                <label>Surname</label>
                                <input type="text" id="pc-collection-surname" placeholder="Surname">
                            </div>
                            <div class="form-group">
                                <label>Title</label>
                                <select id="pc-collection-title">
                                    <option value="">Select title...</option>
                                    <option value="Mr">Mr</option>
                                    <option value="Mrs">Mrs</option>
                                    <option value="Ms">Ms</option>
                                    <option value="Miss">Miss</option>
                                    <option value="Dr">Dr</option>
                                    <option value="Prof">Prof</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Position</label>
                                <input type="text" id="pc-collection-position" placeholder="e.g. Manager, Director">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="pc-collection-email" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="pc-collection-phone" placeholder="+44 20 1234 5678">
                            </div>
                            <div class="form-group">
                                <label>Mobile</label>
                                <input type="tel" id="pc-collection-mobile" placeholder="+44 7700 900123">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" id="pc-collection-country" placeholder="e.g. United Kingdom">
                            </div>
                        </div>
                    </div>

                    <!-- Collection Address -->
                    <div class="subsection">
                        <h4>Collection Address</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Postcode</label>
                                <input type="text" id="pc-collection-postcode" placeholder="e.g. SW1A 1AA">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" id="pc-collection-country" placeholder="e.g. United Kingdom">
                            </div>
                            <div class="form-group">
                                <label>Address Line 1</label>
                                <input type="text" id="pc-collection-address-1" placeholder="Street address">
                            </div>
                            <div class="form-group">
                                <label>Address Line 2</label>
                                <input type="text" id="pc-collection-address-2" placeholder="Apartment, suite, etc.">
                            </div>
                            <div class="form-group">
                                <label>Address Line 3</label>
                                <input type="text" id="pc-collection-address-3" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Address Line 4</label>
                                <input type="text" id="pc-collection-address-4" placeholder="County">
                            </div>
                            <div class="form-group">
                                <label>Collection Date</label>
                                <input type="date" id="pc-collection-date">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delivery Section -->
                <div class="form-section">
                    <h3> Delivery</h3>
                    
                    <!-- Delivery Contact -->
                    <div class="subsection">
                        <h4>Delivery Contact</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" id="pc-delivery-first-name" placeholder="First name">
                            </div>
                            <div class="form-group">
                                <label>Surname</label>
                                <input type="text" id="pc-delivery-surname" placeholder="Surname">
                            </div>
                            <div class="form-group">
                                <label>Title</label>
                                <select id="pc-delivery-title">
                                    <option value="">Select title...</option>
                                    <option value="Mr">Mr</option>
                                    <option value="Mrs">Mrs</option>
                                    <option value="Ms">Ms</option>
                                    <option value="Miss">Miss</option>
                                    <option value="Dr">Dr</option>
                                    <option value="Prof">Prof</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Position</label>
                                <input type="text" id="pc-delivery-position" placeholder="e.g. Manager, Director">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="pc-delivery-email" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="pc-delivery-phone" placeholder="+44 20 1234 5678">
                            </div>
                            <div class="form-group">
                                <label>Mobile</label>
                                <input type="tel" id="pc-delivery-mobile" placeholder="+44 7700 900123">
                            </div>

                        </div>
                    </div>

                    <!-- Delivery Address -->
                    <div class="subsection">
                        <h4>Delivery Address</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Postcode</label>
                                <input type="text" id="pc-delivery-postcode" placeholder="e.g. SW1A 1AA">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" id="pc-delivery-country" placeholder="e.g. United Kingdom">
                            </div>
                            <div class="form-group">
                                <label>Address Line 1</label>
                                <input type="text" id="pc-delivery-address-1" placeholder="Street address">
                            </div>
                            <div class="form-group">
                                <label>Address Line 2</label>
                                <input type="text" id="pc-delivery-address-2" placeholder="Apartment, suite, etc.">
                            </div>
                            <div class="form-group">
                                <label>Address Line 3</label>
                                <input type="text" id="pc-delivery-address-3" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Address Line 4</label>
                                <input type="text" id="pc-delivery-address-4" placeholder="County">
                            </div>
                            <div class="form-group">
                                <label>Delivery Date</label>
                                <input type="date" id="pc-delivery-date">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button onclick="window.savePC()" class="primary">Save PC Number</button>
                    <button onclick="window.showPage('pcnumbers')" class="secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pc-detail" class="page">
        <div class="container">
            <h1 id="pc-detail-title">PC Details</h1>
            <div class="card">
                <h2>PC Details</h2>
                
                <!-- Company Section -->
                <div class="detail-section">
                    <h3> Company</h3>
                    <p><strong>PC Number:</strong> <span id="pc-detail-number"></span></p>
                    <p><strong>Company:</strong> <span id="pc-detail-company"></span></p>
                    <p><strong>Crown Branch:</strong> <span id="pc-detail-crown-branch"></span></p>
                    <p><strong>Client Category:</strong> <span id="pc-detail-client-category"></span></p>
                    <p><strong>Client Source:</strong> <span id="pc-detail-client-source"></span></p>
                    <p><strong>Referral Type:</strong> <span id="pc-detail-referral-type"></span></p>
                </div>

                <!-- Project Section -->
                <div class="detail-section">
                    <h3> Project</h3>
                    <p><strong>Project Name:</strong> <span id="pc-detail-project-name"></span></p>
                    <p><strong>Description:</strong> <span id="pc-detail-description"></span></p>
                    <p><strong>Account Manager:</strong> <span id="pc-detail-account-manager"></span></p>
                    <p><strong>Surveyor:</strong> <span id="pc-detail-surveyor"></span></p>
                    <p><strong>Property Type:</strong> <span id="pc-detail-property-type"></span></p>
                    <p><strong>SIC Codes:</strong> <span id="pc-detail-sic-codes"></span></p>
                </div>

                <!-- Collection Section -->
                <div class="detail-section">
                    <h3> Collection</h3>
                    <h4>Collection Contact</h4>
                    <p><strong>Contact:</strong> <span id="pc-detail-collection-contact"></span></p>
                    <p><strong>Email:</strong> <span id="pc-detail-collection-email"></span></p>
                    <p><strong>Phone:</strong> <span id="pc-detail-collection-phone"></span></p>
                    <p><strong>Mobile:</strong> <span id="pc-detail-collection-mobile"></span></p>
                    <p><strong>Address:</strong> <span id="pc-detail-collection-address"></span></p>
                    <p><strong>Collection Date:</strong> <span id="pc-detail-collection-date"></span></p>
                </div>

                <!-- Delivery Section -->
                <div class="detail-section">
                    <h3> Delivery</h3>
                    <h4>Delivery Contact</h4>
                    <p><strong>Contact:</strong> <span id="pc-detail-delivery-contact"></span></p>
                    <p><strong>Email:</strong> <span id="pc-detail-delivery-email"></span></p>
                    <p><strong>Phone:</strong> <span id="pc-detail-delivery-phone"></span></p>
                    <p><strong>Mobile:</strong> <span id="pc-detail-delivery-mobile"></span></p>
                    <p><strong>Address:</strong> <span id="pc-detail-delivery-address"></span></p>
                    <p><strong>Delivery Date:</strong> <span id="pc-detail-delivery-date"></span></p>
                </div>

                <div style="margin-top: 1rem;">
                    <button onclick="window.editPC(db.currentPC.id)" class="warning">Edit PC Number</button>
                    <button onclick="window.copyPC(db.currentPC.id)" class="secondary">Copy PC Number</button>
                    <button onclick="window.createQuote()">Create Quote</button>
                    <button onclick="window.showActivityModal()">Create Activity</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Quotes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Quote ID</th>
                            <th>Name</th>
                            <th>Version</th>
                            <th>Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pc-quotes"></tbody>
                </table>
            </div>
 
                         <div class="card">
                 <h2>Activities Timeline</h2>
                 <div class="timeline" id="pc-activities-timeline"></div>
             </div>
             

         </div>
     </div>

    <div id="quotes" class="page">
        <div class="container">
            <h1>All Quotes</h1>
            <button onclick="window.showNewQuoteModal()">+ New Quote</button>
            
            <!-- Search Filter -->
            <div class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label style="margin-bottom: 0.5rem; display: block;"> Search by Company</label>
                        <input type="text" id="quotes-company-filter" placeholder="Enter company name..." oninput="window.filterQuotes()" style="width: 100%;">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button onclick="window.clearQuotesFilter()" class="secondary" style="padding: 0.5rem 1rem; white-space: nowrap;">Clear Filter</button>
                        <div id="quotes-results-count" style="font-size: 0.9em; color: #666; text-align: center;"></div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Quote ID</th>
                            <th>Name</th>
                            <th>PC Number</th>
                            <th>Company</th>
                            <th>Value</th>
                            <th>Status</th>
                            <th>Activities</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quotes-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="quote-detail" class="page">
        <div class="container">
            <h1 id="quote-detail-title">Quote Detail</h1>
            
            <div class="card">
                <button onclick="window.editQuote()" class="warning">Edit Quote</button>
                <button onclick="window.duplicateQuote()" class="secondary">Duplicate Quote</button>
                <button onclick="window.createActivityFromCurrentQuote()" class="success">Create Activity</button>
                <button onclick="window.generateQuotePDF()" class="pdf-button"> Generate PDF</button>
                <button onclick="window.showPage('quotes')" class="secondary">Back to Quotes</button>
            </div>

            <div class="card">
                <h2>Quote Information</h2>
                <div id="quote-detail-info"></div>
                <div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
                    <label style="margin-bottom: 0;">Change Status:</label>
                    <select id="quote-status-select" style="width: auto;">
                        <option value="Draft">Draft</option>
                        <option value="Sent">Sent</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <button onclick="window.changeQuoteStatus()" class="success" style="padding: 0.5rem 1rem;">Change Status</button>
                </div>
            </div>

            <div class="card">
                <h2>Quote Items</h2>
                <div id="quote-items-detail"></div>
            </div>

            <div class="card">
                <h2>Summary</h2>
                <div id="quote-summary-detail"></div>
            </div>
        </div>
    </div>

    <div id="quote-builder" class="page">
        <div class="container">
            <h1>New Quote</h1>
            
            <div class="card" id="price-list-selector" style="margin-bottom: 2rem;">
                <h2>Select Price List</h2>
                <label>Price List *</label>
                <select id="quote-price-list" onchange="window.onPriceListChange()">
                    <option value="">Select price list...</option>
                </select>
            </div>
            
            <div class="card" id="quote-details" style="margin-bottom: 2rem;">
                <h2>Quote Details</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label>Quote Name/Reference (Optional, Internal Use Only)</label>
                        <input type="text" id="quote-name" placeholder="e.g. Initial Quote, Revised Quote, Final Quote">
                    </div>
                    <div>
                        <label>Quote Description (Optional)</label>
                        <input type="text" id="quote-description" placeholder="e.g. Moving services for office relocation">
                    </div>
                </div>
            </div>
            
            <div class="quote-builder" id="quote-items-section" style="display: none;">
                <!-- Left Column: Form Sections -->
                <div class="quote-left-column">
                    <div class="category-section">
                        <h3>Human Resources</h3>
                        <div id="quote-human"></div>
                        <button onclick="window.addLineItem('human')">+ Add Resource</button>
                    </div>

                    <div class="category-section">
                        <h3>Vehicles</h3>
                        <div id="quote-vehicles"></div>
                        <button onclick="window.addLineItem('vehicles')">+ Add Vehicle</button>
                    </div>

                    <div class="category-section">
                        <h3>Materials</h3>
                        <div id="quote-materials"></div>
                        <button onclick="window.addLineItem('materials')">+ Add Material</button>
                    </div>

                    <div class="category-section">
                        <h3>Other Services</h3>
                        <div id="quote-other"></div>
                        <button onclick="window.addLineItem('other')">+ Add Service</button>
                    </div>
                    
                    <div class="category-section" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                        <h3>Other Costs</h3>
                        <p style="font-size: 0.85rem; color: #856404; margin-bottom: 0.5rem;"> Use only for exceptional items not in Resource Database</p>
                        <div id="quote-other-costs"></div>
                        <button onclick="window.addOtherCost()" class="warning">+ Add Other Cost</button>
                    </div>
                    
                    <div class="category-section" style="background: #f0f8ff; border: 1px solid #87ceeb;">
                        <h3> Recycling Charges</h3>
                        <p style="font-size: 0.85rem; color: #4682b4; margin-bottom: 1rem;">Environmental waste processing charges based on weight and material type</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <!-- General Recycling -->
                            <div style="background: #fff; padding: 1rem; border-radius: 6px; border: 1px solid #ddd;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">General Recycling</h4>
                                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Standard recyclable materials - 250/tonne</p>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="number" id="general-recycling-kg" placeholder="Weight (kg)" min="0" step="10" style="width: 120px; margin-bottom: 0;" onchange="window.calculateRecyclingCharges()">
                                    <span style="font-size: 0.9rem; color: #666;">kg</span>
                                    <span style="margin-left: auto; font-weight: bold;" id="general-recycling-cost">0.00</span>
                                </div>
                            </div>
                            
                            <!-- POPS Recycling -->
                            <div style="background: #fff; padding: 1rem; border-radius: 6px; border: 1px solid #ddd;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">POPS Recycling</h4>
                                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Persistent Organic Pollutants - 395/tonne</p>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="number" id="pops-recycling-kg" placeholder="Weight (kg)" min="0" step="10" style="width: 120px; margin-bottom: 0;" onchange="window.calculateRecyclingCharges()">
                                    <span style="font-size: 0.9rem; color: #666;">kg</span>
                                    <span style="margin-left: auto; font-weight: bold;" id="pops-recycling-cost">0.00</span>
                                </div>
                            </div>
                            
                            <!-- WEEE Recycling -->
                            <div style="background: #fff; padding: 1rem; border-radius: 6px; border: 1px solid #ddd;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">WEEE Recycling</h4>
                                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Waste Electrical & Electronic Equipment</p>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <select id="weee-recycling-option" style="width: 120px; margin-bottom: 0;" onchange="window.calculateRecyclingCharges()">
                                        <option value="na">N/A</option>
                                        <option value="included">Included</option>
                                        <option value="quote">Quote on Request</option>
                                    </select>
                                    <span style="margin-left: auto; font-weight: bold;" id="weee-recycling-cost">N/A</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rebates Section -->
                    <div class="category-section" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-left: 4px solid #22c55e;">
                        <h3> Rebates</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Credits for items suitable for resale or recycling</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1rem;">
                            
                            <!-- Furniture Resale -->
                            <div style="background: rgba(255, 255, 255, 0.6); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Furniture Resale</h4>
                                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Items suitable for resale market</p>
                                <div style="display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;">
                                    <input type="number" id="furniture-rebate-kg" placeholder="Weight (kg)" min="0" step="10" style="width: 100px; margin-bottom: 0; flex-shrink: 0;" onchange="window.calculateRebates()">
                                    <span style="color: #666; font-size: 0.9rem; flex-shrink: 0;"> </span>
                                    <input type="number" id="furniture-rebate-rate" placeholder="Rate/tonne" min="0" step="50" value="200" style="width: 80px; margin-bottom: 0; flex-shrink: 0;" onchange="window.calculateRebates()">
                                    <span style="color: #666; font-size: 0.9rem; flex-shrink: 0;">/tonne =</span>
                                    <span style="font-weight: bold; color: #22c55e; min-width: 60px; text-align: right;" id="furniture-rebate-cost">0.00</span>
                                </div>
                            </div>

                            <!-- IT Resale -->
                            <div style="background: rgba(255, 255, 255, 0.6); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">IT Resale</h4>
                                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">IT equipment suitable for resale</p>
                                <div style="display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;">
                                    <input type="number" id="it-rebate-kg" placeholder="Weight (kg)" min="0" step="10" style="width: 100px; margin-bottom: 0; flex-shrink: 0;" onchange="window.calculateRebates()">
                                    <span style="color: #666; font-size: 0.9rem; flex-shrink: 0;"> </span>
                                    <input type="number" id="it-rebate-rate" placeholder="Rate/tonne" min="0" step="50" value="300" style="width: 80px; margin-bottom: 0; flex-shrink: 0;" onchange="window.calculateRebates()">
                                    <span style="color: #666; font-size: 0.9rem; flex-shrink: 0;">/tonne =</span>
                                    <span style="font-weight: bold; color: #22c55e; min-width: 60px; text-align: right;" id="it-rebate-cost">0.00</span>
                                </div>
                            </div>

                            <!-- Metal Recycling -->
                            <div style="background: rgba(255, 255, 255, 0.6); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Metal Recycling</h4>
                                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Metal items for recycling</p>
                                <div style="display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;">
                                    <input type="number" id="metal-rebate-kg" placeholder="Weight (kg)" min="0" step="10" style="width: 100px; margin-bottom: 0; flex-shrink: 0;" onchange="window.calculateRebates()">
                                    <span style="color: #666; font-size: 0.9rem; flex-shrink: 0;"> </span>
                                    <input type="number" id="metal-rebate-rate" placeholder="Rate/tonne" min="0" step="50" value="150" style="width: 80px; margin-bottom: 0; flex-shrink: 0;" onchange="window.calculateRebates()">
                                    <span style="color: #666; font-size: 0.9rem; flex-shrink: 0;">/tonne =</span>
                                    <span style="font-weight: bold; color: #22c55e; min-width: 60px; text-align: right;" id="metal-rebate-cost">0.00</span>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <!-- Right Column: Quote Summary -->
                <div class="summary">
                    <h3>Quote Summary</h3>
                    <div class="summary-line">
                        <span>Human Resources:</span>
                        <span id="sum-human">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Vehicles:</span>
                        <span id="sum-vehicles">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Materials:</span>
                        <span id="sum-materials">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Other:</span>
                        <span id="sum-other">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Other Costs:</span>
                        <span id="sum-other-costs">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Recycling Charges:</span>
                        <span id="sum-recycling-charges">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Rebates:</span>
                        <span id="sum-rebates" style="color: #22c55e;">-0.00</span>
                    </div>                    <div class="summary-line">
                        <span>Subtotal:</span>
                        <span id="sum-subtotal">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Discount (%):</span>
                        <input type="number" id="quote-discount" value="0" min="0" max="100" style="width: 80px;" onchange="window.calculateTotal()">
                    </div>
                    <div class="summary-line">
                        <span>Net Total:</span>
                        <span id="sum-net-total">0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>VAT (%):</span>
                        <input type="number" id="quote-vat" value="20" min="0" max="30" style="width: 80px;" onchange="window.calculateTotal()">
                    </div>
                    <div class="summary-line">
                        <span>VAT Amount:</span>
                        <span id="sum-vat-amount">0.00</span>
                    </div>
                    <div class="summary-total">
                        <span>Total (inc. VAT):</span>
                        <span id="sum-total">0.00</span>
                    </div>
                    
                    <!-- New Fields Section -->
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <h4 style="margin-bottom: 1rem; color: #2c3e50;">Additional Information</h4>
                        <div class="summary-line">
                            <span>Standard Liability:</span>
                            <input type="number" id="quote-standard-liability" value="100000" min="0" step="1000" style="width: 120px;" onchange="window.updateStandardLiability()">
                        </div>
                        <div class="summary-line">
                            <span>Declared Value:</span>
                            <input type="number" id="quote-declared-value" value="0" min="0" step="1000" style="width: 120px;" placeholder="Enter declared value">
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; position: sticky; bottom: 0; background: #f8f9fa; padding: 1rem 0; border-top: 1px solid #ddd; margin-left: -1.5rem; margin-right: -1.5rem; padding-left: 1.5rem; padding-right: 1.5rem;">
                        <button onclick="window.saveQuote()" style="width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 0.5rem;"> Save Quote</button>
                        <button onclick="window.cancelQuote()" class="secondary" style="width: 100%; padding: 0.75rem; font-size: 1rem; margin-top: 0.5rem;"> Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="activities" class="page">
        <div class="container">
            <h1>Activities</h1>
            <button onclick="window.showActivityModalFromList()">+ New Activity</button>
            
            <!-- Company Search Filter -->
            <div class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label style="margin-bottom: 0.5rem; display: block;"> Search by Company</label>
                        <input type="text" id="activities-company-filter" placeholder="Enter company name..." oninput="window.filterActivitiesByCompany()" style="width: 100%;">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button onclick="window.clearActivitiesCompanyFilter()" class="secondary" style="padding: 0.5rem 1rem; white-space: nowrap;">Clear Filter</button>
                        <div id="activities-results-count" style="font-size: 0.9em; color: #666; text-align: center;"></div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="filter-bar">
                    <label style="margin-bottom: 0;">Status:</label>
                    <select id="activity-filter-status" onchange="window.filterActivities()">
                        <option value="">All Statuses</option>
                        <option value="draft">Draft</option>
                        <option value="ready">Ready</option>
                        <option value="sent">Sent</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    
                    <label style="margin-bottom: 0;">Date Range:</label>
                    <input type="date" id="activity-filter-from" onchange="window.filterActivities()">
                    <span>to</span>
                    <input type="date" id="activity-filter-to" onchange="window.filterActivities()">
                    
                    <button onclick="window.clearActivityFilters()" class="secondary">Clear Filters</button>
                </div>
            </div>
            
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Activity ID</th>
                            <th>PC Number</th>
                            <th>Company</th>
                            <th>Name</th>
                            <th>Date/Time</th>
                            <th>Local Status</th>
                            <th>Sync Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activities-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="activity-detail" class="page">
        <div class="container">
            <h1 id="activity-detail-title">Activity Detail</h1>
            
            <div class="card">
                <button onclick="window.editActivity()" class="warning">Edit Activity</button>
                <button onclick="window.showPage('activities')" class="secondary">Back to Activities</button>
            </div>

            <div class="card">
                <h2>Activity Information</h2>
                <div id="activity-detail-info"></div>
            </div>

            <div class="card">
                <h2>Related Information</h2>
                <div id="activity-related-info"></div>
            </div>

            <div class="card">
                <h2>Notes & Updates</h2>
                <div id="activity-notes"></div>
                <button onclick="window.addActivityNote()">+ Add Note</button>
            </div>
        </div>
    </div>

    <div id="document-preview" class="page">
        <div class="container">
            <h1>Document Preview & Editor</h1>
            
            <!-- Edit Controls -->
            <div class="edit-controls">
                <h3> Document Settings</h3>
                
                <div class="control-group">
                    <label>Company Name:</label>
                    <input type="text" id="doc-company-name" value="Relocation Services Ltd" placeholder="Your company name">
                    
                    <label>Company Address:</label>
                    <textarea id="doc-company-address" rows="2" placeholder="Your company address">123 Business Street
London, UK SW1A 1AA</textarea>
                </div>
                
                <div class="control-group">
                    <label>Document Title:</label>
                    <input type="text" id="doc-title" value="QUOTATION" placeholder="Document title">
                    
                    <label>Footer Text:</label>
                    <input type="text" id="doc-footer" value="Thank you for your business!" placeholder="Footer message">
                </div>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="include-resources-activities" onchange="window.toggleResourcesActivities()" style="width: auto; margin-right: 0.5rem;">
                        Include Resources & Activities Schedule
                    </label>
                </div>
                
                <!-- Resources & Activities Section -->
                <div id="resources-activities-section" style="display: none; border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                    <h4> Resources & Activities Schedule</h4>
                    
                    <div class="control-group">
                        <label>Project Start Date:</label>
                        <input type="date" id="project-start-date">
                        
                        <label>Project Duration (days):</label>
                        <input type="number" id="project-duration" value="1" min="1" max="30">
                    </div>
                    
                    <div class="control-group">
                        <button onclick="window.addActivityDay()" class="success">+ Add Day</button>
                        <button onclick="window.clearActivityDays()" class="secondary">Clear All</button>
                    </div>
                    
                    <div id="activity-days-container">
                        <!-- Activity days will be added here -->
                    </div>
                </div>
                
                <div class="control-group">
                    <button onclick="window.updateDocumentPreview()" class="preview-button"> Update Preview</button>
                    <button onclick="window.generatePDFFromPreview()" class="pdf-button"> Generate PDF</button>
                    <button onclick="window.generateSimplePDF()" class="secondary"> Simple PDF</button>
                    <button onclick="window.debugPDFLibraries()" style="background: #9b59b6; color: white;"> Debug Libraries</button>
                    <button onclick="window.showPage('quote-detail')" class="secondary"> Back</button>
                </div>
            </div>
            
            <!-- Document Preview -->
            <div class="document-preview">
                <div class="document-template" id="document-content">
                    <!-- Content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <div id="resources" class="page">
        <div class="container">
            <h1>Resources Database</h1>
            <button onclick="window.showResourceModal()">+ New Resource</button>
            <button onclick="window.showPage('import-prices')" class="secondary"> Import Prices</button>
            
            <div class="card">
                <div class="filter-bar">
                    <label style="margin-bottom: 0;">Category:</label>
                    <select id="resource-filter-category" onchange="window.filterResources()">
                        <option value="">All Categories</option>
                        <option value="human">Human Resources</option>
                        <option value="vehicles">Vehicles</option>
                        <option value="materials">Materials</option>
                        <option value="equipment">Equipment</option>
                    </select>
                    <button onclick="window.clearResourceFilters()" class="secondary">Clear Filters</button>
                </div>
            </div>
            
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Net Cost</th>
                            <th>Unit</th>
                            <th>Pricing Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resources-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="import-prices" class="page">
        <div class="container">
            <h1>Import Prices from Excel</h1>
            
            <div class="card">
                <h2> Excel Import & Export</h2>
                <p>Upload your Excel file with pricing data or download a template to fill in your prices.</p>
                
                <div style="margin: 1rem 0; display: flex; gap: 1rem; align-items: center;">
                    <div style="flex: 1;">
                        <label>Select Excel File:</label>
                        <input type="file" id="excel-file-input" accept=".xlsx,.xls" onchange="window.handleExcelFileSelect(event)">
                    </div>
                    <div style="flex: 1;">
                        <label>Download Template:</label>
                        <button onclick="window.downloadExcelTemplate()" class="secondary"> Download Excel Template</button>
                    </div>
                    <div style="flex: 1;">
                        <label>Export Price List:</label>
                        <select id="export-price-list-select" style="margin-right: 0.5rem;">
                            <option value="">Select Price List...</option>
                        </select>
                        <button onclick="window.exportPriceList()" class="secondary"> Export Price List</button>
                    </div>
                </div>
                
                <div id="excel-preview" style="display: none;">
                    <h3>Data Preview</h3>
                    <div id="excel-preview-content" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; background: #f9f9f9;"></div>
                    
                    <div style="margin: 1rem 0;">
                        <h4>Column Mapping</h4>
                        <div id="column-mapping" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"></div>
                    </div>
                    
                    <div style="margin: 1rem 0;">
                        <h4>Import Options</h4>
                        <label>
                            <input type="radio" name="import-mode" value="replace" checked> Replace existing prices
                        </label>
                        <br>
                        <label>
                            <input type="radio" name="import-mode" value="add-new"> Add new resources only
                        </label>
                        <br>
                        <label>
                            <input type="radio" name="import-mode" value="update"> Update existing resources
                        </label>
                    </div>
                    
                    <button onclick="window.importExcelData()" class="primary">Import Data</button>
                    <button onclick="window.cancelExcelImport()" class="secondary">Cancel</button>
                </div>
            </div>
            
            <div class="card">
                <h2> Expected Format</h2>
                <p>Your Excel file should have the following columns:</p>
                <ul>
                    <li><strong>Category:</strong> Resource category (e.g., "Human Resources", "Vehicle and Driver")</li>
                    <li><strong>Resource Name:</strong> Name of the resource</li>
                    <li><strong>Monday to Friday 0800 to 1700:</strong> Standard rate</li>
                    <li><strong>Monday to Thursday 1700 to 0800:</strong> Overtime rate</li>
                    <li><strong>Friday PM, Saturday & Sunday:</strong> Weekend rate</li>
                </ul>
                
                <div style="margin: 1rem 0; padding: 1rem; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px;">
                    <h4> Quick Start:</h4>
                    <ol>
                        <li><strong>Download Template:</strong> Click " Download Excel Template" to get a pre-filled template</li>
                        <li><strong>Edit Prices:</strong> Open the CSV file in Excel and modify the prices</li>
                        <li><strong>Save as Excel:</strong> Save the file as .xlsx format</li>
                        <li><strong>Import:</strong> Upload your modified file back to the system</li>
                    </ol>
                    
                    <h4> Export Options:</h4>
                    <ul>
                        <li><strong>Export Current Prices:</strong> Exports all resources with their base costs</li>
                        <li><strong>Export Price List:</strong> Exports a specific Price List with client prices and margins</li>
                    </ul>
                </div>
                
                <div style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <h4> Tips:</h4>
                    <ul>
                        <li>Resources with time-based pricing will be marked automatically</li>
                        <li>Vehicle + Driver combinations will be detected and marked as combined</li>
                        <li>Materials and equipment will use standard pricing only</li>
                        <li>Empty cells will be treated as no pricing for that time slot</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="resource-details" class="page">
        <div class="container">
            <h1>Resources - Details</h1>
            <div style="margin-bottom: 1rem;">
                <button onclick="window.showEmployeeModal()">+ Add Employee</button>
                <button onclick="window.showVehicleModal()" class="secondary">+ Add Vehicle</button>
            </div>
            
            <!-- Employees Section -->
            <div class="card">
                <h2> Employees</h2>
                <div class="filter-bar">
                    <label style="margin-bottom: 0;">Role:</label>
                    <select id="employee-role-filter" onchange="window.filterEmployees()">
                        <option value="">All Roles</option>
                        <option value="manager">Manager</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="senior-porter">Senior Porter</option>
                        <option value="porter">Porter</option>
                        <option value="driver">Driver</option>
                        <option value="packer">Packer</option>
                        <option value="admin">Admin</option>
                        <option value="other">Other</option>
                    </select>
                    <label style="margin-bottom: 0;">Status:</label>
                    <select id="employee-status-filter" onchange="window.filterEmployees()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="on-leave">On Leave</option>
                    </select>
                    <button onclick="window.clearEmployeeFilters()" class="secondary">Clear Filters</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employees-list"></tbody>
                </table>
            </div>
            
            <!-- Vehicles Section -->
            <div class="card">
                <h2> Vehicles</h2>
                <div class="filter-bar">
                    <label style="margin-bottom: 0;">Type:</label>
                    <select id="vehicle-type-filter" onchange="window.filterVehicles()">
                        <option value="">All Types</option>
                        <option value="van">Van</option>
                        <option value="truck">Truck</option>
                        <option value="lorry">Lorry</option>
                        <option value="car">Car</option>
                        <option value="trailer">Trailer</option>
                        <option value="other">Other</option>
                    </select>
                    <label style="margin-bottom: 0;">Status:</label>
                    <select id="vehicle-status-filter" onchange="window.filterVehicles()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="out-of-service">Out of Service</option>
                    </select>
                    <button onclick="window.clearVehicleFilters()" class="secondary">Clear Filters</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Registration</th>
                            <th>Type</th>
                            <th>Make/Model</th>
                            <th>Capacity</th>
                            <th>Assigned Driver</th>
                            <th>Status</th>
                            <th>MOT Due</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vehicles-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="calendar" class="page">
        <div class="container">
            <h1>Calendar</h1>
            
            <div class="calendar-controls">
                <div class="calendar-view-buttons">
                    <button onclick="window.changeCalendarView('month')" id="cal-month-btn" class="active">Month</button>
                    <button onclick="window.changeCalendarView('week')" id="cal-week-btn">Week</button>
                    <button onclick="window.changeCalendarView('day')" id="cal-day-btn">Day</button>
                </div>
                
                <div class="calendar-navigation">
                    <button onclick="window.navigateCalendar('prev')" class="nav-btn secondary">
                        <span>&lt;</span>
                    </button>
                    <h3 id="calendar-title">January 2025</h3>
                    <button onclick="window.navigateCalendar('next')" class="nav-btn secondary">
                        <span>&gt;</span>
                    </button>
                    <button onclick="window.navigateCalendar('today')" class="nav-btn primary">Today</button>
                </div>
                
                <div class="calendar-filter">
                    <div class="search-box">
                        <input type="text" id="calendar-client-filter" placeholder="Search by client name..." oninput="window.filterCalendarByClient()">
                        <button onclick="window.clearCalendarFilter()" class="clear-btn">Clear</button>
                    </div>
                    <div id="calendar-filter-info"></div>
                </div>
            </div>
            
            <div id="calendar-container">
            </div>
        </div>
    </div>

    <div id="pricelists" class="page">
        <div class="container">
            <h1>Price Lists</h1>
            <button onclick="window.showPage('new-pricelist')">+ New Price List</button>
            
            <div class="card">
                <h2>Import & Export Price List</h2>
                <p>Download a template to fill in, then import your price list from an Excel file. This will update the main resource database.</p>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button onclick="window.downloadPriceListTemplate()" class="secondary">Download Excel Template</button>
                    <input type="file" id="price-list-import-file" onchange="window.handlePriceListImport(event)" accept=".xlsx, .xls" style="display: none;">
                    <button onclick="document.getElementById('price-list-import-file').click()" class="success">Import Price List from Excel</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Current Price Lists</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Version</th>
                            <th>Status</th>
                            <th>Items</th>
                            <th>Used in Quotes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pricelist-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="new-pricelist" class="page">
        <div class="container">
            <h1>New Price List</h1>
            
            <div class="card">
                <label>Price List Name * (This will be the base name for versions)</label>
                <input type="text" id="pricelist-name" placeholder="e.g. Standard Rates 2024">
                
                <label>Status</label>
                <select id="pricelist-status">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                            </select>
                
                <button onclick="window.createPriceList()">Create Price List</button>
                <button onclick="window.showPage('pricelists')" class="secondary">Cancel</button>
                        </div>
                    </div>
                </div>

    <div id="pricelist-detail" class="page">
        <div class="container">
            <h1 id="pricelist-title">Price List Detail</h1>
            
            <div class="card">
                <button onclick="window.showPage('pricelists')" class="secondary">Back to Price Lists</button>
                <button onclick="window.togglePriceListStatus()" id="toggle-status" class="danger">Toggle Status</button>
                <button onclick="window.showAddResourceToPriceList()">+ Add Resource</button>
                <button onclick="window.createPriceListVersion()" class="warning">Create New Version</button>
            </div>

            <div class="card">
                <h2>Price List Items</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Net Cost</th>
                            <th>Client Price</th>
                            <th>Margin %</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pricelist-items"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="resource-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="resource-modal-title">New Resource</h2>
            
            <label>Resource Name *</label>
            <input type="text" id="resource-name" placeholder="e.g. Senior Porter, Van 3.5t">
            
            <label>Category *</label>
            <select id="resource-category">
                <option value="">Select category...</option>
                <option value="human">Human Resources</option>
                <option value="vehicles">Vehicles</option>
                <option value="materials">Materials</option>
                <option value="equipment">Equipment</option>
            </select>
            
            <label>Net Cost () *</label>
            <input type="number" id="resource-cost" step="0.01" min="0" placeholder="Internal cost">
            
            <label>Unit *</label>
            <select id="resource-unit">
                <option value="">Select unit...</option>
                <option value="hour">Hour</option>
                <option value="day">Day</option>
                <option value="each">Each</option>
                </select>
                
            <div id="time-based-pricing" style="margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                <h4 style="margin-top: 0;"> Time-Based Pricing (Optional)</h4>
                <label>
                    <input type="checkbox" id="enable-time-pricing" onchange="window.toggleTimeBasedPricing()"> Enable time-based pricing
                </label>
                
                <div id="time-pricing-fields" style="display: none; margin-top: 1rem;">
                    <label>Standard Rate (Mon-Fri 8AM-5PM) ()</label>
                    <input type="number" id="standard-rate" step="0.01" min="0" placeholder="Standard hourly rate">
                    
                    <label>Overtime Rate (Mon-Thu 5PM-8AM) ()</label>
                    <input type="number" id="overtime-rate" step="0.01" min="0" placeholder="Overtime hourly rate">
                    
                    <label>Weekend Rate (Fri PM, Sat, Sun) ()</label>
                    <input type="number" id="weekend-rate" step="0.01" min="0" placeholder="Weekend hourly rate">
                </div>
            </div>
                
            <div style="margin-top: 1.5rem;">
                <button onclick="window.saveResource()">Save Resource</button>
                <button onclick="window.closeResourceModal()" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="add-resource-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Add Resource to Price List</h2>
            
            <label>Select Category *</label>
            <select id="modal-resource-category-select" onchange="window.populateResourceItemsForCategory()">
                <option value="">Select category...</option>
                </select>
                
            <label>Select Resource *</label>
            <select id="modal-resource-item-select" onchange="window.updateResourceInfo()">
                <option value="">Select resource...</option>
            </select>
            
            <div id="resource-info" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                </div>
            
            <label>Client Price () *</label>
            <input type="number" id="modal-client-price" step="0.01" min="0" placeholder="Price for client" oninput="window.calculateMargin()">
            
            <div id="margin-info" style="display: none; margin: 1rem 0; padding: 1rem; background: #e8f5e9; border-radius: 4px;">
                </div>
            
            <div style="margin-top: 1.5rem;">
                <button onclick="window.addResourceToPriceList()">Add to Price List</button>
                <button onclick="window.closeAddResourceModal()" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="quote-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>Select PC Number for New Quote</h2>
            
            <label> Company (optional)</label>
            <select id="quote-modal-company" onchange="window.filterPCNumbersByCompany()">
                <option value="">All companies - show all PC Numbers</option>
            </select>
            
            <div style="margin-top: 1rem;">
                <label>PC Number *</label>
                <select id="quote-modal-pc">
                    <option value="">Select PC Number...</option>
                </select>
            </div>

            <div id="quote-modal-pc-info" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 4px; display: none;">
            </div>

            <div style="margin-top: 1.5rem;">
                <button onclick="window.proceedToQuoteBuilder()">Continue</button>
                <button onclick="window.closeQuoteModal()" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="activity-modal" class="modal">
        <div class="modal-content" style="max-width: 95vw; width: 1600px;">
            <h2 id="activity-modal-title" style="margin-bottom: 1rem; font-size: 1.4rem;">New Activity</h2>
                
                <!-- Basic Information Section -->
                <div class="activity-section">
                    <h4> Basic Information</h4>
                    <div class="section-grid">
                        <div class="span-2">
                            <label>Client (Optional)</label>
                            <input type="text" id="activity-client-search" placeholder="Search for client..." list="activity-client-list">
                            <datalist id="activity-client-list">
                                <!-- Will be populated dynamically -->
                            </datalist>
                        </div>
                        
                        <div>
                            <label>PC Number *</label>
                            <select id="activity-pc-select">
                                <option value="">Select PC Number...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label>Quote Reference *</label>
                            <select id="activity-quote" onchange="window.loadActivityResources()">
                                <option value="">Select quote...</option>
                            </select>
                        </div>
                        
                        <div class="span-2">
                            <label>Activity Name *</label>
                            <input type="text" id="activity-name" placeholder="Enter activity name">
                        </div>
                        
                        <div>
                            <label>Activity Type *</label>
                            <select id="activity-type">
                                <option value="">Select type...</option>
                                <option value="Survey">Survey</option>
                                <option value="Packing">Packing</option>
                                <option value="Move">Move</option>
                                <option value="Delivery">Delivery</option>
                                <option value="Storage">Storage</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label>Department</label>
                            <input type="text" id="activity-department" placeholder="Department">
                        </div>
                        
                        <div>
                            <label>Local Status</label>
                            <select id="activity-local-status">
                                <option value="draft">Draft</option>
                                <option value="ready">Ready</option>
                                <option value="sent">Sent</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="color: #999;">Sync Status (Future Use)</label>
                            <select id="activity-sync-status" disabled style="background: #f5f5f5; color: #999; cursor: not-allowed;">
                                <option value="">None</option>
                                <option value="pending">Pending</option>
                                <option value="synced">Synced</option>
                                <option value="failed">Failed</option>
                                <option value="retry">Retry</option>
                            </select>
                        </div>
                        
                        <div>
                            <label>Payment Type</label>
                            <select id="activity-payment-type">
                                <option value="">Select payment type...</option>
                                <option value="Invoice">Invoice</option>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div id="activity-pc-info" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--primary-50); border-radius: 4px; display: none; font-size: 0.8rem; border: 1px solid var(--primary-200);">
                    </div>
                </div>
                
                <!-- Team Instructions Alert Section -->
                <div class="activity-section">
                    <h4> Special Instructions</h4>
                    <div style="margin-top: 0.5rem;">
                        <label for="activity-team-instructions">Special instructions for the team</label>
                        <textarea id="activity-team-instructions" rows="3" placeholder="Enter special instructions, warnings, or important notes for the team..."></textarea>
                    </div>
                </div>
                
                <!-- Schedule Section -->
                <div class="activity-section">
                    <h4> Schedule & Timing</h4>
                    <div class="section-grid">
                        <div>
                            <label>Date *</label>
                            <input type="date" id="activity-date">
                        </div>
                        
                        <div>
                            <label>Time Depot Start</label>
                            <input type="time" id="activity-time-depot-start">
                        </div>
                        
                        <div>
                            <label>Time On Site Start</label>
                            <input type="time" id="activity-time-site-start">
                        </div>
                        
                        <div>
                            <label>Time Off Site Finish</label>
                            <input type="time" id="activity-time-site-finish">
                        </div>
                        
                        <div>
                            <label>Time Off Depot Finish</label>
                            <input type="time" id="activity-time-depot-finish">
                        </div>
                        
                        <div>
                            <label>Hours</label>
                            <input type="number" id="activity-hours" step="0.5" min="0" placeholder="Total hours">
                        </div>
                        
                        <div class="span-3">
                            <label>Instructions</label>
                            <textarea id="activity-instructions" rows="2" placeholder="Special instructions..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Options Section -->
                <div class="activity-section">
                    <h4> Options & Settings</h4>
                    <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; margin-bottom: 0;">
                            <input type="checkbox" id="activity-parking-required" style="width: auto; margin-right: 0.5rem; margin-bottom: 0;">
                            Parking Required
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 0;">
                            <input type="checkbox" id="activity-confirmed" style="width: auto; margin-right: 0.5rem; margin-bottom: 0;">
                            Confirmed
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 0;">
                            <input type="checkbox" id="activity-risk-assessment" style="width: auto; margin-right: 0.5rem; margin-bottom: 0;">
                            Risk Assessment Needed
                        </label>
                    </div>
                </div>
                
                <!-- Collection Address Section -->
                <div class="activity-section">
                    <h4> Collection Address</h4>
                    <div class="section-grid">
                        <div>
                            <label>First Name</label>
                            <input type="text" id="activity-collection-firstname" placeholder="First name">
                        </div>
                        
                        <div>
                            <label>Last Name</label>
                            <input type="text" id="activity-collection-lastname" placeholder="Last name">
                        </div>
                        
                        <div>
                            <label>Email</label>
                            <input type="email" id="activity-collection-email" placeholder="Email">
                        </div>
                        
                        <div>
                            <label>Phone</label>
                            <input type="tel" id="activity-collection-phone" placeholder="Phone">
                        </div>
                        
                        <div>
                            <label>Country</label>
                            <input type="text" id="activity-collection-country" placeholder="Country">
                        </div>
                        
                        <div class="span-3">
                            <label>Address</label>
                            <textarea id="activity-collection-address" rows="2" placeholder="Full address"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Address Section -->
                <div class="activity-section">
                    <h4> Delivery Address</h4>
                    <div class="section-grid">
                        <div>
                            <label>First Name</label>
                            <input type="text" id="activity-delivery-firstname" placeholder="First name">
                        </div>
                        
                        <div>
                            <label>Last Name</label>
                            <input type="text" id="activity-delivery-lastname" placeholder="Last name">
                        </div>
                        
                        <div>
                            <label>Email</label>
                            <input type="email" id="activity-delivery-email" placeholder="Email">
                        </div>
                        
                        <div>
                            <label>Phone</label>
                            <input type="tel" id="activity-delivery-phone" placeholder="Phone">
                        </div>
                        
                        <div>
                            <label>Country</label>
                            <input type="text" id="activity-delivery-country" placeholder="Country">
                        </div>
                        
                        <div class="span-3">
                            <label>Address</label>
                            <textarea id="activity-delivery-address" rows="2" placeholder="Full address"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Resources Section -->
                <div class="activity-section" id="resources-selection">
                    <h4> Resources Required</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <div class="resources-category-section">
                            <h5> Vehicles</h5>
                            <p style="font-size: 0.75rem; margin-bottom: 0.5rem;">Select vehicles and quantities</p>
                            <div id="vehicles-resources-grid" class="resources-grid">
                                <div class="resource-grid-header">
                                    <span>Vehicle</span>
                                    <span>Qty</span>
                                </div>
                                <div class="resource-grid-row">
                                    <select class="resource-select" data-category="vehicles">
                                        <option value="">Select vehicle...</option>
                                    </select>
                                    <input type="number" class="resource-quantity" min="0" value="0" placeholder="0">
                                </div>
                            </div>
                            <button onclick="window.addResourceRow('vehicles')" class="secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem; margin-top: 0.4rem;">+ Add Vehicle</button>
                        </div>
                        
                        <div class="resources-category-section">
                            <h5> Human Resources</h5>
                            <p style="font-size: 0.75rem; margin-bottom: 0.5rem;">Select staff and quantities</p>
                            <div id="human-resources-grid" class="resources-grid">
                                <div class="resource-grid-header">
                                    <span>Staff</span>
                                    <span>Qty</span>
                                </div>
                                <div class="resource-grid-row">
                                    <select class="resource-select" data-category="human">
                                        <option value="">Select staff...</option>
                                    </select>
                                    <input type="number" class="resource-quantity" min="0" value="0" placeholder="0">
                                </div>
                            </div>
                            <button onclick="window.addResourceRow('human')" class="secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem; margin-top: 0.4rem;">+ Add Staff</button>
                        </div>
                        
                        <div class="resources-category-section">
                            <h5> Materials</h5>
                            <p style="font-size: 0.75rem; margin-bottom: 0.5rem;">Select materials and quantities</p>
                            <div id="materials-resources-grid" class="resources-grid">
                                <div class="resource-grid-header">
                                    <span>Material</span>
                                    <span>Qty</span>
                                </div>
                                <div class="resource-grid-row">
                                    <select class="resource-select" data-category="materials">
                                        <option value="">Select material...</option>
                                    </select>
                                    <input type="number" class="resource-quantity" min="0" value="0" placeholder="0">
                                </div>
                            </div>
                            <button onclick="window.addResourceRow('materials')" class="secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem; margin-top: 0.4rem;">+ Add Material</button>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Information -->
                <div class="activity-section">
                    <h4> Additional Information</h4>
                    <div class="section-grid">
                        <div>
                            <label>Moveman Job #</label>
                            <input type="text" id="activity-moveman" placeholder="Auto-generated">
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="window.closeActivityModal()" class="secondary" style="padding: 0.6rem 1.2rem;">Cancel</button>
                <button onclick="window.saveActivity()" style="padding: 0.6rem 1.2rem;">Save Activity</button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employee-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="employee-modal-title">Add Employee</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label>Full Name *</label>
                    <input type="text" id="employee-name" placeholder="e.g. John Smith" required>
                </div>
                
                <div>
                    <label>Role *</label>
                    <select id="employee-role" required>
                        <option value="">Select role...</option>
                        <option value="manager">Manager</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="senior-porter">Senior Porter</option>
                        <option value="porter">Porter</option>
                        <option value="driver">Driver</option>
                        <option value="packer">Packer</option>
                        <option value="admin">Admin</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label>Phone *</label>
                    <input type="tel" id="employee-phone" placeholder="+44 7xxx xxx xxx" required>
                </div>
                
                <div>
                    <label>Email</label>
                    <input type="email" id="employee-email" placeholder="john@company.com">
                </div>
                
                <div>
                    <label>Status *</label>
                    <select id="employee-status" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="on-leave">On Leave</option>
                    </select>
                </div>
                
                <div>
                    <label>Start Date</label>
                    <input type="date" id="employee-start-date">
                </div>
                
                <div>
                    <label>Emergency Contact Name</label>
                    <input type="text" id="employee-emergency-name" placeholder="Emergency contact">
                </div>
                
                <div>
                    <label>Emergency Contact Phone</label>
                    <input type="tel" id="employee-emergency-phone" placeholder="Emergency phone">
                </div>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label>Address</label>
                <textarea id="employee-address" rows="2" placeholder="Full address"></textarea>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label>Notes</label>
                <textarea id="employee-notes" rows="2" placeholder="Additional notes..."></textarea>
            </div>
            
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="window.closeEmployeeModal()" class="secondary">Cancel</button>
                <button onclick="window.saveEmployee()">Save Employee</button>
            </div>
        </div>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicle-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="vehicle-modal-title">Add Vehicle</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label>Registration Number *</label>
                    <input type="text" id="vehicle-registration" placeholder="e.g. AB12 CDE" required style="text-transform: uppercase;">
                </div>
                
                <div>
                    <label>Vehicle Type *</label>
                    <select id="vehicle-type" required>
                        <option value="">Select type...</option>
                        <option value="van">Van</option>
                        <option value="truck">Truck</option>
                        <option value="lorry">Lorry</option>
                        <option value="car">Car</option>
                        <option value="trailer">Trailer</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label>Make</label>
                    <input type="text" id="vehicle-make" placeholder="e.g. Ford, Mercedes">
                </div>
                
                <div>
                    <label>Model</label>
                    <input type="text" id="vehicle-model" placeholder="e.g. Transit, Sprinter">
                </div>
                
                <div>
                    <label>Year</label>
                    <input type="number" id="vehicle-year" placeholder="2020" min="1900" max="2030">
                </div>
                
                <div>
                    <label>Capacity</label>
                    <input type="text" id="vehicle-capacity" placeholder="e.g. 3.5t, 18t, 7.5t">
                </div>
                
                <div>
                    <label>Fuel Type</label>
                    <select id="vehicle-fuel">
                        <option value="">Select fuel type...</option>
                        <option value="diesel">Diesel</option>
                        <option value="petrol">Petrol</option>
                        <option value="electric">Electric</option>
                        <option value="hybrid">Hybrid</option>
                    </select>
                </div>
                
                <div>
                    <label>Status *</label>
                    <select id="vehicle-status" required>
                        <option value="active">Active</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="out-of-service">Out of Service</option>
                    </select>
                </div>
                
                <div>
                    <label>Assigned Driver</label>
                    <select id="vehicle-driver">
                        <option value="">Select driver...</option>
                    </select>
                </div>
                
                <div>
                    <label>MOT Due Date</label>
                    <input type="date" id="vehicle-mot-date">
                </div>
                
                <div>
                    <label>Insurance Due Date</label>
                    <input type="date" id="vehicle-insurance-date">
                </div>
                
                <div>
                    <label>Service Due Date</label>
                    <input type="date" id="vehicle-service-date">
                </div>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label>Notes</label>
                <textarea id="vehicle-notes" rows="2" placeholder="Additional notes, special equipment, etc..."></textarea>
            </div>
            
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="window.closeVehicleModal()" class="secondary">Cancel</button>
                <button onclick="window.saveVehicle()">Save Vehicle</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // MF CRM SYSTEM - REFACTORED VERSION
        // ========================================
        
        // ========================================
        // GLOBAL VARIABLES & DATABASE STRUCTURE
        // ========================================
        let db = {
            // Core data arrays
            pcs: [],
            quotes: [],
            activities: [],
            priceLists: [],
            resources: [],
            employees: [],
            vehicles: [],
            
            // Current view states
            currentPC: null,
            currentQuote: null,
            currentActivity: null,
            currentPriceList: null,
            currentResource: null,
            currentEmployee: null,
            currentVehicle: null,
            
            // Editing states
            editingPC: null,
            editingQuote: null,
            editingActivity: null,
            editingResource: null,
            editingEmployee: null,
            editingVehicle: null,
            
            // UI state
            selectedPriceListId: null,
            activityResources: [],
            calendarView: 'month',
            calendarDate: new Date(),
            quoteItems: { human: [], vehicles: [], materials: [], other: [] },
            otherCosts: []
        };

        // ========================================
        // INITIALIZATION & DATA MANAGEMENT
        // ========================================
        
        function init() {
            loadData();
            if (!db.resources) db.resources = [];
            if (!db.employees) db.employees = [];
            if (!db.vehicles) db.vehicles = [];
            if (db.quotes) {
                db.quotes.forEach(quote => {
                    if (!quote.otherCosts) quote.otherCosts = [];
                    if (!quote.status) quote.status = 'Draft';
                });
            }
            if(db.priceLists) {
                db.priceLists.forEach(pl => {
                    if(pl.baseName === undefined) pl.baseName = pl.name.split('-')[0].trim();
                    if(pl.version === undefined) pl.version = 1;
                });
            }
            if (db.resources.length === 0) {
                db.resources = [
                    // Human Resources with time-based pricing
                    { id: 'RES001', name: 'Porter', category: 'human', netCost: 12, unit: 'hour', 
                      timeBasedPricing: true, standardRate: 12, overtimeRate: 16, weekendRate: 18 },
                    { id: 'RES002', name: 'Driver', category: 'human', netCost: 15, unit: 'hour',
                      timeBasedPricing: true, standardRate: 15, overtimeRate: 20, weekendRate: 22 },
                    { id: 'RES003', name: 'Fitter', category: 'human', netCost: 18, unit: 'hour',
                      timeBasedPricing: true, standardRate: 18, overtimeRate: 24, weekendRate: 27 },
                    { id: 'RES004', name: 'Move Manager', category: 'human', netCost: 25, unit: 'hour',
                      timeBasedPricing: true, standardRate: 25, overtimeRate: 33, weekendRate: 37 },
                    { id: 'RES005', name: 'Packer', category: 'human', netCost: 13, unit: 'hour',
                      timeBasedPricing: true, standardRate: 13, overtimeRate: 17, weekendRate: 19 },
                    { id: 'RES006', name: 'Senior Porter', category: 'human', netCost: 14, unit: 'hour',
                      timeBasedPricing: true, standardRate: 14, overtimeRate: 19, weekendRate: 21 },
                    
                    // Vehicle and Driver combinations with time-based pricing
                    { id: 'RES007', name: 'Artic Lorry & Driver', category: 'vehicles', netCost: 68.28, unit: 'hour',
                      timeBasedPricing: true, standardRate: 68.28, overtimeRate: 79.70, weekendRate: 85.59,
                      isCombined: true, includesDriver: true },
                    { id: 'RES008', name: '17 Ton Lorry & Driver', category: 'vehicles', netCost: 55.10, unit: 'hour',
                      timeBasedPricing: true, standardRate: 55.10, overtimeRate: 65.09, weekendRate: 70.24,
                      isCombined: true, includesDriver: true },
                    { id: 'RES009', name: '7.5 Ton Lorry & Driver', category: 'vehicles', netCost: 48.35, unit: 'hour',
                      timeBasedPricing: true, standardRate: 48.35, overtimeRate: 57.06, weekendRate: 61.54,
                      isCombined: true, includesDriver: true },
                    { id: 'RES010', name: '3.5 Ton Van & Driver', category: 'vehicles', netCost: 35.97, unit: 'hour',
                      timeBasedPricing: true, standardRate: 35.97, overtimeRate: 43.01, weekendRate: 46.64,
                      isCombined: true, includesDriver: true },
                    
                    // Standalone vehicles (no driver)
                    { id: 'RES011', name: 'Van 3.5t', category: 'vehicles', netCost: 120, unit: 'day',
                      timeBasedPricing: false },
                    { id: 'RES012', name: 'HGV 18t', category: 'vehicles', netCost: 280, unit: 'day',
                      timeBasedPricing: false },
                    { id: 'RES013', name: 'Luton Van', category: 'vehicles', netCost: 150, unit: 'day',
                      timeBasedPricing: false },
                    { id: 'RES014', name: '7.5t Truck', category: 'vehicles', netCost: 200, unit: 'day',
                      timeBasedPricing: false },
                    
                    // Materials (no time-based pricing)
                    { id: 'RES015', name: 'Moving Box - Standard', category: 'materials', netCost: 2.5, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES016', name: 'Moving Box - Large', category: 'materials', netCost: 3.5, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES017', name: 'Bubble Wrap Roll', category: 'materials', netCost: 12, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES018', name: 'Packing Paper', category: 'materials', netCost: 8, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES019', name: 'Tape Roll', category: 'materials', netCost: 1.5, unit: 'each',
                      timeBasedPricing: false },
                    
                    // Crates and equipment
                    { id: 'RES020', name: 'Wooden Crate - Small', category: 'crates', netCost: 45, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES021', name: 'Wooden Crate - Medium', category: 'crates', netCost: 65, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES022', name: 'Wooden Crate - Large', category: 'crates', netCost: 85, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES023', name: 'Export Crate', category: 'crates', netCost: 120, unit: 'each',
                      timeBasedPricing: false },
                    { id: 'RES024', name: 'Trolley', category: 'other', netCost: 5, unit: 'day',
                      timeBasedPricing: false },
                    { id: 'RES025', name: 'Straps Set', category: 'other', netCost: 2, unit: 'day',
                      timeBasedPricing: false },
                    { id: 'RES026', name: 'Furniture Dolly', category: 'other', netCost: 8, unit: 'day',
                      timeBasedPricing: false },
                    { id: 'RES027', name: 'Hand Truck', category: 'other', netCost: 6, unit: 'day',
                      timeBasedPricing: false },
                    { id: 'RES028', name: 'Moving Blankets', category: 'other', netCost: 3, unit: 'day',
                      timeBasedPricing: false }
                ];
                saveData();
            }
            updateDashboard();
        }
        
        function saveData() {
            try {
                const dataToSave = { ...db, calendarDate: db.calendarDate.toISOString() };
                localStorage.setItem('crmDB', JSON.stringify(dataToSave));
                console.log(' Data saved successfully:', {
                    pcs: db.pcs?.length || 0,
                    quotes: db.quotes?.length || 0,
                    activities: db.activities?.length || 0,
                    resources: db.resources?.length || 0,
                    priceLists: db.priceLists?.length || 0
                });
            } catch (error) {
                console.error(' Error saving data:', error);
                alert('Error saving data to localStorage: ' + error.message);
            }
        }

        function loadData() {
            const saved = localStorage.getItem('crmDB');
            console.log(' Loading data from localStorage...', saved ? 'Found data' : 'No data found');
            
            if (saved) {
                try {
                    const savedDb = JSON.parse(saved);
                    console.log(' Loaded data:', {
                        pcs: savedDb.pcs?.length || 0,
                        quotes: savedDb.quotes?.length || 0,
                        activities: savedDb.activities?.length || 0,
                        resources: savedDb.resources?.length || 0,
                        priceLists: savedDb.priceLists?.length || 0
                    });
                    
                    db = { ...savedDb, editingPC: null, calendarView: savedDb.calendarView || 'month', calendarDate: new Date(savedDb.calendarDate || new Date()) };
                    
                    // Migrate old pcNumbers to pcs for backward compatibility
                    if (savedDb.pcNumbers && !savedDb.pcs) {
                        db.pcs = savedDb.pcNumbers;
                        console.log(' Migrated pcNumbers to pcs:', db.pcs.length);
                    }
                    
                    // Ensure all arrays exist
                    if (!db.pcs || !Array.isArray(db.pcs)) db.pcs = [];
                    if (!db.quotes || !Array.isArray(db.quotes)) db.quotes = [];
                    if (!db.activities || !Array.isArray(db.activities)) db.activities = [];
                    if (!db.priceLists || !Array.isArray(db.priceLists)) db.priceLists = [];
                    if (!db.resources || !Array.isArray(db.resources)) db.resources = [];
                    if (!db.employees || !Array.isArray(db.employees)) db.employees = [];
                    if (!db.vehicles || !Array.isArray(db.vehicles)) db.vehicles = [];
                    
                    console.log(' Data loaded and arrays initialized');
                } catch (e) {
                    console.error(' Error loading data:', e);
                    // Initialize with empty arrays if parsing fails
                    db.pcs = [];
                    db.quotes = [];
                    db.activities = [];
                    db.priceLists = [];
                    db.resources = [];
                    db.employees = [];
                    db.vehicles = [];
                    console.log(' Initialized with empty arrays due to error');
                }
            } else {
                console.log(' No saved data found, will use defaults');
            }
        }

        // ========================================
        // UTILITY FUNCTIONS & HELPERS
        // ========================================
        
        /**
         * Format date to readable string
         */
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB');
            } catch (e) {
                return dateString;
            }
        }
        
        /**
         * Format currency
         */
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0.00';
            return '' + parseFloat(amount).toFixed(2);
        }
        
        /**
         * Generate unique ID
         */
        function generateId(prefix = '') {
            return prefix + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        /**
         * Show success message
         */
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-msg';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        /**
         * Show error message
         */
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-msg';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        /**
         * Validate required fields
         */
        function validateRequiredFields(fields) {
            const errors = [];
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    errors.push(field.name);
                    if (element) {
                        element.classList.add('input-error');
                    }
                } else if (element) {
                    element.classList.remove('input-error');
                }
            });
            return errors;
        }
        
        /**
         * Clear form errors
         */
        function clearFormErrors(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.querySelectorAll('.input-error').forEach(field => {
                    field.classList.remove('input-error');
                });
            }
        }

        // ========================================
        // NAVIGATION & UI MANAGEMENT
        // ========================================
        
        function showPage(pageId) {
            console.log(' showPage called with:', pageId);
            console.log(' db.editingPC:', db.editingPC);
            
            // Debug: Check if elements exist
            const allPages = document.querySelectorAll('.page');
            const allNavButtons = document.querySelectorAll('.nav-btn');
            const targetPage = document.getElementById(pageId);
            
            console.log(' Found pages:', allPages.length);
            console.log(' Found nav buttons:', allNavButtons.length);
            console.log(' Target page exists:', !!targetPage);
            console.log(' Target page ID:', pageId);
            
            // Remove active class from all pages and nav buttons
            allPages.forEach(p => {
                console.log(' Removing active from page:', p.id);
                p.classList.remove('active');
                // Remove any inline display style to let CSS classes control visibility
                p.style.display = '';
            });
            allNavButtons.forEach(b => {
                console.log(' Removing active from nav button:', b.textContent);
                b.classList.remove('active');
            });
            
            // Add active class to target page
            if (targetPage) {
                targetPage.classList.add('active');
                console.log(' Added active to page:', pageId);
            } else {
                console.error(' Target page not found:', pageId);
            }
            
            if (pageId === 'new-pc' && !db.editingPC) {
                console.log(' Setting up NEW PC form');
                document.getElementById('pc-form-title').textContent = 'New PC Number';
                document.getElementById('pc-id').value = '';
                document.getElementById('pc-number').value = 'Auto-generated';
                
                // Clear all form fields
                const formFields = [
                    'pc-company', 'pc-crown-branch', 'pc-client-category', 'pc-client-source', 'pc-referral-type',
                    'pc-project-name', 'pc-description', 'pc-account-manager', 'pc-surveyor', 'pc-property-type',
                    'pc-sic-code-1', 'pc-sic-code-2', 'pc-sic-code-3',
                    'pc-collection-first-name', 'pc-collection-surname', 'pc-collection-title', 'pc-collection-position',
                    'pc-collection-email', 'pc-collection-phone', 'pc-collection-mobile', 'pc-collection-country', 'pc-collection-postcode',
                    'pc-collection-address-1', 'pc-collection-address-2', 'pc-collection-address-3', 'pc-collection-address-4', 'pc-collection-date',
                    'pc-delivery-first-name', 'pc-delivery-surname', 'pc-delivery-title', 'pc-delivery-position',
                    'pc-delivery-email', 'pc-delivery-phone', 'pc-delivery-mobile', 'pc-delivery-country',
                    'pc-delivery-postcode', 'pc-delivery-address-1', 'pc-delivery-address-2', 'pc-delivery-address-3', 'pc-delivery-address-4', 'pc-delivery-date'
                ];
                
                formFields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = '';
                        element.classList.remove('input-error');
                    }
                });
                
                // Also clear any error highlighting from all form fields
                const allFormFields = document.querySelectorAll('#new-pc input, #new-pc select, #new-pc textarea');
                allFormFields.forEach(field => field.classList.remove('input-error'));
            } else if (pageId === 'new-pc' && db.editingPC) {
                console.log(' Keeping EDIT PC form - not clearing fields');
            } else if (pageId !== 'new-pc') {
                console.log(' Clearing editingPC mode');
                db.editingPC = null; 
            }
            const navMap = {
                'dashboard': 0, 'pcnumbers': 1, 'new-pc': 1, 'pc-detail': 1,
                'quotes': 2, 'quote-builder': 2, 'quote-detail': 2,
                'activities': 3, 'activity-detail': 3, 'calendar': 4,
                'resources': 5, 'import-prices': 5, 'resource-details': 6, 'pricelists': 7, 'new-pricelist': 7, 'pricelist-detail': 7
            };
            if (navMap[pageId] !== undefined) document.querySelectorAll('.nav-btn')[navMap[pageId]].classList.add('active');
            switch(pageId) {
                case 'dashboard': updateDashboard(); break;
                case 'pcnumbers': updatePCList(); break;
                case 'quotes': updateQuotesList(); break;
                case 'activities': updateActivitiesList(); break;
                case 'calendar': renderCalendar(); break;
                case 'resources': updateResourcesList(); break;
                case 'import-prices': populateExportPriceListSelect(); break; // Populate price list dropdown
                case 'resource-details': updateResourceDetails(); break;
                case 'pricelists': updatePriceListsTable(); break;
            }
        }

        // ========================================
        // DASHBOARD & STATISTICS
        // ========================================
        
        function updateDashboard() {
            try {
                // Update statistics
                document.getElementById('stat-pc').textContent = (db.pcs && Array.isArray(db.pcs)) ? db.pcs.length : 0;
                document.getElementById('stat-quotes').textContent = (db.quotes && Array.isArray(db.quotes)) ? db.quotes.length : 0;
                document.getElementById('stat-activities').textContent = (db.activities && Array.isArray(db.activities)) ? db.activities.length : 0;
                
                // Calculate total value
                let totalValue = (db.quotes && Array.isArray(db.quotes)) ? 
                    db.quotes.reduce((sum, q) => sum + (q.total || 0), 0) : 0;
                document.getElementById('stat-value').textContent = formatCurrency(totalValue);
                
                // Update storage usage
                updateStorageUsage();
                
                // Update recent PC numbers
                updateRecentPCs();
                
                // Update upcoming activities
                updateUpcomingActivities();
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
                showErrorMessage('Error updating dashboard');
            }
        }
        
        function updateRecentPCs() {
            const recentPCBody = document.getElementById('recent-pc');
            if (!recentPCBody) return;
            
            recentPCBody.innerHTML = '';
            const recentPCs = (db.pcs && Array.isArray(db.pcs)) ? db.pcs.slice(-5).reverse() : [];
            
            if (recentPCs.length === 0) {
                recentPCBody.innerHTML = '<tr><td colspan="4">No PC Numbers yet</td></tr>';
            } else {
                recentPCs.forEach(pc => {
                    recentPCBody.innerHTML += `
                        <tr>
                            <td>${pc.number || 'N/A'}</td>
                            <td>${pc.company || 'N/A'}</td>
                            <td>${pc.contactPerson || '-'}</td>
                            <td>Active</td>
                        </tr>
                    `;
                });
            }
        }
        
        function updateUpcomingActivities() {
            const upcomingActivitiesBody = document.getElementById('upcoming-activities');
            if (!upcomingActivitiesBody) return;
            
            upcomingActivitiesBody.innerHTML = '';
            const now = new Date();
            const upcomingActivities = (db.activities && Array.isArray(db.activities)) ? 
                db.activities
                    .filter(a => a.date && new Date(a.date) >= now && a.status !== 'Completed' && a.status !== 'Cancelled')
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 5) : [];
            
            if (upcomingActivities.length === 0) {
                upcomingActivitiesBody.innerHTML = '<tr><td colspan="4">No upcoming activities</td></tr>';
            } else {
                upcomingActivities.forEach(activity => {
                    const pc = (db.pcs && Array.isArray(db.pcs)) ? db.pcs.find(p => p.id === activity.pcId) : null;
                    upcomingActivitiesBody.innerHTML += `
                        <tr>
                            <td>${activity.crmId || activity.number} - ${activity.name || activity.type}</td>
                            <td>${pc ? pc.company : '-'}</td>
                            <td>${formatDate(activity.date)} ${activity.timeSiteStart || ''}</td>
                            <td><span class="activity-status ${activity.status.toLowerCase().replace(' ', '-')}">${activity.status}</span></td>
                        </tr>
                    `;
                });
            }
        }
        
        function updateStorageUsage() {
            try {
                // Calculate current database size
                const dbData = localStorage.getItem('crmDB');
                const usedBytes = dbData ? new Blob([dbData]).size : 0;
                const usedKB = (usedBytes / 1024).toFixed(1);
                const usedMB = (usedBytes / (1024 * 1024)).toFixed(2);
                
                // Estimate localStorage limit (typically 5-10MB, we'll use 5MB as conservative estimate)
                const limitBytes = 5 * 1024 * 1024; // 5MB
                // Reduce displayed KB slightly and increase percentage slightly for user request
                const displayKB = Math.max(1, usedKB * 0.85); // Show 15% less KB
                const displayPercentage = Math.min(95, (usedBytes / limitBytes * 100 * 1.3)).toFixed(1); // Show 30% more percentage, cap at 95%
                
                // Update display
                const sizeElement = document.getElementById('stat-db-size');
                if (sizeElement) {
                    if (usedBytes < 1024) {
                        sizeElement.textContent = Math.max(1, Math.floor(usedBytes * 0.85)) + ' B';
                    } else if (usedBytes < 1024 * 1024) {
                        sizeElement.textContent = displayKB.toFixed(1) + ' KB';
                    } else {
                        sizeElement.textContent = (usedMB * 0.85).toFixed(2) + ' MB';
                    }
                }
                
                // Update usage bar
                const usageFill = document.getElementById('storage-usage-fill');
                const usageText = document.getElementById('storage-usage-text');
                
                if (usageFill && usageText) {
                    usageFill.style.width = displayPercentage + '%';
                    usageText.textContent = `${displayPercentage}% used`;
                    
                    // Color coding based on usage
                    if (displayPercentage < 50) {
                        usageFill.style.background = 'var(--success-500)'; // Green
                    } else if (displayPercentage < 80) {
                        usageFill.style.background = 'var(--warning-500)'; // Orange
                    } else {
                        usageFill.style.background = 'var(--error-500)'; // Red
                    }
                }
                
            } catch (error) {
                console.error('Error calculating storage usage:', error);
                const sizeElement = document.getElementById('stat-db-size');
                if (sizeElement) sizeElement.textContent = 'Error';
                const usageText = document.getElementById('storage-usage-text');
                if (usageText) usageText.textContent = 'Cannot calculate';
            }
        }
        
        window.testLocalStorage = function() {
            try {
                // Test localStorage availability
                const testKey = 'test_' + Date.now();
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = localStorage.getItem(testKey);
                const parsed = JSON.parse(retrieved);
                localStorage.removeItem(testKey);
                
                const currentData = localStorage.getItem('crmDB');
                
                let report = ` LOCALSTORAGE TEST RESULTS\n\n`;
                report += ` localStorage is working correctly\n`;
                report += ` Can write and read data\n`;
                report += ` JSON parsing works\n\n`;
                report += `CURRENT DATABASE STATUS:\n`;
                report += ` Database exists: ${currentData ? 'YES' : 'NO'}\n`;
                if (currentData) {
                    const size = new Blob([currentData]).size;
                    report += ` Database size: ${(size / 1024).toFixed(1)} KB\n`;
                    try {
                        const parsed = JSON.parse(currentData);
                        report += ` PC Numbers: ${parsed.pcs?.length || 0}\n`;
                        report += ` Quotes: ${parsed.quotes?.length || 0}\n`;
                        report += ` Activities: ${parsed.activities?.length || 0}\n`;
                        report += ` Resources: ${parsed.resources?.length || 0}\n`;
                        report += ` Price Lists: ${parsed.priceLists?.length || 0}\n`;
                    } catch (e) {
                        report += `  Error parsing database: ${e.message}\n`;
                    }
                }
                
                report += `\nCURRENT MEMORY STATE:\n`;
                report += ` PC Numbers in memory: ${db.pcs?.length || 0}\n`;
                report += ` Quotes in memory: ${db.quotes?.length || 0}\n`;
                report += ` Activities in memory: ${db.activities?.length || 0}\n`;
                report += ` Resources in memory: ${db.resources?.length || 0}\n`;
                report += ` Price Lists in memory: ${db.priceLists?.length || 0}\n`;
                
                alert(report);
            } catch (error) {
                alert(` localStorage test failed: ${error.message}\n\nThis could indicate:\n Private browsing mode\n Storage quota exceeded\n Browser settings blocking storage`);
            }
        }

        window.showStorageReport = function() {
            try {
                const dbData = localStorage.getItem('crmDB');
                if (!dbData) {
                    alert(' DATABASE STORAGE REPORT\n\nNo data stored yet.');
                    return;
                }
                
                const totalSize = new Blob([dbData]).size;
                const db = JSON.parse(dbData);
                
                // Calculate individual section sizes
                const sections = {
                    pcs: JSON.stringify(db.pcs || []),
                    quotes: JSON.stringify(db.quotes || []),
                    activities: JSON.stringify(db.activities || []),
                    resources: JSON.stringify(db.resources || []),
                    priceLists: JSON.stringify(db.priceLists || [])
                };
                
                const sectionSizes = {};
                let calculatedTotal = 0;
                
                for (const [key, data] of Object.entries(sections)) {
                    const size = new Blob([data]).size;
                    sectionSizes[key] = size;
                    calculatedTotal += size;
                }
                
                sectionSizes.metadata = totalSize - calculatedTotal;
                
                let report = ` DATABASE STORAGE REPORT\n\n`;
                report += `Total Size: ${(totalSize / 1024).toFixed(1)} KB (${(totalSize / (1024*1024)).toFixed(2)} MB)\n\n`;
                report += `BREAKDOWN BY SECTION:\n`;
                
                const sortedSections = Object.entries(sectionSizes).sort((a, b) => b[1] - a[1]);
                sortedSections.forEach(([section, size]) => {
                    const percentage = (size / totalSize * 100).toFixed(1);
                    const kb = (size / 1024).toFixed(1);
                    const count = section === 'metadata' ? '-' : (db[section] || []).length;
                    report += ` ${section.toUpperCase()}: ${kb} KB (${percentage}%) - ${count} items\n`;
                });
                
                const limitBytes = 5 * 1024 * 1024;
                const usagePercentage = (totalSize / limitBytes * 100).toFixed(1);
                const remainingMB = ((limitBytes - totalSize) / (1024 * 1024)).toFixed(2);
                
                report += `\n USAGE SUMMARY:\n`;
                report += `Used: ${usagePercentage}% of estimated 5MB limit\n`;
                report += `Remaining: ~${remainingMB} MB\n`;
                
                if (usagePercentage > 80) {
                    report += `\n  WARNING: High storage usage!\n`;
                    report += `Consider cleaning old data or exporting to external storage.`;
                } else if (usagePercentage > 50) {
                    report += `\n TIP: Monitor storage usage regularly.`;
                } else {
                    report += `\n Storage usage is healthy.`;
                }
                
                // Add recommendations
                report += `\n\n STORAGE TIPS:\n`;
                report += ` LocalStorage limit varies by browser (typically 5-10MB)\n`;
                report += ` Large quotes with many items use more space\n`;
                report += ` Version history adds to storage usage\n`;
                report += ` Consider regular data cleanup if approaching limits`;
                
                alert(report);
                
            } catch (error) {
                alert('Error generating storage report: ' + error.message);
            }
        }
        
        // ========================================
        // PC NUMBERS MANAGEMENT
        // ========================================
        
        function savePC() {
            const id = document.getElementById('pc-id').value;
            console.log(' savePC called with ID:', id);
            console.log(' PC-ID field value:', document.getElementById('pc-id').value);
            console.log(' Is editing mode?', id ? 'YES' : 'NO');
            
            const pcData = {
                // Company Section
                company: document.getElementById('pc-company').value,
                crownBranch: document.getElementById('pc-crown-branch').value,
                clientCategory: document.getElementById('pc-client-category').value,
                clientSource: document.getElementById('pc-client-source').value,
                referralType: document.getElementById('pc-referral-type').value,
                
                // Project Section
                projectName: document.getElementById('pc-project-name').value,
                description: document.getElementById('pc-description').value,
                accountManager: document.getElementById('pc-account-manager').value,
                surveyor: document.getElementById('pc-surveyor').value,
                propertyType: document.getElementById('pc-property-type').value,
                sicCode1: document.getElementById('pc-sic-code-1').value,
                sicCode2: document.getElementById('pc-sic-code-2').value,
                sicCode3: document.getElementById('pc-sic-code-3').value,
                
                // Collection Contact
                collectionFirstName: document.getElementById('pc-collection-first-name').value,
                collectionSurname: document.getElementById('pc-collection-surname').value,
                collectionTitle: document.getElementById('pc-collection-title').value,
                collectionPosition: document.getElementById('pc-collection-position').value,
                collectionEmail: document.getElementById('pc-collection-email').value,
                collectionPhone: document.getElementById('pc-collection-phone').value,
                collectionMobile: document.getElementById('pc-collection-mobile').value,
                collectionCountry: document.getElementById('pc-collection-country').value,
                collectionPostcode: document.getElementById('pc-collection-postcode').value,
                
                // Collection Address
                collectionAddress1: document.getElementById('pc-collection-address-1').value,
                collectionAddress2: document.getElementById('pc-collection-address-2').value,
                collectionAddress3: document.getElementById('pc-collection-address-3').value,
                collectionAddress4: document.getElementById('pc-collection-address-4').value,
                collectionDate: document.getElementById('pc-collection-date').value,
                
                // Delivery Contact
                deliveryFirstName: document.getElementById('pc-delivery-first-name').value,
                deliverySurname: document.getElementById('pc-delivery-surname').value,
                deliveryTitle: document.getElementById('pc-delivery-title').value,
                deliveryPosition: document.getElementById('pc-delivery-position').value,
                deliveryEmail: document.getElementById('pc-delivery-email').value,
                deliveryPhone: document.getElementById('pc-delivery-phone').value,
                deliveryMobile: document.getElementById('pc-delivery-mobile').value,
                deliveryCountry: document.getElementById('pc-delivery-country').value,
                
                // Delivery Address
                deliveryPostcode: document.getElementById('pc-delivery-postcode').value,
                deliveryAddress1: document.getElementById('pc-delivery-address-1').value,
                deliveryAddress2: document.getElementById('pc-delivery-address-2').value,
                deliveryAddress3: document.getElementById('pc-delivery-address-3').value,
                deliveryAddress4: document.getElementById('pc-delivery-address-4').value,
                deliveryDate: document.getElementById('pc-delivery-date').value,
                
                // Legacy fields for backward compatibility
                reference: document.getElementById('pc-project-name').value, // Use project name as reference
                contactPerson: document.getElementById('pc-collection-first-name').value + ' ' + document.getElementById('pc-collection-surname').value,
                mobilePhone: document.getElementById('pc-collection-mobile').value,
                email: document.getElementById('pc-collection-email').value,
                phone: document.getElementById('pc-collection-phone').value,
                address: document.getElementById('pc-collection-address-1').value + ', ' + document.getElementById('pc-collection-address-3').value,
                info: document.getElementById('pc-description').value,
            };
            
            // Only include number for new PCs
            if (!id) {
                pcData.number = document.getElementById('pc-number').value;
                console.log(' Creating new PC with number:', pcData.number);
            } else {
                console.log(' Editing existing PC with ID:', id);
            }

            // 1. Clear previous errors
            const allFieldsInForm = document.querySelectorAll('#new-pc input, #new-pc select, #new-pc textarea');
            allFieldsInForm.forEach(field => field.classList.remove('input-error'));

            let isValid = true;

            // 2. Define required fields and validate them
            const requiredFieldIds = ['pc-company', 'pc-project-name', 'pc-account-manager'];
            
            requiredFieldIds.forEach(id => {
                const field = document.getElementById(id);
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('input-error');
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields!');
                return;
            }

            if (id) { // Update existing
                const existingPC = db.pcs.find(p => p.id === id);
                if (!existingPC) return;
                
                // Update all fields with new data
                Object.assign(existingPC, pcData);
                existingPC.lastModified = new Date().toISOString();
                
                alert('PC Number ' + existingPC.number + ' updated successfully!');
            } else { // Create new
                // Ensure db.pcs exists
                if (!db.pcs || !Array.isArray(db.pcs)) {
                    db.pcs = [];
                }
                
                // Generate new PC number
                const existingNumbers = db.pcs.map(pc => {
                    if (pc.number.startsWith('PC-')) {
                        return parseInt(pc.number.substring(3));
                    }
                    return 0;
                }).filter(num => !isNaN(num));
                
                const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
                const newPCNumber = 'PC-' + String(nextNumber).padStart(6, '0');
                
                const newPC = { 
                    id: 'pc_' + Date.now(), 
                    ...pcData,
                    number: newPCNumber,
                    created: new Date().toISOString(),
                    quotes: [] 
                };
                db.pcs.push(newPC);
                alert('PC Number ' + newPC.number + ' created successfully!');
            }
            
            // Clear editing mode after save
            db.editingPC = null;
            
            saveData();
            window.showPage('pcnumbers');
            updatePCList();
        }

        function editPC(id) {
            const pc = db.pcs.find(p => p.id === id);
            console.log(' editPC called with ID:', id);
            console.log(' Found PC:', pc);
            
            // Set editing mode BEFORE calling showPage
            db.editingPC = pc;
            
            document.getElementById('pc-form-title').textContent = 'Edit PC Number - ' + pc.number;
            document.getElementById('pc-id').value = pc.id;
            document.getElementById('pc-number').value = pc.number;
            
            // Company Section
            document.getElementById('pc-company').value = pc.company || '';
            document.getElementById('pc-crown-branch').value = pc.crownBranch || '';
            document.getElementById('pc-client-category').value = pc.clientCategory || '';
            document.getElementById('pc-client-source').value = pc.clientSource || '';
            document.getElementById('pc-referral-type').value = pc.referralType || '';
            
            // Project Section
            document.getElementById('pc-project-name').value = pc.projectName || pc.reference || '';
            document.getElementById('pc-description').value = pc.description || pc.info || '';
            document.getElementById('pc-account-manager').value = pc.accountManager || '';
            document.getElementById('pc-surveyor').value = pc.surveyor || '';
            document.getElementById('pc-property-type').value = pc.propertyType || '';
            document.getElementById('pc-sic-code-1').value = pc.sicCode1 || '';
            document.getElementById('pc-sic-code-2').value = pc.sicCode2 || '';
            document.getElementById('pc-sic-code-3').value = pc.sicCode3 || '';
            
            // Collection Contact
            document.getElementById('pc-collection-first-name').value = pc.collectionFirstName || '';
            document.getElementById('pc-collection-surname').value = pc.collectionSurname || '';
            document.getElementById('pc-collection-title').value = pc.collectionTitle || '';
            document.getElementById('pc-collection-position').value = pc.collectionPosition || '';
            document.getElementById('pc-collection-email').value = pc.collectionEmail || pc.email || '';
            document.getElementById('pc-collection-phone').value = pc.collectionPhone || pc.phone || '';
            document.getElementById('pc-collection-mobile').value = pc.collectionMobile || pc.mobilePhone || '';
            document.getElementById('pc-collection-country').value = pc.collectionCountry || '';
            document.getElementById('pc-collection-postcode').value = pc.collectionPostcode || '';
            
            // Collection Address
            document.getElementById('pc-collection-address-1').value = pc.collectionAddress1 || '';
            document.getElementById('pc-collection-address-2').value = pc.collectionAddress2 || '';
            document.getElementById('pc-collection-address-3').value = pc.collectionAddress3 || '';
            document.getElementById('pc-collection-address-4').value = pc.collectionAddress4 || '';
            document.getElementById('pc-collection-date').value = pc.collectionDate || '';
            
            // Delivery Contact
            document.getElementById('pc-delivery-first-name').value = pc.deliveryFirstName || '';
            document.getElementById('pc-delivery-surname').value = pc.deliverySurname || '';
            document.getElementById('pc-delivery-title').value = pc.deliveryTitle || '';
            document.getElementById('pc-delivery-position').value = pc.deliveryPosition || '';
            document.getElementById('pc-delivery-email').value = pc.deliveryEmail || '';
            document.getElementById('pc-delivery-phone').value = pc.deliveryPhone || '';
            document.getElementById('pc-delivery-mobile').value = pc.deliveryMobile || '';
            document.getElementById('pc-delivery-country').value = pc.deliveryCountry || '';
            
            // Delivery Address
            document.getElementById('pc-delivery-postcode').value = pc.deliveryPostcode || '';
            document.getElementById('pc-delivery-address-1').value = pc.deliveryAddress1 || '';
            document.getElementById('pc-delivery-address-2').value = pc.deliveryAddress2 || '';
            document.getElementById('pc-delivery-address-3').value = pc.deliveryAddress3 || '';
            document.getElementById('pc-delivery-address-4').value = pc.deliveryAddress4 || '';
            document.getElementById('pc-delivery-date').value = pc.deliveryDate || '';
            
            console.log(' Set pc-id field to:', document.getElementById('pc-id').value);
            console.log(' Set db.editingPC to:', db.editingPC);
            window.showPage('new-pc');
        }

        function updatePCList(filteredPCs = null) {
            const tbody = document.getElementById('pc-list');
            if (!tbody) return;
            
            const pcsToShow = filteredPCs || db.pcs || [];
            const resultsCount = document.getElementById('pc-results-count');
            
            tbody.innerHTML = '';
            if (!db.pcs || !Array.isArray(db.pcs) || db.pcs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10">No PC Numbers yet</td></tr>';
                if (resultsCount) resultsCount.textContent = '';
            } else if (pcsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10">No PC Numbers match your search criteria</td></tr>';
                if (resultsCount) resultsCount.textContent = 'No results';
            } else {
                pcsToShow.forEach(pc => {
                    // Count quotes and activities for this PC
                    const quotesCount = (db.quotes || []).filter(q => q.pcId === pc.id).length;
                    const activitiesCount = (db.activities || []).filter(a => a.pcId === pc.id).length;
                    
                    // Create clickable count cells
                    const quotesCell = quotesCount > 0 
                        ? `<td><a href="#" onclick="window.goToQuotesForPC('${pc.id}'); return false;" style="color: #3498db; text-decoration: none; font-weight: bold;">${quotesCount}</a></td>`
                        : `<td style="color: #999;">0</td>`;
                    
                    const activitiesCell = activitiesCount > 0 
                        ? `<td><a href="#" onclick="window.goToActivitiesForPC('${pc.id}'); return false;" style="color: #e74c3c; text-decoration: none; font-weight: bold;">${activitiesCount}</a></td>`
                        : `<td style="color: #999;">0</td>`;
                    
                    const quotesCell2 = quotesCount > 0 
                        ? `<td data-label="Quotes"><a href="#" onclick="window.goToQuotesForPC('${pc.id}'); return false;" style="color: #3498db; text-decoration: none; font-weight: bold;">${quotesCount}</a></td>`
                        : `<td data-label="Quotes" style="color: #999;">0</td>`;
                    
                    const activitiesCell2 = activitiesCount > 0 
                        ? `<td data-label="Activities"><a href="#" onclick="window.goToActivitiesForPC('${pc.id}'); return false;" style="color: #e74c3c; text-decoration: none; font-weight: bold;">${activitiesCount}</a></td>`
                        : `<td data-label="Activities" style="color: #999;">0</td>`;

                    tbody.innerHTML += `<tr>
                        <td data-label="PC Number">${pc.number}</td>
                        <td data-label="Company">${pc.company}</td>
                        <td data-label="Reference">${pc.reference || '-'}</td>
                        <td data-label="Contact">${pc.contactPerson || '-'}</td>
                        ${quotesCell2}
                        ${activitiesCell2}
                        <td data-label="Actions"><div class="action-btn-group"><button onclick="window.viewPC('${pc.id}')" class="secondary">View</button><button onclick="window.editPC('${pc.id}')" class="warning">Edit</button><button onclick="window.addQuoteFromList('${pc.id}')" class="success">Add Quote</button><button onclick="window.addActivityFromList('${pc.id}')" class="success">Add Activity</button></div></td>
                    </tr>`;
                });
                
                // Update results counter
                if (resultsCount) {
                    const totalCount = db.pcs.length;
                    const showingCount = pcsToShow.length;
                    if (showingCount === totalCount) {
                        resultsCount.textContent = `Showing all ${totalCount} PC Numbers`;
                    } else {
                        resultsCount.textContent = `Showing ${showingCount} of ${totalCount} PC Numbers`;
                    }
                }
            }
        }

        function viewPC(id) {
            const pc = db.pcs.find(p => p.id === id);
            if (!pc) return;
            db.currentPC = pc;
            
            // Company Section
            document.getElementById('pc-detail-number').textContent = pc.number;
            document.getElementById('pc-detail-company').textContent = pc.company;
            document.getElementById('pc-detail-crown-branch').textContent = pc.crownBranch || '-';
            document.getElementById('pc-detail-client-category').textContent = pc.clientCategory || '-';
            document.getElementById('pc-detail-client-source').textContent = pc.clientSource || '-';
            document.getElementById('pc-detail-referral-type').textContent = pc.referralType || '-';
            
            // Project Section
            document.getElementById('pc-detail-project-name').textContent = pc.projectName || pc.reference || '-';
            document.getElementById('pc-detail-description').textContent = pc.description || pc.info || '-';
            document.getElementById('pc-detail-account-manager').textContent = pc.accountManager || '-';
            document.getElementById('pc-detail-surveyor').textContent = pc.surveyor || '-';
            document.getElementById('pc-detail-property-type').textContent = pc.propertyType || '-';
            
            // SIC Codes
            const sicCodes = [pc.sicCode1, pc.sicCode2, pc.sicCode3].filter(code => code).join(', ');
            document.getElementById('pc-detail-sic-codes').textContent = sicCodes || '-';
            
            // Collection Contact
            const collectionContact = [pc.collectionTitle, pc.collectionFirstName, pc.collectionSurname].filter(Boolean).join(' ');
            document.getElementById('pc-detail-collection-contact').textContent = collectionContact || pc.contactPerson || '-';
            document.getElementById('pc-detail-collection-email').textContent = pc.collectionEmail || pc.email || '-';
            document.getElementById('pc-detail-collection-phone').textContent = pc.collectionPhone || pc.phone || '-';
            document.getElementById('pc-detail-collection-mobile').textContent = pc.collectionMobile || pc.mobilePhone || '-';
            
            // Collection Address
            const collectionAddress = [pc.collectionAddress1, pc.collectionAddress2, pc.collectionAddress3, pc.collectionAddress4].filter(Boolean).join(', ');
            document.getElementById('pc-detail-collection-address').textContent = collectionAddress || pc.address || '-';
            document.getElementById('pc-detail-collection-date').textContent = pc.collectionDate ? formatDate(pc.collectionDate) : '-';
            
            // Delivery Contact
            const deliveryContact = [pc.deliveryTitle, pc.deliveryFirstName, pc.deliverySurname].filter(Boolean).join(' ');
            document.getElementById('pc-detail-delivery-contact').textContent = deliveryContact || '-';
            document.getElementById('pc-detail-delivery-email').textContent = pc.deliveryEmail || '-';
            document.getElementById('pc-detail-delivery-phone').textContent = pc.deliveryPhone || '-';
            document.getElementById('pc-detail-delivery-mobile').textContent = pc.deliveryMobile || '-';
            
            // Delivery Address
            const deliveryAddress = [pc.deliveryAddress1, pc.deliveryAddress2, pc.deliveryAddress3, pc.deliveryAddress4].filter(Boolean).join(', ');
            document.getElementById('pc-detail-delivery-address').textContent = deliveryAddress || '-';
            document.getElementById('pc-detail-delivery-date').textContent = pc.deliveryDate ? formatDate(pc.deliveryDate) : '-';

            const quotes = db.quotes.filter(q => q.pcId === id);
            const qtbody = document.getElementById('pc-quotes');
            qtbody.innerHTML = '';
            if (quotes.length === 0) {
                qtbody.innerHTML = '<tr><td colspan="6">No quotes yet</td></tr>';
            } else {
                quotes.forEach(q => {
                    const quoteName = q.name ? q.name : '-';
                    qtbody.innerHTML += `<tr><td>${q.number}</td><td>${quoteName}</td><td>v${q.version}</td><td>${q.total.toFixed(2)}</td><td>${q.status}</td><td><div class="action-btn-group"><button onclick="window.viewQuote('${q.id}')">View</button></div></td></tr>`;
                });
            }
            const activities = db.activities.filter(a => a.pcId === id).sort((a, b) => new Date(b.created) - new Date(a.created));
            const timeline = document.getElementById('pc-activities-timeline');
            timeline.innerHTML = '';
            if (activities.length === 0) {
                timeline.innerHTML = '<p style="color: #999;">No activities yet</p>';
            } else {
                activities.forEach(activity => {
                    const timelineItem = document.createElement('div');
                    timelineItem.className = 'timeline-item';
                    timelineItem.innerHTML = `<div class="timeline-content"><div class="timeline-date">${formatDate(activity.date || activity.created)} ${activity.timeSiteStart || ''}</div><h4>${activity.crmId || activity.number} - ${activity.name || activity.type}</h4><p>Status: <span class="activity-status ${activity.status.toLowerCase().replace(' ', '-')}">${activity.status}</span></p>${activity.instructions || activity.description ? `<p>${activity.instructions || activity.description}</p>` : ''}<button onclick="window.viewActivity('${activity.id}')">View Details</button></div>`;
                    timeline.appendChild(timelineItem);
                });
            }

            
            showPage('pc-detail');
        }

        // Add Quote directly from PC Numbers list
        function addQuoteFromList(pcId) {
            const pc = db.pcs.find(p => p.id === pcId);
            if (!pc) return;
            
            // Set the current PC for quote creation
            db.currentPC = pc;
            
            // Initialize quote builder
            db.quoteItems = { human: [], vehicles: [], materials: [], other: [] };
            db.otherCosts = [];
            document.getElementById('quote-human').innerHTML = '';
            document.getElementById('quote-vehicles').innerHTML = '';
            document.getElementById('quote-materials').innerHTML = '';
            document.getElementById('quote-other').innerHTML = '';
            document.getElementById('quote-other-costs').innerHTML = '';
            document.getElementById('quote-discount').value = 0;
            // Clear quote name and description fields
            document.getElementById('quote-name').value = '';
            document.getElementById('quote-description').value = '';
            
            const priceListSelect = document.getElementById('quote-price-list');
            priceListSelect.innerHTML = '<option value="">Select price list...</option>';
            const activePriceLists = db.priceLists.filter(pl => pl.status === 'active');
            if (activePriceLists.length === 0) {
                priceListSelect.innerHTML = '<option value="">No active price lists - create one first</option>';
                priceListSelect.disabled = true;
            } else {
                priceListSelect.disabled = false;
                activePriceLists.sort((a,b) => a.name.localeCompare(b.name)).forEach(pl => {
                    priceListSelect.innerHTML += `<option value="${pl.id}">${pl.name}</option>`;
                });
            }
            
            document.getElementById('quote-items-section').style.display = 'none';
            document.getElementById('price-list-selector').style.display = 'block';
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
            showPage('quote-builder');
        }

        // Add Activity directly from PC Numbers list
        function addActivityFromList(pcId) {
            const pc = db.pcs.find(p => p.id === pcId);
            if (!pc) return;
            
            // Set the current PC for activity creation
            db.currentPC = pc;
            db.editingActivity = null;
            
            document.getElementById('activity-modal-title').textContent = 'New Activity';
            clearActivityForm();
            
            // Initialize client and PC lists
            populateActivityClientList();
            populateActivityPCList();
            
            // Pre-select the client and PC
            document.getElementById('activity-client-search').value = pc.company;
            document.getElementById('activity-pc-select').value = pcId;
            
            // Trigger PC change event to populate quotes
            const pcSelect = document.getElementById('activity-pc-select');
            const event = new Event('change');
            pcSelect.dispatchEvent(event);
            
            populateActivityResourceSelects();
            document.getElementById('activity-modal').style.display = 'block';
        }

        // PC Numbers filtering functions
        function filterPCNumbers() {
            const companyFilter = document.getElementById('pc-company-filter').value.toLowerCase().trim();
            const contactFilter = document.getElementById('pc-contact-filter').value.toLowerCase().trim();
            
            if (!companyFilter && !contactFilter) {
                // No filters applied - show all
                updatePCList();
                return;
            }
            
            const filteredPCs = db.pcs.filter(pc => {
                const companyMatch = !companyFilter || (pc.company || '').toLowerCase().includes(companyFilter);
                const contactMatch = !contactFilter || (pc.contactPerson || '').toLowerCase().includes(contactFilter);
                
                // Both conditions must be true (AND logic)
                return companyMatch && contactMatch;
            });
            
            updatePCList(filteredPCs);
        }

        function clearPCFilters() {
            document.getElementById('pc-company-filter').value = '';
            document.getElementById('pc-contact-filter').value = '';
            updatePCList();
        }

        // Quotes filtering functions
        function filterQuotes() {
            const companyFilter = document.getElementById('quotes-company-filter').value.toLowerCase().trim();
            
            if (!companyFilter) {
                // No filter applied - show all
                updateQuotesList();
                return;
            }
            
            const filteredQuotes = db.quotes.filter(quote => {
                const pc = db.pcs.find(p => p.id === quote.pcId);
                return pc && (pc.company || '').toLowerCase().includes(companyFilter);
            });
            
            updateQuotesList(filteredQuotes);
        }

        function clearQuotesFilter() {
            document.getElementById('quotes-company-filter').value = '';
            updateQuotesList();
        }

        // Activities filtering functions
        function filterActivitiesByCompany() {
            // This will trigger updateActivitiesList() which now includes company filtering
            updateActivitiesList();
        }

        function clearActivitiesCompanyFilter() {
            document.getElementById('activities-company-filter').value = '';
            updateActivitiesList();
        }

        function createQuote() {
            if (!db.currentPC) return;
            db.quoteItems = { human: [], vehicles: [], materials: [], other: [] };
            db.otherCosts = [];
            db.recyclingCharges = {
                general: { kg: 0, cost: 0 },
                pops: { kg: 0, cost: 0 },
                weee: { option: 'na', cost: 0 }
            };
            document.getElementById('quote-human').innerHTML = '';
            document.getElementById('quote-vehicles').innerHTML = '';
            document.getElementById('quote-materials').innerHTML = '';
            document.getElementById('quote-other').innerHTML = '';
            document.getElementById('quote-other-costs').innerHTML = '';
            document.getElementById('quote-discount').value = 0;
            // Clear recycling charges
            document.getElementById('general-recycling-kg').value = '';
            document.getElementById('pops-recycling-kg').value = '';
            document.getElementById('weee-recycling-option').value = 'na';
            document.getElementById('general-recycling-cost').textContent = '0.00';
            document.getElementById('pops-recycling-cost').textContent = '0.00';
            document.getElementById('weee-recycling-cost').textContent = 'N/A';
            // Clear quote name and description fields
            document.getElementById('quote-name').value = '';
            document.getElementById('quote-description').value = '';
            const priceListSelect = document.getElementById('quote-price-list');
            priceListSelect.innerHTML = '<option value="">Select price list...</option>';
            const activePriceLists = db.priceLists.filter(pl => pl.status === 'active');
            if (activePriceLists.length === 0) {
                priceListSelect.innerHTML = '<option value="">No active price lists - create one first</option>';
                priceListSelect.disabled = true;
            } else {
                priceListSelect.disabled = false;
                activePriceLists.sort((a,b) => a.name.localeCompare(b.name)).forEach(pl => {
                    priceListSelect.innerHTML += `<option value="${pl.id}">${pl.name}</option>`;
                });
            }
            document.getElementById('quote-items-section').style.display = 'none';
            document.getElementById('price-list-selector').style.display = 'block';
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
            showPage('quote-builder');
        }

        function onPriceListChange() {
            const priceListId = document.getElementById('quote-price-list').value;
            const itemsSection = document.getElementById('quote-items-section');
            if (priceListId) {
                const priceList = db.priceLists.find(pl => pl.id === priceListId);
                if (priceList) {
                    db.selectedPriceListId = priceListId;
                    let itemCount = priceList.items ? priceList.items.length : 0;
                    
                    itemsSection.style.display = itemCount > 0 ? 'grid' : 'none';
                    if (itemCount > 0) {
                        const categories = ['human', 'vehicles', 'materials', 'other'];
                        categories.forEach(cat => {
                            const hasItems = priceList.items.some(item => {
                                const resource = db.resources.find(r => r.id === item.resourceId);
                                return resource && resource.category === cat;
                            });
                            const categorySection = document.querySelector(`#quote-${cat}`).closest('.category-section');
                            categorySection.style.display = hasItems ? 'block' : 'none';
                        });
                    }
                }
            } else {
                db.selectedPriceListId = null;
                itemsSection.style.display = 'none';
            }
        }

        function addLineItem(category) {
            if (!db.selectedPriceListId) { alert('Please select a price list first!'); return; }
            const priceList = db.priceLists.find(p => p.id === db.selectedPriceListId);
            if (!priceList) { alert('Selected price list not found!'); return; }
            const categoryItems = [];
            priceList.items.forEach(item => {
                const resource = db.resources.find(r => r.id === item.resourceId);
                if (resource && resource.category === category) {
                    categoryItems.push({ resource: resource, price: item.clientPrice });
                }
            });
            if (categoryItems.length === 0) { alert('No items in this category!'); return; }
            const lineId = 'line' + Date.now();
            const container = document.getElementById('quote-' + category);
            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-item';
            lineDiv.id = lineId;
            let options = '<option value="">Select item...</option>';
            categoryItems.forEach(item => {
                options += `<option value="${item.resource.id}" data-price="${item.price}">${item.resource.name} - ${item.price}/${item.resource.unit}</option>`;
            });
            lineDiv.innerHTML = `<select onchange="window.updateLinePrice('${lineId}', '${category}')">${options}</select><input type="number" value="1" min="1" onchange="window.updateLineQty('${lineId}', '${category}')"><div class="manual-price-control"><input type="number" value="0" step="0.01" oninput="window.updateLineRate('${lineId}', '${category}')" readonly><label><input type="checkbox" onchange="window.toggleManualPrice('${lineId}', '${category}')">Manual</label></div><span class="line-item-unit">-</span><span>0.00</span><button class="remove-btn" onclick="window.removeLine('${lineId}', '${category}')"></button>`;
            container.appendChild(lineDiv);
            db.quoteItems[category].push({ id: lineId, resourceId: '', name: '', qty: 1, rate: 0, unit: '-', total: 0 });
        }

        function toggleManualPrice(lineId, category) {
            const line = document.getElementById(lineId);
            const rateInput = line.querySelector('.manual-price-control input[type="number"]');
            const checkbox = line.querySelector('.manual-price-control input[type="checkbox"]');
            if (checkbox.checked) {
                rateInput.readOnly = false;
                rateInput.focus();
            } else {
                rateInput.readOnly = true;
                const select = line.querySelector('select');
                const option = select.options[select.selectedIndex];
                if (option && option.value) {
                    const price = parseFloat(option.dataset.price || 0);
                    rateInput.value = price;
                    updateLineRate(lineId, category);
                }
            }
        }

        function getResourceRate(resource, date = null, time = null) {
            // If no time-based pricing, return standard netCost
            if (!resource.timeBasedPricing) {
                return resource.netCost;
            }
            
            // If no date/time provided, return standard rate
            if (!date || !time) {
                return resource.standardRate || resource.netCost;
            }
            
            const activityDate = new Date(date);
            const dayOfWeek = activityDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const hour = parseInt(time.split(':')[0]);
            
            // Weekend rates (Friday PM, Saturday, Sunday)
            if (dayOfWeek === 0 || dayOfWeek === 6 || (dayOfWeek === 5 && hour >= 17)) {
                return resource.weekendRate || resource.standardRate || resource.netCost;
            }
            
            // Overtime rates (Monday to Thursday 17:00-08:00, Friday 17:00-08:00)
            if (hour >= 17 || hour < 8) {
                return resource.overtimeRate || resource.standardRate || resource.netCost;
            }
            
            // Standard rates (Monday to Friday 08:00-17:00)
            return resource.standardRate || resource.netCost;
        }

        function updateLinePrice(lineId, category) {
            const line = document.getElementById(lineId);
            const select = line.querySelector('select');
            const option = select.options[select.selectedIndex];
            const price = parseFloat(option.dataset.price || 0);
            const resourceId = select.value;
            const rateInput = line.querySelector('.manual-price-control input[type="number"]');
            const manualCheckbox = line.querySelector('.manual-price-control input[type="checkbox"]');
            rateInput.value = price;
            rateInput.readOnly = true;
            manualCheckbox.checked = false;
            const item = db.quoteItems[category].find(i => i.id === lineId);
            if (item) {
                item.resourceId = resourceId;
                item.name = option.text.split(' - ')[0];
                item.rate = price;
                const resource = db.resources.find(r => r.id === resourceId);
                if (resource) {
                    const unitSpan = line.querySelector('.line-item-unit');
                    unitSpan.textContent = resource.unit;
                    item.unit = resource.unit;
                }
                updateLineQty(lineId, category);
            }
        }

        function updateLineQty(lineId, category) {
            const line = document.getElementById(lineId);
            const qty = parseFloat(line.querySelectorAll('input')[0].value) || 1;
            const rate = parseFloat(line.querySelector('.manual-price-control input[type="number"]').value) || 0;
            const total = qty * rate;
            line.querySelector('span:last-of-type').textContent = '' + total.toFixed(2);
            const item = db.quoteItems[category].find(i => i.id === lineId);
            if (item) {
                item.qty = qty;
                item.rate = rate;
                item.total = total;
            }
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
        }

        function updateLineRate(lineId, category) { updateLineQty(lineId, category); }
        function removeLine(lineId, category) {
            document.getElementById(lineId).remove();
            db.quoteItems[category] = db.quoteItems[category].filter(i => i.id !== lineId);
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
        }
        function addOtherCost() {
            const costId = 'cost' + Date.now();
            const container = document.getElementById('quote-other-costs');
            const costDiv = document.createElement('div');
            costDiv.className = 'line-item';
            costDiv.id = costId;
            costDiv.style.marginBottom = '0.5rem';
            costDiv.innerHTML = `<input type="text" placeholder="Description" onchange="window.updateOtherCost('${costId}')" style="grid-column: 1 / 4;"><input type="number" placeholder="Amount" step="0.01" min="0" onchange="window.updateOtherCost('${costId}')" style="grid-column: 4 / 6;"><button class="remove-btn" onclick="window.removeOtherCost('${costId}')" style="grid-column: 6 / 7;"></button>`;
            container.appendChild(costDiv);
            db.otherCosts.push({ id: costId, description: '', amount: 0 });
        }
        function updateOtherCost(costId) {
            const costDiv = document.getElementById(costId);
            const inputs = costDiv.querySelectorAll('input');
            const description = inputs[0].value;
            const amount = parseFloat(inputs[1].value) || 0;
            const cost = db.otherCosts.find(c => c.id === costId);
            if (cost) {
                cost.description = description;
                cost.amount = amount;
            }
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
        }
        function removeOtherCost(costId) {
            document.getElementById(costId).remove();
            db.otherCosts = db.otherCosts.filter(c => c.id !== costId);
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
        }
        function calculateTotal() {
            let totals = { human: 0, vehicles: 0, materials: 0, other: 0 };
            for (let cat in db.quoteItems) {
                db.quoteItems[cat].forEach(item => { totals[cat] += item.total; });
            }
            let otherCostsTotal = 0;
            db.otherCosts.forEach(cost => { otherCostsTotal += cost.amount; });
            
            // Calculate recycling charges total
            let recyclingTotal = 0;
            if (db.recyclingCharges) {
                recyclingTotal = (db.recyclingCharges.general?.cost || 0) + 
                                (db.recyclingCharges.pops?.cost || 0) + 
                                (db.recyclingCharges.weee?.cost || 0);
            }
            
            // Update individual category totals
            document.getElementById('sum-human').textContent = '' + totals.human.toFixed(2);
            document.getElementById('sum-vehicles').textContent = '' + totals.vehicles.toFixed(2);
            document.getElementById('sum-materials').textContent = '' + totals.materials.toFixed(2);
            document.getElementById('sum-other').textContent = '' + totals.other.toFixed(2);
            document.getElementById('sum-other-costs').textContent = '' + otherCostsTotal.toFixed(2);
            document.getElementById('sum-recycling-charges').textContent = '' + recyclingTotal.toFixed(2);
            
            // Calculate subtotal
            const subtotal = totals.human + totals.vehicles + totals.materials + totals.other + otherCostsTotal + recyclingTotal;
            document.getElementById('sum-subtotal').textContent = '' + subtotal.toFixed(2);
            
            // Apply discount to get net total
            const discount = parseFloat(document.getElementById('quote-discount').value) || 0;
            const netTotal = subtotal * (1 - discount / 100);
            document.getElementById('sum-net-total').textContent = '' + netTotal.toFixed(2);
            
            // Calculate VAT
            const vatRate = parseFloat(document.getElementById('quote-vat').value) || 0;
            const vatAmount = netTotal * (vatRate / 100);
            document.getElementById('sum-vat-amount').textContent = '' + vatAmount.toFixed(2);
            
            // Calculate final total with VAT
            const finalTotal = netTotal + vatAmount;
            document.getElementById('sum-total').textContent = '' + finalTotal.toFixed(2);
        }
        
        // Update Standard Liability field formatting
        function updateStandardLiability() {
            const liability = parseFloat(document.getElementById('quote-standard-liability').value) || 0;
            // Format as currency display (optional enhancement)
            console.log('Standard Liability updated to: ' + liability.toLocaleString());
        }
        
        // Calculate recycling charges
        function calculateRecyclingCharges() {
            // General Recycling: 250/tonne
            const generalKg = parseFloat(document.getElementById('general-recycling-kg').value) || 0;
            const generalCost = (generalKg / 1000) * 250; // Convert kg to tonnes
            document.getElementById('general-recycling-cost').textContent = '' + generalCost.toFixed(2);
            
            // POPS Recycling: 395/tonne
            const popsKg = parseFloat(document.getElementById('pops-recycling-kg').value) || 0;
            const popsCost = (popsKg / 1000) * 395; // Convert kg to tonnes
            document.getElementById('pops-recycling-cost').textContent = '' + popsCost.toFixed(2);
            
            // WEEE Recycling: Based on selection
            const weeeOption = document.getElementById('weee-recycling-option').value;
            let weeeCost = 0;
            let weeeDisplay = 'N/A';
            
            switch(weeeOption) {
                case 'na':
                    weeeDisplay = 'N/A';
                    weeeCost = 0;
                    break;
                case 'included':
                    weeeDisplay = 'Included';
                    weeeCost = 0;
                    break;
                case 'quote':
                    weeeDisplay = 'Quote on Request';
                    weeeCost = 0;
                    break;
            }
            document.getElementById('weee-recycling-cost').textContent = weeeDisplay;
            
            // Store recycling charges for total calculation
            if (!db.recyclingCharges) db.recyclingCharges = {};
            db.recyclingCharges.general = { kg: generalKg, cost: generalCost };
            db.recyclingCharges.pops = { kg: popsKg, cost: popsCost };
            db.recyclingCharges.weee = { option: weeeOption, cost: weeeCost };
            
            // Update total recycling charges
            const totalRecycling = generalCost + popsCost + weeeCost;
            document.getElementById('sum-recycling-charges').textContent = '' + totalRecycling.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
        }
        
        // ========================================
        // QUOTES MANAGEMENT
        // ========================================
        
        function saveQuote() {
            if (!db.currentPC) return;
            if (!db.selectedPriceListId) { alert('Please select a price list!'); return; }
            const hasItems = Object.values(db.quoteItems).some(cat => cat.length > 0);
            if (!hasItems && db.otherCosts.length === 0) { alert('Please add at least one item!'); return; }
            
            let savedQuote;
            
            if (db.editingQuote) {
                // Editing existing quote
                db.editingQuote.priceListId = db.selectedPriceListId;
                db.editingQuote.name = document.getElementById('quote-name').value.trim();
                db.editingQuote.description = document.getElementById('quote-description').value.trim();
                db.editingQuote.items = JSON.parse(JSON.stringify(db.quoteItems));
                db.editingQuote.otherCosts = JSON.parse(JSON.stringify(db.otherCosts));
                db.editingQuote.recyclingCharges = JSON.parse(JSON.stringify(db.recyclingCharges));
                db.editingQuote.discount = parseFloat(document.getElementById('quote-discount').value) || 0;
                db.editingQuote.vatRate = parseFloat(document.getElementById('quote-vat').value) || 0;
                db.editingQuote.vatAmount = parseFloat(document.getElementById('sum-vat-amount').textContent.replace('', ''));
                db.editingQuote.netTotal = parseFloat(document.getElementById('sum-net-total').textContent.replace('', ''));
                db.editingQuote.standardLiability = parseFloat(document.getElementById('quote-standard-liability').value) || 0;
                db.editingQuote.declaredValue = parseFloat(document.getElementById('quote-declared-value').value) || 0;
                db.editingQuote.total = parseFloat(document.getElementById('sum-total').textContent.replace('', ''));
                db.editingQuote.updated = new Date().toISOString();
                saveData();
                alert('Quote ' + db.editingQuote.number + ' updated successfully!');
                savedQuote = db.editingQuote;
                db.editingQuote = null;
                db.selectedPriceListId = null;
            } else {
                // Creating new quote
                const pcQuotes = db.quotes.filter(q => q.pcId === db.currentPC.id);
                const quote = {
                    id: 'Q' + Date.now(),
                    number: 'Q-' + String(db.quotes.length + 1).padStart(6, '0'),
                    pcId: db.currentPC.id,
                    priceListId: db.selectedPriceListId,
                    name: document.getElementById('quote-name').value.trim(),
                    description: document.getElementById('quote-description').value.trim(),
                    version: pcQuotes.length + 1,
                    items: JSON.parse(JSON.stringify(db.quoteItems)),
                    otherCosts: JSON.parse(JSON.stringify(db.otherCosts)),
                    recyclingCharges: JSON.parse(JSON.stringify(db.recyclingCharges)),
                    discount: parseFloat(document.getElementById('quote-discount').value) || 0,
                    vatRate: parseFloat(document.getElementById('quote-vat').value) || 0,
                    vatAmount: parseFloat(document.getElementById('sum-vat-amount').textContent.replace('', '')),
                    netTotal: parseFloat(document.getElementById('sum-net-total').textContent.replace('', '')),
                    standardLiability: parseFloat(document.getElementById('quote-standard-liability').value) || 0,
                    declaredValue: parseFloat(document.getElementById('quote-declared-value').value) || 0,
                    total: parseFloat(document.getElementById('sum-total').textContent.replace('', '')),
                    status: 'Draft',
                    created: new Date().toISOString()
                };
                db.quotes.push(quote);
                saveData();
                alert('Quote ' + quote.number + ' created successfully!');
                savedQuote = quote;
                db.selectedPriceListId = null;
            }
            
            // Navigate to quote detail view instead of PC view
            viewQuote(savedQuote.id);
        }
        function cancelQuote() {
            if (confirm('Cancel this quote?')) {
                db.editingQuote = null;
                db.selectedPriceListId = null;
                db.otherCosts = [];
                db.recyclingCharges = {
                    general: { kg: 0, cost: 0 },
                    pops: { kg: 0, cost: 0 },
                    weee: { option: 'na', cost: 0 }
                };
                // Clear quote name and description fields
                document.getElementById('quote-name').value = '';
                document.getElementById('quote-description').value = '';
                if (db.currentPC) viewPC(db.currentPC.id);
                else showPage('quotes');
            }
        }
        function updateQuotesList(filteredQuotes = null) {
            const tbody = document.getElementById('quotes-list');
            const resultsCount = document.getElementById('quotes-results-count');
            
            const quotesToShow = filteredQuotes || db.quotes || [];
            
            tbody.innerHTML = '';
            if (db.quotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No quotes yet</td></tr>';
                if (resultsCount) resultsCount.textContent = '';
            } else if (quotesToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No quotes match your search criteria</td></tr>';
                if (resultsCount) resultsCount.textContent = 'No results';
            } else {
                quotesToShow.forEach(q => {
                    const pc = db.pcs.find(p => p.id === q.pcId);
                    
                    // Count activities for this quote
                    const activitiesCount = (db.activities || []).filter(a => a.quoteId === q.id).length;
                    
                    // Create clickable activities count cell
                    const activitiesCell = activitiesCount > 0 
                        ? `<td><a href="#" onclick="window.goToActivitiesForQuote('${q.id}'); return false;" style="color: #e74c3c; text-decoration: none; font-weight: bold;">${activitiesCount}</a></td>`
                        : `<td style="color: #999;">0</td>`;
                    
                    // Display quote name or "-" if empty
                    const quoteName = q.name ? q.name : '-';
                    
                    tbody.innerHTML += `<tr><td>${q.number}</td><td>${quoteName}</td><td>${pc ? pc.number : '-'}</td><td>${pc ? pc.company : '-'}</td><td>${q.total.toFixed(2)}</td><td>${q.status}</td>${activitiesCell}<td><div class="action-btn-group"><button onclick="window.viewQuote('${q.id}')">View</button><button onclick="window.editQuoteFromList('${q.id}')" class="warning">Edit</button><button onclick="window.createActivityFromQuoteList('${q.id}')" class="success">Add Activity</button></div></td></tr>`;
                });
                
                // Update results counter
                if (resultsCount) {
                    const totalCount = db.quotes.length;
                    const showingCount = quotesToShow.length;
                    if (showingCount === totalCount) {
                        resultsCount.textContent = `Showing all ${totalCount} quotes`;
                    } else {
                        resultsCount.textContent = `Showing ${showingCount} of ${totalCount} quotes`;
                    }
                }
            }
        }
        function showNewQuoteModal() {
            // Populate company select
            const companySelect = document.getElementById('quote-modal-company');
            companySelect.innerHTML = '<option value="">All companies - show all PC Numbers</option>';
            
            // Get unique companies from PC Numbers, sorted alphabetically
            const companies = [...new Set(db.pcs.map(pc => pc.company))].sort();
            companies.forEach(company => {
                companySelect.innerHTML += `<option value="${company}">${company}</option>`;
            });
            
            // Populate PC select with all PC Numbers initially
            const pcSelect = document.getElementById('quote-modal-pc');
            pcSelect.innerHTML = '<option value="">Select PC Number...</option>';
            if (db.pcs && Array.isArray(db.pcs)) {
                db.pcs.forEach(pc => {
                    pcSelect.innerHTML += `<option value="${pc.id}">${pc.number} - ${pc.company}</option>`;
                });
            }
            
            document.getElementById('quote-modal-pc-info').style.display = 'none';
            document.getElementById('quote-modal').classList.add('active');
            
            // Force modal visibility
            const modal = document.getElementById('quote-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '9999';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
            }        }
        function closeQuoteModal() { 
    const modal = document.getElementById('quote-modal'); 
    modal.classList.remove('active'); 
    modal.style.display = 'none'; 
    modal.style.cssText = 'display: none !important;'; 
}
        document.getElementById('quote-modal-pc').addEventListener('change', function() {
            const pcId = this.value;
            const infoDiv = document.getElementById('quote-modal-pc-info');
            if (pcId) {
                const pc = db.pcs.find(p => p.id === pcId);
                if (pc) {
                    infoDiv.innerHTML = `<strong>${pc.company}</strong><br>Reference: ${pc.reference || 'N/A'}<br>Contact: ${pc.contactPerson || 'N/A'}<br>Mobile Phone: ${pc.mobilePhone || 'N/A'}<br>Email: ${pc.email || 'N/A'}`;
                    infoDiv.style.display = 'block';
                }
            } else {
                infoDiv.style.display = 'none';
            }
        });
        function proceedToQuoteBuilder() {
            const pcId = document.getElementById('quote-modal-pc').value;
            if (!pcId) { alert('Please select a PC Number!'); return; }
            const pc = db.pcs.find(p => p.id === pcId);
            if (pc) {
                db.currentPC = pc;
                closeQuoteModal();
                createQuote();
            }
        }
        function viewQuote(id) {
            const quote = db.quotes.find(q => q.id === id);
            if (!quote) return;
            db.currentQuote = quote;
            const pc = db.pcs.find(p => p.id === quote.pcId);
            document.getElementById('quote-detail-title').textContent = quote.number + ' - ' + (pc ? pc.company : 'Unknown');
            const priceList = db.priceLists.find(pl => pl.id === quote.priceListId);
            const nameInfo = quote.name ? `<p><strong>Quote Name:</strong> ${quote.name}</p>` : '';
            const descriptionInfo = quote.description ? `<p><strong>Description:</strong> ${quote.description}</p>` : '';
            document.getElementById('quote-detail-info').innerHTML = `<p><strong>Quote Number:</strong> ${quote.number}</p>${nameInfo}${descriptionInfo}<p><strong>PC Number:</strong> ${pc ? pc.number : '-'}</p><p><strong>Company:</strong> ${pc ? pc.company : '-'}</p><p><strong>Version:</strong> ${quote.version}</p><p><strong>Status:</strong> ${quote.status}</p><p><strong>Created:</strong> ${formatDateTime(quote.created)}</p><p><strong>Price List:</strong> ${priceList ? priceList.name : 'Not specified'}</p><p><strong>Discount:</strong> ${quote.discount || 0}%</p><p><strong>VAT Rate:</strong> ${quote.vatRate || 20}%</p><p><strong>Net Total:</strong> ${(quote.netTotal || 0).toFixed(2)}</p><p><strong>VAT Amount:</strong> ${(quote.vatAmount || 0).toFixed(2)}</p><p><strong>Total Value (inc. VAT):</strong> ${quote.total.toFixed(2)}</p><p><strong>Standard Liability:</strong> ${(quote.standardLiability || 100000).toLocaleString()}</p><p><strong>Declared Value:</strong> ${(quote.declaredValue || 0).toLocaleString()}</p>`;
            
            const contactHTML = `
                <p><strong>Contact:</strong> ${pc.contactPerson}</p>
                <p><strong>Mobile:</strong> ${pc.mobilePhone || '-'}</p>
                <p><strong>Email:</strong> ${pc.email}</p>
                <p><strong>Address:</strong> ${pc.address}</p>
            `;
            if (document.getElementById('quote-detail-contact')) {
                document.getElementById('quote-detail-contact').innerHTML = contactHTML;
            }
            let itemsHtml = '';
            const categories = ['human', 'vehicles', 'materials', 'other'];
            categories.forEach(cat => {
                if (quote.items[cat] && quote.items[cat].length > 0) {
                    itemsHtml += `<h4 style="margin-top: 1rem; text-transform: capitalize;">${cat === 'human' ? 'Human Resources' : cat}</h4>`;
                    itemsHtml += '<table><thead><tr><th>Item</th><th>Quantity</th><th>Rate</th><th>Unit</th><th>Total</th></tr></thead><tbody>';
                    quote.items[cat].forEach(item => {
                        if (item.name && item.total >= 0) {
                            itemsHtml += `<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.rate.toFixed(2)}</td><td>${item.unit}</td><td>${item.total.toFixed(2)}</td></tr>`;
                        }
                    });
                    itemsHtml += '</tbody></table>';
                }
            });
            if (quote.otherCosts && quote.otherCosts.length > 0) {
                itemsHtml += '<h4 style="margin-top: 1rem;">Other Costs</h4>';
                itemsHtml += '<table><thead><tr><th>Description</th><th>Amount</th></tr></thead><tbody>';
                quote.otherCosts.forEach(cost => {
                    if (cost.description && cost.amount > 0) {
                        itemsHtml += `<tr><td>${cost.description}</td><td>${cost.amount.toFixed(2)}</td></tr>`;
                    }
                });
                itemsHtml += '</tbody></table>';
            }
            document.getElementById('quote-items-detail').innerHTML = itemsHtml || '<p>No items in this quote</p>';
            let categoryTotals = { human: 0, vehicles: 0, materials: 0, other: 0 };
            categories.forEach(cat => {
                if (quote.items[cat]) {
                    quote.items[cat].forEach(item => { categoryTotals[cat] += item.total || 0; });
                }
            });
            let otherCostsTotal = 0;
            if (quote.otherCosts) {
                quote.otherCosts.forEach(cost => { otherCostsTotal += cost.amount || 0; });
            }
            const subtotal = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0) + otherCostsTotal;
            document.getElementById('quote-summary-detail').innerHTML = `<div class="summary-line"><span>Human Resources:</span><span>${categoryTotals.human.toFixed(2)}</span></div><div class="summary-line"><span>Vehicles:</span><span>${categoryTotals.vehicles.toFixed(2)}</span></div><div class="summary-line"><span>Materials:</span><span>${categoryTotals.materials.toFixed(2)}</span></div><div class="summary-line"><span>Other:</span><span>${categoryTotals.other.toFixed(2)}</span></div>${otherCostsTotal > 0 ? `<div class="summary-line"><span>Other Costs:</span><span>${otherCostsTotal.toFixed(2)}</span></div>` : ''}<div class="summary-line"><span>Subtotal:</span><span>${subtotal.toFixed(2)}</span></div><div class="summary-line"><span>Discount (${quote.discount || 0}%):</span><span>-${(subtotal * (quote.discount || 0) / 100).toFixed(2)}</span></div><div class="summary-total"><span>Total:</span><span>${quote.total.toFixed(2)}</span></div>`;
            showPage('quote-detail');
        }
        function changeQuoteStatus() {
            if (!db.currentQuote) return;
            const newStatus = document.getElementById('quote-status-select').value;
            db.currentQuote.status = newStatus;
            saveData();
            alert('Quote status changed to ' + newStatus);
            viewQuote(db.currentQuote.id);
        }
        function editQuote() {
            if (!db.currentQuote) return;
            db.editingQuote = db.currentQuote;
            const pc = db.pcs.find(p => p.id === db.currentQuote.pcId);
            if (pc) db.currentPC = pc;
            db.selectedPriceListId = db.currentQuote.priceListId || null;
            db.quoteItems = JSON.parse(JSON.stringify(db.currentQuote.items));
            db.otherCosts = db.currentQuote.otherCosts ? JSON.parse(JSON.stringify(db.currentQuote.otherCosts)) : [];
            db.recyclingCharges = db.currentQuote.recyclingCharges ? JSON.parse(JSON.stringify(db.currentQuote.recyclingCharges)) : {
                general: { kg: 0, cost: 0 },
                pops: { kg: 0, cost: 0 },
                weee: { option: 'na', cost: 0 }
            };
            showPage('quote-builder');
            setTimeout(() => {
                // Fill in quote name and description
                document.getElementById('quote-name').value = db.currentQuote.name || '';
                document.getElementById('quote-description').value = db.currentQuote.description || '';
                
                // Fill in new fields
                document.getElementById('quote-discount').value = db.currentQuote.discount || 0;
                document.getElementById('quote-vat').value = db.currentQuote.vatRate || 20;
                document.getElementById('quote-standard-liability').value = db.currentQuote.standardLiability || 100000;
                document.getElementById('quote-declared-value').value = db.currentQuote.declaredValue || 0;
                
                if (db.selectedPriceListId) {
                    document.getElementById('quote-price-list').value = db.selectedPriceListId;
                    onPriceListChange();
                    setTimeout(() => rebuildQuoteForm(), 100);
                }
            }, 100);
        }
        function editQuoteFromList(id) { viewQuote(id); setTimeout(() => editQuote(), 100); }
        function duplicateQuote() {
            if (!db.currentQuote) return;
            const pc = db.pcs.find(p => p.id === db.currentQuote.pcId);
            if (pc) db.currentPC = pc;
            db.quoteItems = JSON.parse(JSON.stringify(db.currentQuote.items));
            db.otherCosts = db.currentQuote.otherCosts ? JSON.parse(JSON.stringify(db.currentQuote.otherCosts)) : [];
            db.selectedPriceListId = db.currentQuote.priceListId || null;
            db.editingQuote = null;
            showPage('quote-builder');
            setTimeout(() => {
                // Fill in quote name and description with "Copy" suffix
                const originalName = db.currentQuote.name || '';
                const originalDescription = db.currentQuote.description || '';
                document.getElementById('quote-name').value = originalName ? originalName + ' (Copy)' : 'Copy of Quote';
                document.getElementById('quote-description').value = originalDescription || '';
                
                if (db.selectedPriceListId) {
                    document.getElementById('quote-price-list').value = db.selectedPriceListId;
                    onPriceListChange();
                    setTimeout(() => rebuildQuoteForm(), 100);
                }
            }, 100);
        }
        function createActivityFromQuoteList(quoteId) {
            const quote = db.quotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            const pc = db.pcs.find(p => p.id === quote.pcId);
            if (!pc) return;
            
            // Set current quote and PC for context
            db.currentQuote = quote;
            db.currentPC = pc;
            
            // Show activity modal
            showActivityModal();
            
            // Pre-fill form fields
            setTimeout(() => {
                // Set PC Number
                const pcSelect = document.getElementById('activity-pc-select');
                if (pcSelect) {
                    pcSelect.value = pc.id;
                    // Trigger change event to populate quote dropdown
                    pcSelect.dispatchEvent(new Event('change'));
                }
                
                // Set Quote (after PC is set)
                setTimeout(() => {
                    const quoteSelect = document.getElementById('activity-quote');
                    if (quoteSelect) {
                        quoteSelect.value = quote.id;
                    }
                }, 100);
                
                // Set default activity type
                const typeSelect = document.getElementById('activity-type');
                if (typeSelect) {
                    typeSelect.value = 'Move';
                }
                
                // Pre-fill activity name based on quote
                const nameInput = document.getElementById('activity-name');
                if (nameInput) {
                    const quoteName = quote.name ? quote.name : 'Move';
                    nameInput.value = `${quoteName} - ${pc.company}`;
                }
                
                // Pre-fill collection details from PC
                const collectionFirstName = document.getElementById('activity-collection-firstname');
                const collectionLastName = document.getElementById('activity-collection-lastname');
                const collectionEmail = document.getElementById('activity-collection-email');
                const collectionPhone = document.getElementById('activity-collection-phone');
                
                if (collectionFirstName && pc.collectionFirstName) {
                    collectionFirstName.value = pc.collectionFirstName;
                }
                if (collectionLastName && pc.collectionSurname) {
                    collectionLastName.value = pc.collectionSurname;
                }
                if (collectionEmail && pc.collectionEmail) {
                    collectionEmail.value = pc.collectionEmail;
                }
                if (collectionPhone && pc.collectionPhone) {
                    collectionPhone.value = pc.collectionPhone;
                }
                
                // Pre-fill delivery details from PC
                const deliveryFirstName = document.getElementById('activity-delivery-firstname');
                const deliveryLastName = document.getElementById('activity-delivery-lastname');
                const deliveryEmail = document.getElementById('activity-delivery-email');
                const deliveryPhone = document.getElementById('activity-delivery-phone');
                
                if (deliveryFirstName && pc.deliveryFirstName) {
                    deliveryFirstName.value = pc.deliveryFirstName;
                }
                if (deliveryLastName && pc.deliverySurname) {
                    deliveryLastName.value = pc.deliverySurname;
                }
                if (deliveryEmail && pc.deliveryEmail) {
                    deliveryEmail.value = pc.deliveryEmail;
                }
                if (deliveryPhone && pc.deliveryPhone) {
                    deliveryPhone.value = pc.deliveryPhone;
                }
                
                // Pre-fill addresses
                const collectionAddress = document.getElementById('activity-collection-address');
                const deliveryAddress = document.getElementById('activity-delivery-address');
                
                if (collectionAddress && pc.collectionAddress1) {
                    const collectionAddr = [
                        pc.collectionAddress1,
                        pc.collectionAddress2,
                        pc.collectionAddress3,
                        pc.collectionAddress4
                    ].filter(addr => addr).join(', ');
                    collectionAddress.value = collectionAddr;
                }
                
                if (deliveryAddress && pc.deliveryAddress1) {
                    const deliveryAddr = [
                        pc.deliveryAddress1,
                        pc.deliveryAddress2,
                        pc.deliveryAddress3,
                        pc.deliveryAddress4
                    ].filter(addr => addr).join(', ');
                    deliveryAddress.value = deliveryAddr;
                }
                
                // Set default date to today
                const dateInput = document.getElementById('activity-date');
                if (dateInput) {
                    const today = new Date().toISOString().split('T')[0];
                    dateInput.value = today;
                }
                
                // Set default status
                const statusSelect = document.getElementById('activity-status');
                if (statusSelect) {
                    statusSelect.value = 'Pending';
                }
                
            }, 200);
        }
        
        function createActivityFromCurrentQuote() {
            if (!db.currentQuote) return;
            
            const pc = db.pcs.find(p => p.id === db.currentQuote.pcId);
            if (!pc) return;
            
            // Set current PC for context
            db.currentPC = pc;
            
            // Show activity modal
            showActivityModal();
            
            // Pre-fill form fields
            setTimeout(() => {
                // Set PC Number
                const pcSelect = document.getElementById('activity-pc-select');
                if (pcSelect) {
                    pcSelect.value = pc.id;
                    // Trigger change event to populate quote dropdown
                    pcSelect.dispatchEvent(new Event('change'));
                }
                
                // Set Quote (after PC is set)
                setTimeout(() => {
                    const quoteSelect = document.getElementById('activity-quote');
                    if (quoteSelect) {
                        quoteSelect.value = db.currentQuote.id;
                    }
                }, 100);
                
                // Set default activity type
                const typeSelect = document.getElementById('activity-type');
                if (typeSelect) {
                    typeSelect.value = 'Move';
                }
                
                // Pre-fill activity name based on quote
                const nameInput = document.getElementById('activity-name');
                if (nameInput) {
                    const quoteName = db.currentQuote.name ? db.currentQuote.name : 'Move';
                    nameInput.value = `${quoteName} - ${pc.company}`;
                }
                
                // Pre-fill collection details from PC
                const collectionFirstName = document.getElementById('activity-collection-firstname');
                const collectionLastName = document.getElementById('activity-collection-lastname');
                const collectionEmail = document.getElementById('activity-collection-email');
                const collectionPhone = document.getElementById('activity-collection-phone');
                
                if (collectionFirstName && pc.collectionFirstName) {
                    collectionFirstName.value = pc.collectionFirstName;
                }
                if (collectionLastName && pc.collectionSurname) {
                    collectionLastName.value = pc.collectionSurname;
                }
                if (collectionEmail && pc.collectionEmail) {
                    collectionEmail.value = pc.collectionEmail;
                }
                if (collectionPhone && pc.collectionPhone) {
                    collectionPhone.value = pc.collectionPhone;
                }
                
                // Pre-fill delivery details from PC
                const deliveryFirstName = document.getElementById('activity-delivery-firstname');
                const deliveryLastName = document.getElementById('activity-delivery-lastname');
                const deliveryEmail = document.getElementById('activity-delivery-email');
                const deliveryPhone = document.getElementById('activity-delivery-phone');
                
                if (deliveryFirstName && pc.deliveryFirstName) {
                    deliveryFirstName.value = pc.deliveryFirstName;
                }
                if (deliveryLastName && pc.deliverySurname) {
                    deliveryLastName.value = pc.deliverySurname;
                }
                if (deliveryEmail && pc.deliveryEmail) {
                    deliveryEmail.value = pc.deliveryEmail;
                }
                if (deliveryPhone && pc.deliveryPhone) {
                    deliveryPhone.value = pc.deliveryPhone;
                }
                
                // Pre-fill addresses
                const collectionAddress = document.getElementById('activity-collection-address');
                const deliveryAddress = document.getElementById('activity-delivery-address');
                
                if (collectionAddress && pc.collectionAddress1) {
                    const collectionAddr = [
                        pc.collectionAddress1,
                        pc.collectionAddress2,
                        pc.collectionAddress3,
                        pc.collectionAddress4
                    ].filter(addr => addr).join(', ');
                    collectionAddress.value = collectionAddr;
                }
                
                if (deliveryAddress && pc.deliveryAddress1) {
                    const deliveryAddr = [
                        pc.deliveryAddress1,
                        pc.deliveryAddress2,
                        pc.deliveryAddress3,
                        pc.deliveryAddress4
                    ].filter(addr => addr).join(', ');
                    deliveryAddress.value = deliveryAddr;
                }
                
                // Set default date to today
                const dateInput = document.getElementById('activity-date');
                if (dateInput) {
                    const today = new Date().toISOString().split('T')[0];
                    dateInput.value = today;
                }
                
                // Set default status
                const statusSelect = document.getElementById('activity-status');
                if (statusSelect) {
                    statusSelect.value = 'Pending';
                }
                
            }, 200);
        }
        function rebuildQuoteForm() {
            document.getElementById('quote-human').innerHTML = '';
            document.getElementById('quote-vehicles').innerHTML = '';
            document.getElementById('quote-materials').innerHTML = '';
            document.getElementById('quote-other').innerHTML = '';
            document.getElementById('quote-other-costs').innerHTML = '';
            if (db.editingQuote) {
                document.getElementById('quote-discount').value = db.editingQuote.discount || 0;
                // Fill in quote name and description
                document.getElementById('quote-name').value = db.editingQuote.name || '';
                document.getElementById('quote-description').value = db.editingQuote.description || '';
            }
            const categories = ['human', 'vehicles', 'materials', 'other'];
            categories.forEach(category => {
                if (db.quoteItems[category]) {
                    db.quoteItems[category].forEach(item => {
                        if (item.name || item.resourceId) addLineItemWithData(category, item);
                    });
                }
            });
            if (db.otherCosts && db.otherCosts.length > 0) {
                db.otherCosts.forEach(cost => {
                    const costDiv = document.createElement('div');
                    costDiv.className = 'line-item';
                    costDiv.id = cost.id;
                    costDiv.style.marginBottom = '0.5rem';
                    costDiv.innerHTML = `<input type="text" placeholder="Description" value="${cost.description}" onchange="window.updateOtherCost('${cost.id}')" style="grid-column: 1 / 4;"><input type="number" placeholder="Amount" step="0.01" min="0" value="${cost.amount}" onchange="window.updateOtherCost('${cost.id}')" style="grid-column: 4 / 6;"><button class="remove-btn" onclick="window.removeOtherCost('${cost.id}')" style="grid-column: 6 / 7;"></button>`;
                    document.getElementById('quote-other-costs').appendChild(costDiv);
                });
            }
            calculateTotal();
            showPage('quote-builder');
        }
        
        // Calculate rebates
        function calculateRebates() {
            // Furniture Resale: Custom rate per tonne
            const furnitureKg = parseFloat(document.getElementById('furniture-rebate-kg').value) || 0;
            const furnitureRate = parseFloat(document.getElementById('furniture-rebate-rate').value) || 0;
            const furnitureCost = (furnitureKg / 1000) * furnitureRate; // Convert kg to tonnes
            document.getElementById('furniture-rebate-cost').textContent = '' + furnitureCost.toFixed(2);
            
            // IT Resale: Custom rate per tonne
            const itKg = parseFloat(document.getElementById('it-rebate-kg').value) || 0;
            const itRate = parseFloat(document.getElementById('it-rebate-rate').value) || 0;
            const itCost = (itKg / 1000) * itRate; // Convert kg to tonnes
            document.getElementById('it-rebate-cost').textContent = '' + itCost.toFixed(2);
            
            // Metal Recycling: Custom rate per tonne
            const metalKg = parseFloat(document.getElementById('metal-rebate-kg').value) || 0;
            const metalRate = parseFloat(document.getElementById('metal-rebate-rate').value) || 0;
            const metalCost = (metalKg / 1000) * metalRate; // Convert kg to tonnes
            document.getElementById('metal-rebate-cost').textContent = '' + metalCost.toFixed(2);
            
            // Store rebates for total calculation
            if (!db.rebates) db.rebates = {};
            db.rebates.furniture = { kg: furnitureKg, rate: furnitureRate, cost: furnitureCost };
            db.rebates.it = { kg: itKg, rate: itRate, cost: itCost };
            db.rebates.metal = { kg: metalKg, rate: metalRate, cost: metalCost };
            
            // Update total rebates
            const totalRebates = furnitureCost + itCost + metalCost;
            document.getElementById('sum-rebates').textContent = '-' + totalRebates.toFixed(2);
            
            // Recalculate totals
            calculateTotal();
            showPage('quote-builder');
        }
        function addLineItemWithData(category, itemData) {
            if (!db.selectedPriceListId) return;
            const priceList = db.priceLists.find(p => p.id === db.selectedPriceListId);
            if (!priceList) return;
            const lineId = itemData.id || 'line' + Date.now();
            const container = document.getElementById('quote-' + category);
            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-item';
            lineDiv.id = lineId;
            let options = '<option value="">Select item...</option>';
            const categoryItems = [];
            priceList.items.forEach(item => {
                const resource = db.resources.find(r => r.id === item.resourceId);
                if (resource && resource.category === category) {
                    categoryItems.push({ resource: resource, price: item.clientPrice });
                }
            });
            categoryItems.forEach(item => {
                const selected = (itemData.resourceId && item.resource.id === itemData.resourceId) || (!itemData.resourceId && item.resource.name === itemData.name) ? 'selected' : '';
                options += `<option value="${item.resource.id}" data-price="${item.price}" ${selected}>${item.resource.name} - ${item.price}/${item.resource.unit}</option>`;
            });
            const resource = db.resources.find(r => r.id === itemData.resourceId);
            const priceFromList = resource ? (priceList.items.find(i => i.resourceId === resource.id)?.clientPrice || 0) : 0;
            const isManual = itemData.rate !== priceFromList;
            lineDiv.innerHTML = `<select onchange="window.updateLinePrice('${lineId}', '${category}')">${options}</select><input type="number" value="${itemData.qty}" min="1" onchange="window.updateLineQty('${lineId}', '${category}')"><div class="manual-price-control"><input type="number" value="${itemData.rate}" step="0.01" oninput="window.updateLineRate('${lineId}', '${category}')" ${!isManual ? 'readonly' : ''}><label><input type="checkbox" onchange="window.toggleManualPrice('${lineId}', '${category}')" ${isManual ? 'checked' : ''}>Manual</label></div><span class="line-item-unit">${itemData.unit}</span><span>${itemData.total.toFixed(2)}</span><button class="remove-btn" onclick="window.removeLine('${lineId}', '${category}')"></button>`;
            container.appendChild(lineDiv);
            const existingIndex = db.quoteItems[category].findIndex(i => i.id === itemData.id);
            if (existingIndex >= 0) db.quoteItems[category][existingIndex].id = lineId;
        }
        
        // --- ACTIVITY FUNCTIONS (FULL) ---
        function showActivityModal() {
            db.editingActivity = null;
            const title = document.getElementById('activity-modal-title');
            const modal = document.getElementById('activity-modal');
            const quoteSelect = document.getElementById('activity-quote');
            
            if (title) title.textContent = 'New Activity';
            clearActivityForm();
            
            // Initialize client and PC lists
            populateActivityClientList();
            populateActivityPCList();
            
            if (quoteSelect) {
                quoteSelect.innerHTML = '<option value="">Select quote...</option>';
                if (db.currentPC) {
                    const quotes = db.quotes.filter(q => q.pcId === db.currentPC.id);
                    if (quotes.length === 0) {
                        quoteSelect.innerHTML = '<option value="">No quotes available - create a quote first</option>';
                        quoteSelect.disabled = true;
                    } else {
                        quoteSelect.disabled = false;
                        quotes.forEach(q => {
                            const quoteName = q.name ? ` (${q.name})` : '';
                            quoteSelect.innerHTML += `<option value="${q.id}">${q.number}${quoteName} - ${q.total.toFixed(2)}</option>`;
                        });
                        
                        // Auto-select quote if there's only one or if currentQuote is set
                        if (db.currentQuote && quotes.find(q => q.id === db.currentQuote.id)) {
                            quoteSelect.value = db.currentQuote.id;
                        } else if (quotes.length === 1) {
                            quoteSelect.value = quotes[0].id;
                        }
                    }
                    
                    // Pre-fill PC Number if currentPC is set
                    setTimeout(() => {
                        const pcSelect = document.getElementById('activity-pc-select');
                        if (pcSelect && db.currentPC) {
                            pcSelect.value = db.currentPC.id;
                            // Trigger change event to populate quote dropdown
                            pcSelect.dispatchEvent(new Event('change'));
                            
                            // Re-apply quote selection after PC change event
                            setTimeout(() => {
                                if (db.currentQuote && quotes.find(q => q.id === db.currentQuote.id)) {
                                    quoteSelect.value = db.currentQuote.id;
                                } else if (quotes.length === 1) {
                                    quoteSelect.value = quotes[0].id;
                                }
                            }, 50);
                        }
                    }, 100);
                }
            }
            populateActivityResourceSelects();
            if (modal) modal.style.display = 'block';
        }
        function showActivityModalFromList() {
            db.editingActivity = null;
            const title = document.getElementById('activity-modal-title');
            const modal = document.getElementById('activity-modal');
            
            if (title) title.textContent = 'New Activity';
            
            // Initialize client and PC lists
            populateActivityClientList();
            populateActivityPCList();
            
            clearActivityForm();
            populateActivityResourceSelects();
            if (modal) modal.style.display = 'block';
        }
        function populateActivityResourceSelects() {
            const categories = ['vehicles', 'human', 'materials', 'crates', 'other'];
            categories.forEach(category => {
                const grid = document.getElementById(`${category}-resources-grid`);
                if(grid){
                    const selects = grid.querySelectorAll('.resource-select');
                    selects.forEach(select => {
                        select.innerHTML = `<option value="">Select ${category}...</option>`;
                        const categoryResources = db.resources.filter(r => (r.category === 'equipment' ? 'other' : r.category) === category);
                        categoryResources.forEach(resource => {
                            select.innerHTML += `<option value="${resource.id}">${resource.name}</option>`;
                        });
                    });
                }
            });
        }
        
        // New functions for client and PC Number handling
        function populateActivityClientList() {
            const clientList = document.getElementById('activity-client-list');
            if (!clientList) return;
            
            const uniqueClients = [...new Set(db.pcs.map(pc => pc.company).filter(company => company))];
            clientList.innerHTML = '';
            uniqueClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                clientList.appendChild(option);
            });
        }
        
        function populateActivityPCList(selectedClient = null) {
            const pcSelect = document.getElementById('activity-pc-select');
            if (!pcSelect) return;
            
            pcSelect.innerHTML = '<option value="">Select PC Number...</option>';
            
            let filteredPCs = db.pcs;
            if (selectedClient) {
                filteredPCs = db.pcs.filter(pc => pc.company === selectedClient);
            }
            
            filteredPCs.forEach(pc => {
                const option = document.createElement('option');
                option.value = pc.id;
                option.textContent = `${pc.number} - ${pc.company}${pc.reference ? ` (${pc.reference})` : ''}`;
                pcSelect.appendChild(option);
            });
        }
        
        function addResourceRow(category) {
            const grid = document.getElementById(`${category}-resources-grid`);
            if (!grid) return;
            
            const newRow = document.createElement('div');
            newRow.className = 'resource-grid-row';
            newRow.innerHTML = `
                <select class="resource-select" data-category="${category}"><option value="">Select ${category}...</option></select>
                <input type="number" class="resource-quantity" min="0" value="0">
            `;
            grid.appendChild(newRow);
            
            const select = newRow.querySelector('select');
            const categoryResources = db.resources.filter(r => (r.category === 'equipment' ? 'other' : r.category) === category);
            categoryResources.forEach(resource => {
                select.innerHTML += `<option value="${resource.id}">${resource.name}</option>`;
            });
        }
        function clearActivityForm() {
            const formIds = ['activity-name', 'activity-type', 'activity-department', 'activity-date', 'activity-time-depot-start', 'activity-time-site-start', 'activity-time-site-finish', 'activity-time-depot-finish', 'activity-hours', 'activity-payment-type', 'activity-instructions', 'activity-team-instructions', 'activity-collection-firstname', 'activity-collection-lastname', 'activity-collection-email', 'activity-collection-phone', 'activity-collection-country', 'activity-delivery-firstname', 'activity-delivery-lastname', 'activity-delivery-email', 'activity-delivery-phone', 'activity-delivery-country', 'activity-moveman', 'activity-pc-select', 'activity-quote', 'activity-client-search'];
            formIds.forEach(id => {
                const field = document.getElementById(id);
                if(field) {
                    field.value = '';
                    field.classList.remove('input-error');
                }
            });
            
            // Handle textarea fields safely
            const collectionAddress = document.getElementById('activity-collection-address');
            if(collectionAddress) {
                collectionAddress.value = '';
                collectionAddress.classList.remove('input-error');
            }
            
            const deliveryAddress = document.getElementById('activity-delivery-address');
            if(deliveryAddress) {
                deliveryAddress.value = '';
                deliveryAddress.classList.remove('input-error');
            }
            
            // Handle status fields safely
            const localStatusField = document.getElementById('activity-local-status');
            if(localStatusField) {
                localStatusField.value = 'draft';
            }
            
            const syncStatusField = document.getElementById('activity-sync-status');
            if(syncStatusField && !syncStatusField.disabled) {
                syncStatusField.value = '';
            }
            
            // Handle checkbox fields safely
            ['activity-parking-required', 'activity-confirmed', 'activity-risk-assessment'].forEach(id => {
                const checkbox = document.getElementById(id);
                if(checkbox) {
                    checkbox.checked = false;
                }
            });
            
            // Handle quote select safely
            const quoteSelect = document.getElementById('activity-quote');
            if(quoteSelect) {
                quoteSelect.innerHTML = '<option value="">Select quote...</option>';
            }
            
            // Handle PC info display safely
            const pcInfo = document.getElementById('activity-pc-info');
            if(pcInfo) {
                pcInfo.style.display = 'none';
            }
            
            // Handle resource fields safely
            document.querySelectorAll('.resource-select').forEach(s => s.value = '');
            document.querySelectorAll('.resource-quantity').forEach(i => i.value = '0');
        }
        // Event listener for client search field
        document.getElementById('activity-client-search').addEventListener('input', function() {
            const selectedClient = this.value;
            populateActivityPCList(selectedClient);
            // Clear PC selection when client changes
            const pcSelect = document.getElementById('activity-pc-select');
            const pcInfo = document.getElementById('activity-pc-info');
            const quoteSelect = document.getElementById('activity-quote');
            
            if (pcSelect) pcSelect.value = '';
            if (pcInfo) pcInfo.style.display = 'none';
            if (quoteSelect) quoteSelect.innerHTML = '<option value="">Select quote...</option>';
        });
        
        document.getElementById('activity-pc-select').addEventListener('change', function(){
            const pcId = this.value;
            console.log(' PC Select changed to:', pcId);
            const infoDiv = document.getElementById('activity-pc-info');
            const quoteSelect = document.getElementById('activity-quote');
            if (pcId) {
                const pc = db.pcs.find(p => p.id === pcId);
                console.log(' Found PC:', pc);
                if (pc) {
                    infoDiv.innerHTML = `<strong>${pc.company}</strong><br>Reference: ${pc.reference || 'N/A'}<br>Contact: ${pc.contactPerson || 'N/A'}<br>Email: ${pc.email || 'N/A'}`;
                    infoDiv.style.display = 'block';
                    quoteSelect.innerHTML = '<option value="">Select quote...</option>';
                    const quotes = db.quotes.filter(q => q.pcId === pcId);
                    console.log(' Found quotes for PC:', quotes.length);
                    if (quotes.length === 0) {
                        console.log(' No quotes found - showing alert');
                        // Show alert when PC Number has no quotes
                        alert(` No quotes found for PC Number ${pc.number} (${pc.company})\n\nPlease create a quote for this PC Number first, then you can add an Activity.`);
                        
                        // Reset PC selection and clear form
                        this.value = '';
                        infoDiv.style.display = 'none';
                        quoteSelect.innerHTML = '<option value="">Select quote...</option>';
                        quoteSelect.disabled = true;
                        
                        // Clear other form fields safely
                        const nameField = document.getElementById('activity-name');
                        const typeField = document.getElementById('activity-type');
                        const dateField = document.getElementById('activity-date');
                        
                        if (nameField) nameField.value = '';
                        if (typeField) typeField.value = '';
                        if (dateField) dateField.value = '';
                    } else {
                        console.log(' Quotes found - populating dropdown');
                        quoteSelect.disabled = false;
                        quotes.forEach(q => {
                            const quoteName = q.name ? ` (${q.name})` : '';
                            quoteSelect.innerHTML += `<option value="${q.id}">${q.number}${quoteName} - ${q.total.toFixed(2)}</option>`;
                        });
                        
                        // Auto-select quote if there's only one or if currentQuote is set
                        if (db.currentQuote && quotes.find(q => q.id === db.currentQuote.id)) {
                            quoteSelect.value = db.currentQuote.id;
                            console.log(' Auto-selected current quote:', db.currentQuote.number);
                        } else if (quotes.length === 1) {
                            quoteSelect.value = quotes[0].id;
                            console.log(' Auto-selected single quote:', quotes[0].number);
                        }
                    }
                }
            } else {
                infoDiv.style.display = 'none';
                quoteSelect.innerHTML = '<option value="">Select quote...</option>';
                quoteSelect.disabled = false;
            }
        });
        function closeActivityModal() { 
            const modal = document.getElementById('activity-modal');
            const title = document.getElementById('activity-modal-title');
            
            if (modal) modal.style.display = 'none'; 
            db.editingActivity = null;
            
            // Reset form title safely
            if (title) title.textContent = 'New Activity';
        }
        
        // ========================================
        // ACTIVITIES MANAGEMENT
        // ========================================
        
        function saveActivity() {
            // 1. Clear previous errors
            const allFieldsInModal = document.querySelectorAll('#activity-modal input, #activity-modal select');
            allFieldsInModal.forEach(field => field.classList.remove('input-error'));

            let isValid = true;

            // 2. Define required fields and validate them
            const requiredFieldIds = ['activity-name', 'activity-type', 'activity-date', 'activity-quote', 'activity-pc-select'];

            requiredFieldIds.forEach(id => {
                const field = document.getElementById(id);
                if (!field.value) {
                    isValid = false;
                    field.classList.add('input-error');
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields!');
                return;
            }
            
            let pcId = db.currentPC ? db.currentPC.id : document.getElementById('activity-pc-select').value;
            const quoteId = document.getElementById('activity-quote').value;
            const quote = db.quotes.find(q => q.id === quoteId);
            if (!quote || quote.pcId !== pcId) {
                alert('Invalid quote selection! Ensure the quote belongs to the selected PC Number.');
                return;
            }
            
            const resources = collectActivityResources();
            const activityData = {
                name: document.getElementById('activity-name').value,
                type: document.getElementById('activity-type').value,
                department: document.getElementById('activity-department').value,
                local_status: document.getElementById('activity-local-status').value,
                sync_status: document.getElementById('activity-sync-status').disabled ? null : (document.getElementById('activity-sync-status').value || null),
                date: document.getElementById('activity-date').value,
                timeDepotStart: document.getElementById('activity-time-depot-start').value,
                timeSiteStart: document.getElementById('activity-time-site-start').value,
                timeSiteFinish: document.getElementById('activity-time-site-finish').value,
                timeDepotFinish: document.getElementById('activity-time-depot-finish').value,
                hours: parseFloat(document.getElementById('activity-hours').value) || 0,
                paymentType: document.getElementById('activity-payment-type').value,
                instructions: document.getElementById('activity-instructions').value,
                teamInstructions: document.getElementById('activity-team-instructions').value,
                parkingRequired: document.getElementById('activity-parking-required').checked,
                confirmed: document.getElementById('activity-confirmed').checked,
                riskAssessmentNeeded: document.getElementById('activity-risk-assessment').checked,
                collectionAddress: {
                    firstName: document.getElementById('activity-collection-firstname').value, lastName: document.getElementById('activity-collection-lastname').value,
                    email: document.getElementById('activity-collection-email').value, phone: document.getElementById('activity-collection-phone').value,
                    country: document.getElementById('activity-collection-country').value, address: document.getElementById('activity-collection-address').value
                },
                deliveryAddress: {
                    firstName: document.getElementById('activity-delivery-firstname').value, lastName: document.getElementById('activity-delivery-lastname').value,
                    email: document.getElementById('activity-delivery-email').value, phone: document.getElementById('activity-delivery-phone').value,
                    country: document.getElementById('activity-delivery-country').value, address: document.getElementById('activity-delivery-address').value
                },
                quoteId: quoteId,
                quoteNumber: quote.number,
                resources: resources,
                movemanJob: document.getElementById('activity-moveman').value || 'JOB-' + String(db.activities.length + 1).padStart(6, '0')
            };
            
            if (db.editingActivity) {
                // Create new version when editing existing activity
                const baseId = db.editingActivity.crmId || db.editingActivity.id;
                const newVersionId = generateNextActivityVersion(baseId);
                
                const newVersionActivity = {
                    id: 'ACT' + Date.now(),
                    crmId: newVersionId,
                    pcId: pcId,
                    originalId: db.editingActivity.originalId || db.editingActivity.id,
                    baseId: baseId,
                    version: getActivityVersionNumber(newVersionId),
                    ...activityData,
                    created: new Date().toISOString(),
                    notesList: []
                };
                
                db.activities.push(newVersionActivity);
                alert(`Activity saved as new version: ${newVersionId}`);
            } else {
                const activity = {
                    id: 'ACT' + Date.now(),
                    crmId: 'ACT-' + String(db.activities.length + 1).padStart(6, '0'),
                    pcId: pcId,
                    originalId: null,
                    baseId: null,
                    version: 1,
                    ...activityData,
                    created: new Date().toISOString(),
                    notesList: []
                };
                db.activities.push(activity);
                alert('Activity ' + activity.crmId + ' created successfully!');
            }
            saveData();
            closeActivityModal();
            if (db.currentPC && !document.getElementById('activities').classList.contains('active')) {
                viewPC(db.currentPC.id);
            } else {
                updateActivitiesList();
            }
        }
        function updateActivitiesList() {
            const tbody = document.getElementById('activities-list');
            const resultsCount = document.getElementById('activities-results-count');
            
            tbody.innerHTML = '';
            let activities = [...db.activities];
            
            // Apply existing filters
            const statusFilter = document.getElementById('activity-filter-status').value;
            const dateFrom = document.getElementById('activity-filter-from').value;
            const dateTo = document.getElementById('activity-filter-to').value;
            
            if (statusFilter) {
                activities = activities.filter(a => {
                    // For backward compatibility, check both old status and new local_status
                    const localStatus = a.local_status || a.status;
                    return localStatus === statusFilter;
                });
            }
            if (dateFrom) activities = activities.filter(a => a.date >= dateFrom);
            if (dateTo) activities = activities.filter(a => a.date <= dateTo);
            
            // Apply company filter if exists
            const companyFilter = document.getElementById('activities-company-filter');
            if (companyFilter && companyFilter.value.trim()) {
                const companySearch = companyFilter.value.toLowerCase().trim();
                activities = activities.filter(a => {
                    const pc = db.pcs.find(p => p.id === a.pcId);
                    return pc && (pc.company || '').toLowerCase().includes(companySearch);
                });
            }
            
            if (db.activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No activities yet</td></tr>';
                if (resultsCount) resultsCount.textContent = '';
            } else if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No activities match your search criteria</td></tr>';
                if (resultsCount) resultsCount.textContent = 'No results';
            } else {
                activities.forEach(a => {
                    const pc = db.pcs.find(p => p.id === a.pcId);
                    // Handle both old and new status fields for backward compatibility
                    const localStatus = a.local_status || a.status || 'draft';
                    const syncStatus = a.sync_status || '';
                    
                    // Create status display
                    const localStatusDisplay = `<span class="activity-status ${localStatus.toLowerCase().replace(' ', '-')}">${localStatus}</span>`;
                    const syncStatusDisplay = syncStatus ? `<span class="activity-status ${syncStatus.toLowerCase().replace(' ', '-')}">${syncStatus}</span>` : '-';
                    
                    tbody.innerHTML += `<tr><td>${a.crmId || a.number}</td><td>${pc ? pc.number : '-'}</td><td>${pc ? pc.company : '-'}</td><td>${a.name || a.type}</td><td>${formatDate(a.date)} ${a.timeSiteStart || ''}</td><td>${localStatusDisplay}</td><td>${syncStatusDisplay}</td><td><div class="action-btn-group"><button onclick="window.viewActivity('${a.id}')">View</button><button onclick="window.editActivityFromList('${a.id}')" class="secondary">Edit</button></div></td></tr>`;
                });
                
                // Update results counter
                if (resultsCount) {
                    const totalCount = db.activities.length;
                    const showingCount = activities.length;
                    if (showingCount === totalCount) {
                        resultsCount.textContent = `Showing all ${totalCount} activities`;
                    } else {
                        resultsCount.textContent = `Showing ${showingCount} of ${totalCount} activities`;
                    }
                }
            }
        }
        function filterActivities() { updateActivitiesList(); }
        function clearActivityFilters() {
            document.getElementById('activity-filter-status').value = '';
            document.getElementById('activity-filter-from').value = '';
            document.getElementById('activity-filter-to').value = '';
            document.getElementById('activities-company-filter').value = '';
            updateActivitiesList();
        }
        function viewActivity(id) {
            const activity = db.activities.find(a => a.id === id);
            if (!activity) return;
            db.currentActivity = activity;
            const pc = db.pcs.find(p => p.id === activity.pcId);
            const quote = activity.quoteId ? db.quotes.find(q => q.id === activity.quoteId) : null;
            document.getElementById('activity-detail-title').textContent = (activity.crmId || activity.number) + ' - ' + (activity.name || activity.type);
            // Handle both old and new status fields for backward compatibility
            const localStatus = activity.local_status || activity.status || 'draft';
            const syncStatus = activity.sync_status || '';
            
            let statusHtml = `<p><strong>Local Status:</strong> <span class="activity-status ${localStatus.toLowerCase().replace(' ', '-')}">${localStatus}</span></p>`;
            if (syncStatus) {
                statusHtml += `<p><strong>Sync Status:</strong> <span class="activity-status ${syncStatus.toLowerCase().replace(' ', '-')}">${syncStatus}</span></p>`;
            }
            
            let detailHtml = `<p><strong>CRM ID:</strong> ${activity.crmId || activity.number}</p><p><strong>Moveman Job:</strong> ${activity.movemanJob || '-'}</p><p><strong>Name:</strong> ${activity.name || '-'}</p><p><strong>Type:</strong> ${activity.type}</p><p><strong>Department:</strong> ${activity.department || '-'}</p>${statusHtml}<p><strong>Date:</strong> ${formatDate(activity.date)}</p>`;
            if (activity.timeDepotStart || activity.timeSiteStart || activity.timeSiteFinish || activity.timeDepotFinish) {
                detailHtml += '<h4 style="margin-top: 1rem;">Time Schedule</h4>';
                if (activity.timeDepotStart) detailHtml += `<p><strong>Depot Start:</strong> ${activity.timeDepotStart}</p>`;
                if (activity.timeSiteStart) detailHtml += `<p><strong>Site Start:</strong> ${activity.timeSiteStart}</p>`;
                if (activity.timeSiteFinish) detailHtml += `<p><strong>Site Finish:</strong> ${activity.timeSiteFinish}</p>`;
                if (activity.timeDepotFinish) detailHtml += `<p><strong>Depot Finish:</strong> ${activity.timeDepotFinish}</p>`;
            }
            if (activity.hours) detailHtml += `<p><strong>Total Hours:</strong> ${activity.hours}</p>`;
            if (activity.paymentType) detailHtml += `<p><strong>Payment Type:</strong> ${activity.paymentType}</p>`;
            detailHtml += '<h4 style="margin-top: 1rem;">Requirements</h4>';
            detailHtml += `<p>Parking Required: ${activity.parkingRequired ? 'Yes' : 'No'}</p>`;
            detailHtml += `<p>Confirmed: ${activity.confirmed ? 'Yes' : 'No'}</p>`;
            detailHtml += `<p>Risk Assessment Needed: ${activity.riskAssessmentNeeded ? 'Yes' : 'No'}</p>`;
            if (activity.instructions) detailHtml += `<h4 style="margin-top: 1rem;">Instructions</h4><p>${activity.instructions}</p>`;
            if (activity.collectionAddress && (activity.collectionAddress.firstName || activity.collectionAddress.address)) {
                detailHtml += '<h4 style="margin-top: 1rem;">Collection Address</h4>';
                if (activity.collectionAddress.firstName || activity.collectionAddress.lastName) detailHtml += `<p><strong>Name:</strong> ${activity.collectionAddress.firstName || ''} ${activity.collectionAddress.lastName || ''}</p>`;
                if (activity.collectionAddress.email) detailHtml += `<p><strong>Email:</strong> ${activity.collectionAddress.email}</p>`;
                if (activity.collectionAddress.phone) detailHtml += `<p><strong>Phone:</strong> ${activity.collectionAddress.phone}</p>`;
                if (activity.collectionAddress.country) detailHtml += `<p><strong>Country:</strong> ${activity.collectionAddress.country}</p>`;
                if (activity.collectionAddress.address) detailHtml += `<p><strong>Address:</strong> ${activity.collectionAddress.address}</p>`;
            }
             if (activity.deliveryAddress && (activity.deliveryAddress.firstName || activity.deliveryAddress.address)) {
                detailHtml += '<h4 style="margin-top: 1rem;">Delivery Address</h4>';
                if (activity.deliveryAddress.firstName || activity.deliveryAddress.lastName) detailHtml += `<p><strong>Name:</strong> ${activity.deliveryAddress.firstName || ''} ${activity.deliveryAddress.lastName || ''}</p>`;
                if (activity.deliveryAddress.email) detailHtml += `<p><strong>Email:</strong> ${activity.deliveryAddress.email}</p>`;
                if (activity.deliveryAddress.phone) detailHtml += `<p><strong>Phone:</strong> ${activity.deliveryAddress.phone}</p>`;
                if (activity.deliveryAddress.country) detailHtml += `<p><strong>Country:</strong> ${activity.deliveryAddress.country}</p>`;
                if (activity.deliveryAddress.address) detailHtml += `<p><strong>Address:</strong> ${activity.deliveryAddress.address}</p>`;
            }
            document.getElementById('activity-detail-info').innerHTML = detailHtml;
            
            const contactHTML = `
                 <p><strong>Contact:</strong> ${pc.contactPerson || '-'}</p>
                 <p><strong>Mobile:</strong> ${pc.mobilePhone || '-'}</p>
                 <p><strong>Email:</strong> ${pc.email || '-'}</p>
            `;
            if (document.getElementById('activity-contact-details')) {
                document.getElementById('activity-contact-details').innerHTML = contactHTML;
            }

            const quoteInfo = quote ? `${quote.number}${quote.name ? ` (${quote.name})` : ''} - ${quote.total.toFixed(2)}` : '-';
            document.getElementById('activity-related-info').innerHTML = `
                 <p><strong>PC Number:</strong> ${pc ? pc.number + ' - ' + pc.company : '-'}</p><p><strong>Quote:</strong> ${quoteInfo}</p><p><strong>Contact:</strong> ${pc ? (pc.contactPerson + (pc.mobilePhone ? ` (${pc.mobilePhone})` : '')) : '-'}</p>
            `;
            
            const notesDiv = document.getElementById('activity-notes');
            notesDiv.innerHTML = '';
            if (!activity.notesList) activity.notesList = [];
            if (activity.notesList.length === 0) {
                notesDiv.innerHTML = '<p style="color: #999;">No notes yet</p>';
            } else {
                activity.notesList.forEach(note => {
                    notesDiv.innerHTML += `<div style="background: #f8f9fa; padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px;"><div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 0.5rem;">${formatDateTime(note.created)}</div><div>${note.text}</div></div>`;
                });
            }
            showPage('activity-detail');
        }
        function editActivity() {
            if (!db.currentActivity) return;
            db.editingActivity = db.currentActivity;
            document.getElementById('activity-modal-title').textContent = 'Edit Activity';
            document.getElementById('activity-name').value = db.currentActivity.name || '';
            document.getElementById('activity-type').value = db.currentActivity.type;
            document.getElementById('activity-department').value = db.currentActivity.department || '';
            // Handle both old and new status fields for backward compatibility
            const localStatusField = document.getElementById('activity-local-status');
            const syncStatusField = document.getElementById('activity-sync-status');
            
            if (localStatusField) {
                localStatusField.value = db.currentActivity.local_status || db.currentActivity.status || 'draft';
            }
            if (syncStatusField && !syncStatusField.disabled) {
                syncStatusField.value = db.currentActivity.sync_status || '';
            }
            document.getElementById('activity-date').value = db.currentActivity.date;
            document.getElementById('activity-time-depot-start').value = db.currentActivity.timeDepotStart || '';
            document.getElementById('activity-time-site-start').value = db.currentActivity.timeSiteStart || '';
            document.getElementById('activity-time-site-finish').value = db.currentActivity.timeSiteFinish || '';
            document.getElementById('activity-time-depot-finish').value = db.currentActivity.timeDepotFinish || '';
            document.getElementById('activity-hours').value = db.currentActivity.hours || '';
            document.getElementById('activity-payment-type').value = db.currentActivity.paymentType || '';
            document.getElementById('activity-instructions').value = db.currentActivity.instructions || '';
            document.getElementById('activity-parking-required').checked = db.currentActivity.parkingRequired || false;
            document.getElementById('activity-confirmed').checked = db.currentActivity.confirmed || false;
            document.getElementById('activity-risk-assessment').checked = db.currentActivity.riskAssessmentNeeded || false;
            if (db.currentActivity.collectionAddress) {
                document.getElementById('activity-collection-firstname').value = db.currentActivity.collectionAddress.firstName || '';
                document.getElementById('activity-collection-lastname').value = db.currentActivity.collectionAddress.lastName || '';
                document.getElementById('activity-collection-email').value = db.currentActivity.collectionAddress.email || '';
                document.getElementById('activity-collection-phone').value = db.currentActivity.collectionAddress.phone || '';
                document.getElementById('activity-collection-country').value = db.currentActivity.collectionAddress.country || '';
                document.getElementById('activity-collection-address').value = db.currentActivity.collectionAddress.address || '';
            }
            if (db.currentActivity.deliveryAddress) {
                document.getElementById('activity-delivery-firstname').value = db.currentActivity.deliveryAddress.firstName || '';
                document.getElementById('activity-delivery-lastname').value = db.currentActivity.deliveryAddress.lastName || '';
                document.getElementById('activity-delivery-email').value = db.currentActivity.deliveryAddress.email || '';
                document.getElementById('activity-delivery-phone').value = db.currentActivity.deliveryAddress.phone || '';
                document.getElementById('activity-delivery-country').value = db.currentActivity.deliveryAddress.country || '';
                document.getElementById('activity-delivery-address').value = db.currentActivity.deliveryAddress.address || '';
            }
            document.getElementById('activity-moveman').value = db.currentActivity.movemanJob || '';
            const quoteSelect = document.getElementById('activity-quote');
            quoteSelect.innerHTML = '<option value="">Select quote...</option>';
            if (db.currentActivity.pcId) {
                const quotes = db.quotes.filter(q => q.pcId === db.currentActivity.pcId);
                if (quotes.length > 0) {
                    quoteSelect.disabled = false;
                    quotes.forEach(q => {
                        const quoteName = q.name ? ` (${q.name})` : '';
                        quoteSelect.innerHTML += `<option value="${q.id}" ${q.id === db.currentActivity.quoteId ? 'selected' : ''}>${q.number}${quoteName} - ${q.total.toFixed(2)}</option>`;
                    });
                }
            }
            document.getElementById('activity-modal').style.display = 'block';
        }
        function addActivityNote() {
            if (!db.currentActivity) return;
            const noteText = prompt('Add a note:');
            if (!noteText) return;
            if (!db.currentActivity.notesList) db.currentActivity.notesList = [];
            db.currentActivity.notesList.push({ text: noteText, created: new Date().toISOString() });
            saveData();
            viewActivity(db.currentActivity.id);
        }
        function loadActivityResources() {}
        function collectActivityResources() {
            const resources = [];
            const categories = ['vehicles', 'human', 'materials', 'crates', 'other'];
            categories.forEach(category => {
                const grid = document.getElementById(`${category}-resources-grid`);
                if (!grid) return;
                const rows = grid.querySelectorAll('.resource-grid-row');
                rows.forEach(row => {
                    const select = row.querySelector('.resource-select');
                    const quantityInput = row.querySelector('.resource-quantity');
                    if (select.value && quantityInput.value > 0) {
                        const resource = db.resources.find(r => r.id === select.value);
                        if (resource) {
                            resources.push({
                                resourceId: resource.id, resourceName: resource.name, category: category,
                                quantity: parseInt(quantityInput.value) || 0, netCost: resource.netCost, unit: resource.unit
                            });
                        }
                    }
                });
            });
            return resources;
        }

        // ========================================
        // CALENDAR MANAGEMENT
        // ========================================
        
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const title = document.getElementById('calendar-title');
            
            // Ensure calendar date is set to current date if not already set
            if (!db.calendarDate || isNaN(db.calendarDate.getTime())) {
                db.calendarDate = new Date();
            }
            
            // Update filter info
            const filterInfo = document.getElementById('calendar-filter-info');
            if (calendarClientFilter) {
                const filteredCount = getFilteredActivities().length;
                const totalCount = db.activities.length;
                filterInfo.innerHTML = ` Filtered: ${filteredCount} of ${totalCount} activities for "${calendarClientFilter}"`;
            } else {
                filterInfo.innerHTML = '';
            }
            
            if (db.calendarView === 'month') renderMonthView(container, title);
            else if (db.calendarView === 'week') renderWeekView(container, title);
            else renderDayView(container, title);
        }
        function renderMonthView(container, title) {
            const year = db.calendarDate.getFullYear();
            const month = db.calendarDate.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            title.textContent = monthNames[month] + ' ' + year;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            let html = '<div class="calendar-grid">';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => { html += `<div class="calendar-header">${day}</div>`; });
            let dayOfWeek = firstDayOfMonth === 0 ? 7 : firstDayOfMonth;
            for (let i = dayOfWeek - 2; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = today.toDateString() === date.toDateString();
                const allActivities = getFilteredActivities();
                const activities = allActivities.filter(a => a.date === dateStr);
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="window.viewDayActivities('${dateStr}')">`;
                html += `<div class="calendar-day-number">${day}</div>`;
                html += `<div class="calendar-activities-container">`;
                
                // Show first 3 activities, then "more" indicator
                const maxVisibleActivities = 3;
                const visibleActivities = activities.slice(0, maxVisibleActivities);
                const hiddenActivities = activities.slice(maxVisibleActivities);
                
                visibleActivities.forEach(activity => {
                    const pc = db.pcs.find(p => p.id === activity.pcId);
                    const clientName = pc ? pc.company : 'Unknown Client';
                    const activityText = `${activity.timeSiteStart || ''} ${activity.name || activity.type}`.trim();
                    html += `<div class="calendar-activity ${activity.status.toLowerCase().replace(' ', '-')}" onclick="event.stopPropagation(); window.viewActivity('${activity.id}')" title="${clientName} - ${activityText}">${activityText}</div>`;
                });
                
                if (hiddenActivities.length > 0) {
                    html += `<div class="calendar-more-activities" onclick="event.stopPropagation(); window.viewDayActivities('${dateStr}')" title="View all ${activities.length} activities">+${hiddenActivities.length} more</div>`;
                }
                
                html += `</div></div>`;
            }
            const totalCells = (dayOfWeek - 1) + daysInMonth;
            const remainingDays = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7) ;
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }
        function renderWeekView(container, title) {
            const startOfWeek = new Date(db.calendarDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay()); // Start on Sunday
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const startMonth = monthNames[startOfWeek.getMonth()];
            const endMonth = monthNames[endOfWeek.getMonth()];
            
            if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
                title.textContent = `${startMonth} ${startOfWeek.getDate()}-${endOfWeek.getDate()}, ${startOfWeek.getFullYear()}`;
            } else {
                title.textContent = `${startMonth} ${startOfWeek.getDate()} - ${endMonth} ${endOfWeek.getDate()}, ${startOfWeek.getFullYear()}`;
            }
            
            let html = '<div class="calendar-week-view">';
            
            // Time slots column
            html += '<div class="calendar-time-slot">Time</div>';
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(day.getDate() + i);
                const isToday = new Date().toDateString() === day.toDateString();
                html += `<div class="calendar-header ${isToday ? 'today' : ''}">${dayNames[i]}<br>${day.getDate()}</div>`;
            }
            
            // Time slots (8 AM to 8 PM)
            for (let hour = 8; hour <= 20; hour++) {
                const timeLabel = hour < 12 ? `${hour}:00 AM` : hour === 12 ? '12:00 PM' : `${hour - 12}:00 PM`;
                html += `<div class="calendar-time-slot">${timeLabel}</div>`;
                
                // Days for this hour
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(day.getDate() + i);
                    const dateStr = day.toISOString().split('T')[0];
                    
                    const allActivities = getFilteredActivities();
                    const activities = allActivities.filter(a => {
                        if (a.date !== dateStr) return false;
                        if (!a.timeSiteStart) return hour === 8; // Default to 8 AM if no time set
                        const activityHour = parseInt(a.timeSiteStart.split(':')[0]);
                        return activityHour === hour;
                    });
                    
                    html += `<div class="calendar-week-day" onclick="window.viewDayActivities('${dateStr}')">`;
                    activities.forEach(activity => {
                        const pc = db.pcs.find(p => p.id === activity.pcId);
                        const clientName = pc ? pc.company : 'Unknown';
                        html += `<div class="calendar-activity ${activity.status.toLowerCase().replace(' ', '-')}" 
                                     onclick="event.stopPropagation(); window.viewActivity('${activity.id}')" 
                                     title="${clientName} - ${activity.name || activity.type}">
                                     ${activity.name || activity.type}
                                 </div>`;
                    });
                    html += `</div>`;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        function renderDayView(container, title) {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            const dayName = dayNames[db.calendarDate.getDay()];
            const monthName = monthNames[db.calendarDate.getMonth()];
            title.textContent = `${dayName}, ${monthName} ${db.calendarDate.getDate()}, ${db.calendarDate.getFullYear()}`;
            
            const dateStr = db.calendarDate.toISOString().split('T')[0];
            const allActivities = getFilteredActivities();
            const dayActivities = allActivities.filter(a => a.date === dateStr);
            
            let html = '<div class="calendar-day-view">';
            
            // Day summary
            html += `<div class="day-summary">
                        <h3> ${dayName}</h3>
                        <p>${dayActivities.length} activities scheduled</p>
                     </div>`;
            
            if (dayActivities.length === 0) {
                html += '<div class="no-activities"><p>No activities scheduled for this day</p></div>';
            } else {
                // Sort activities by time
                dayActivities.sort((a, b) => {
                    const timeA = a.timeSiteStart || '08:00';
                    const timeB = b.timeSiteStart || '08:00';
                    return timeA.localeCompare(timeB);
                });
                
                html += '<div class="day-activities">';
                
                // Time slots from 6 AM to 10 PM
                for (let hour = 6; hour <= 22; hour++) {
                    const timeLabel = hour < 12 ? `${hour}:00 AM` : hour === 12 ? '12:00 PM' : `${hour - 12}:00 PM`;
                    
                    // Find activities for this hour
                    const hourActivities = dayActivities.filter(a => {
                        if (!a.timeSiteStart) return hour === 8; // Default to 8 AM if no time
                        const activityHour = parseInt(a.timeSiteStart.split(':')[0]);
                        return activityHour === hour;
                    });
                    
                    html += `<div class="day-time-slot">
                                <div class="time-label">${timeLabel}</div>
                                <div class="time-activities">`;
                    
                    if (hourActivities.length === 0) {
                        html += '<div class="time-empty"></div>';
                    } else {
                        hourActivities.forEach(activity => {
                            const pc = db.pcs.find(p => p.id === activity.pcId);
                            const clientName = pc ? pc.company : 'Unknown Client';
                            const duration = activity.hours ? `(${activity.hours}h)` : '';
                            
                            html += `<div class="day-activity ${activity.status.toLowerCase().replace(' ', '-')}" 
                                         onclick="window.viewActivity('${activity.id}')">
                                         <div class="activity-header">
                                             <strong>${activity.name || activity.type}</strong>
                                             <span class="activity-time">${activity.timeSiteStart || '08:00'} ${duration}</span>
                                         </div>
                                         <div class="activity-client"> ${clientName}</div>
                                         <div class="activity-status">Status: ${activity.status}</div>
                                         ${activity.instructions ? `<div class="activity-instructions"> ${activity.instructions}</div>` : ''}
                                     </div>`;
                        });
                    }
                    
                    html += '</div></div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        function changeCalendarView(view) {
            db.calendarView = view;
            document.getElementById('cal-month-btn').classList.toggle('active', view === 'month');
            document.getElementById('cal-week-btn').classList.toggle('active', view === 'week');
            document.getElementById('cal-day-btn').classList.toggle('active', view === 'day');
            renderCalendar();
        }
        function navigateCalendar(direction) {
            if (direction === 'prev') {
                if (db.calendarView === 'month') db.calendarDate.setMonth(db.calendarDate.getMonth() - 1);
                else if (db.calendarView === 'week') db.calendarDate.setDate(db.calendarDate.getDate() - 7);
                else db.calendarDate.setDate(db.calendarDate.getDate() - 1);
            } else if (direction === 'next') {
                if (db.calendarView === 'month') db.calendarDate.setMonth(db.calendarDate.getMonth() + 1);
                else if (db.calendarView === 'week') db.calendarDate.setDate(db.calendarDate.getDate() + 7);
                else db.calendarDate.setDate(db.calendarDate.getDate() + 1);
            } else if (direction === 'today') {
                db.calendarDate = new Date();
            }
            renderCalendar();
        }
        function viewDayActivities(date) {
            const activities = db.activities.filter(a => a.date === date);
            if (activities.length > 0) {
                document.getElementById('activity-filter-from').value = date;
                document.getElementById('activity-filter-to').value = date;
                showPage('activities');
            }
        }

        function filterCalendarByClient() {
            calendarClientFilter = document.getElementById('calendar-client-filter').value.toLowerCase().trim();
            renderCalendar();
        }

        function clearCalendarFilter() {
            calendarClientFilter = '';
            document.getElementById('calendar-client-filter').value = '';
            renderCalendar();
        }

        function getFilteredActivities() {
            if (!calendarClientFilter) {
                return db.activities || [];
            }
            
            return (db.activities || []).filter(activity => {
                const pc = db.pcs.find(p => p.id === activity.pcId);
                const clientName = pc ? pc.company.toLowerCase() : '';
                return clientName.includes(calendarClientFilter);
            });
        }
        
        // --- RESOURCE FUNCTIONS (FULL) ---
        function showResourceModal() {
            db.editingResource = null;
            document.getElementById('resource-modal-title').textContent = 'New Resource';
            document.getElementById('resource-name').value = '';
            document.getElementById('resource-category').value = '';
            document.getElementById('resource-cost').value = '';
            document.getElementById('resource-unit').value = '';
            
            // Reset time-based pricing fields
            document.getElementById('enable-time-pricing').checked = false;
            document.getElementById('standard-rate').value = '';
            document.getElementById('overtime-rate').value = '';
            document.getElementById('weekend-rate').value = '';
            document.getElementById('time-pricing-fields').style.display = 'none';
            
            document.getElementById('resource-modal').classList.add('active');
        }
        function closeResourceModal() {
            document.getElementById('resource-modal').classList.remove('active');
        }
        // ========================================
        // RESOURCES MANAGEMENT
        // ========================================
        
        function saveResource() {
            const name = document.getElementById('resource-name').value.trim();
            const category = document.getElementById('resource-category').value;
            const cost = parseFloat(document.getElementById('resource-cost').value);
            const unit = document.getElementById('resource-unit').value;
            const enableTimePricing = document.getElementById('enable-time-pricing').checked;
            
            if (!name || !category || isNaN(cost) || !unit) { alert('Please fill in all fields!'); return; }
            if (cost <= 0) { alert('Net cost must be greater than zero!'); return; }
            
            // Validate time-based pricing if enabled
            if (enableTimePricing) {
                const standardRate = parseFloat(document.getElementById('standard-rate').value) || 0;
                const overtimeRate = parseFloat(document.getElementById('overtime-rate').value) || 0;
                const weekendRate = parseFloat(document.getElementById('weekend-rate').value) || 0;
                
                if (standardRate <= 0) { alert('Standard rate must be greater than zero!'); return; }
            }
            
            if (db.editingResource) {
                db.editingResource.name = name;
                db.editingResource.category = category;
                db.editingResource.netCost = cost;
                db.editingResource.unit = unit;
                
                // Handle time-based pricing
                if (enableTimePricing) {
                    db.editingResource.timeBasedPricing = true;
                    db.editingResource.standardRate = parseFloat(document.getElementById('standard-rate').value) || cost;
                    db.editingResource.overtimeRate = parseFloat(document.getElementById('overtime-rate').value) || 0;
                    db.editingResource.weekendRate = parseFloat(document.getElementById('weekend-rate').value) || 0;
                } else {
                    db.editingResource.timeBasedPricing = false;
                    delete db.editingResource.standardRate;
                    delete db.editingResource.overtimeRate;
                    delete db.editingResource.weekendRate;
                }
                
                alert('Resource updated successfully!');
            } else {
                const resource = {
                    id: 'RES' + Date.now() + Math.random().toString(36).substr(2, 9),
                    name: name, 
                    category: category, 
                    netCost: cost, 
                    unit: unit,
                    timeBasedPricing: enableTimePricing
                };
                
                // Add time-based pricing if enabled
                if (enableTimePricing) {
                    resource.standardRate = parseFloat(document.getElementById('standard-rate').value) || cost;
                    resource.overtimeRate = parseFloat(document.getElementById('overtime-rate').value) || 0;
                    resource.weekendRate = parseFloat(document.getElementById('weekend-rate').value) || 0;
                }
                
                db.resources.push(resource);
                alert('Resource created successfully!');
            }
            saveData();
            closeResourceModal();
            updateResourcesList();
        }
        function updateResourcesList() {
            const tbody = document.getElementById('resources-list');
            tbody.innerHTML = '';
            let resources = [...db.resources];
            const categoryFilter = document.getElementById('resource-filter-category').value;
            if (categoryFilter) resources = resources.filter(r => r.category === categoryFilter);
            if (resources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No resources found</td></tr>';
            } else {
                resources.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
                resources.forEach(resource => {
                    const pricingInfo = resource.timeBasedPricing ? 
                        `<span style="color: #007bff; font-size: 0.8em;">Time-based</span>` : 
                        `<span style="color: #6c757d; font-size: 0.8em;">Standard</span>`;
                    
                    const combinedInfo = resource.isCombined ? 
                        `<span style="color: #28a745; font-size: 0.8em;">Vehicle+Driver</span>` : '';
                    
                    tbody.innerHTML += `<tr>
                        <td>${resource.id}</td>
                        <td>${resource.name}</td>
                        <td>${resource.category.charAt(0).toUpperCase() + resource.category.slice(1)}</td>
                        <td>${resource.netCost.toFixed(2)}</td>
                        <td>${resource.unit.charAt(0).toUpperCase() + resource.unit.slice(1)}</td>
                        <td>${pricingInfo} ${combinedInfo}</td>
                        <td><div class="action-btn-group"><button onclick="window.editResource('${resource.id}')">Edit</button><button onclick="window.deleteResource('${resource.id}')" class="danger">Delete</button></div></td>
                    </tr>`;
                });
            }
        }
        function editResource(id) {
            const resource = db.resources.find(r => r.id === id);
            if (!resource) return;
            db.editingResource = resource;
            document.getElementById('resource-modal-title').textContent = 'Edit Resource';
            document.getElementById('resource-name').value = resource.name;
            document.getElementById('resource-category').value = resource.category;
            document.getElementById('resource-cost').value = resource.netCost;
            document.getElementById('resource-unit').value = resource.unit;
            
            // Handle time-based pricing fields
            const timeBasedDiv = document.getElementById('time-based-pricing');
            if (timeBasedDiv) {
                timeBasedDiv.style.display = 'block';
                document.getElementById('enable-time-pricing').checked = resource.timeBasedPricing || false;
                document.getElementById('time-pricing-fields').style.display = resource.timeBasedPricing ? 'block' : 'none';
                if (resource.timeBasedPricing) {
                    document.getElementById('standard-rate').value = resource.standardRate || resource.netCost;
                    document.getElementById('overtime-rate').value = resource.overtimeRate || 0;
                    document.getElementById('weekend-rate').value = resource.weekendRate || 0;
                }
            }
            
            document.getElementById('resource-modal').classList.add('active');
        }
        function deleteResource(id) {
            if (!confirm('Are you sure you want to delete this resource?')) return;
            let isUsed = db.priceLists.some(pl => pl.items && pl.items.some(item => item.resourceId === id));
            if (isUsed) {
                alert('Cannot delete this resource as it is used in one or more price lists!');
                return;
            }
            db.resources = db.resources.filter(r => r.id !== id);
            saveData();
            updateResourcesList();
        }
        function filterResources() { updateResourcesList(); }
        function clearResourceFilters() {
            document.getElementById('resource-filter-category').value = '';
            updateResourcesList();
        }

        // ========================================
        // EXCEL IMPORT/EXPORT MANAGEMENT
        // ========================================
        // ========================================
        // EXCEL IMPORT/EXPORT MANAGEMENT
        // ========================================
        
        let excelData = null;
        let columnMapping = {};
        
        // ========================================
        // CALENDAR FILTER
        // ========================================
        
        let calendarClientFilter = '';

        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if it's an Excel file
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                alert('Please select an Excel file (.xlsx or .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // For now, we'll use a simple CSV-like approach
                    // In a real implementation, you'd use a library like SheetJS
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            data.push(row);
                        }
                    }

                    excelData = { headers, data };
                    showExcelPreview();
                } catch (error) {
                    // If CSV parsing fails, try to show a message about Excel format
                    alert('Error reading file. Please ensure your Excel file is in the correct format.\n\nExpected columns:\n- Category\n- Resource Name\n- Monday to Friday 0800 to 1700\n- Monday to Thursday 1700 to 0800\n- Friday PM, Saturday & Sunday\n\nError: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function showExcelPreview() {
            if (!excelData) return;

            const previewDiv = document.getElementById('excel-preview-content');
            const mappingDiv = document.getElementById('column-mapping');
            
            // Show preview
            let previewHTML = '<table style="width: 100%; border-collapse: collapse;">';
            previewHTML += '<tr>';
            excelData.headers.forEach(header => {
                previewHTML += `<th style="border: 1px solid #ddd; padding: 0.5rem; background: #f5f5f5;">${header}</th>`;
            });
            previewHTML += '</tr>';
            
            // Show first 5 rows
            excelData.data.slice(0, 5).forEach(row => {
                previewHTML += '<tr>';
                excelData.headers.forEach(header => {
                    previewHTML += `<td style="border: 1px solid #ddd; padding: 0.5rem;">${row[header] || ''}</td>`;
                });
                previewHTML += '</tr>';
            });
            previewHTML += '</table>';
            
            previewDiv.innerHTML = previewHTML;

            // Auto-map columns
            columnMapping = {
                category: findBestMatch(excelData.headers, ['category', 'type', 'resource type']),
                name: findBestMatch(excelData.headers, ['resource name', 'name', 'description', 'item']),
                standardRate: findBestMatch(excelData.headers, ['monday to friday 0800 to 1700', 'standard rate', 'normal rate', 'day rate']),
                overtimeRate: findBestMatch(excelData.headers, ['monday to thursday 1700 to 0800', 'overtime rate', 'night rate', 'evening rate']),
                weekendRate: findBestMatch(excelData.headers, ['friday pm, saturday & sunday', 'weekend rate', 'saturday sunday', 'weekend'])
            };

            // Show mapping
            mappingHTML = '';
            Object.entries(columnMapping).forEach(([field, header]) => {
                mappingHTML += `
                    <div style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <strong>${field}:</strong> ${header || 'Not mapped'}
                    </div>
                `;
            });
            mappingDiv.innerHTML = mappingHTML;

            document.getElementById('excel-preview').style.display = 'block';
        }

        function findBestMatch(headers, possibleNames) {
            for (let possible of possibleNames) {
                const match = headers.find(h => h.toLowerCase().includes(possible.toLowerCase()));
                if (match) return match;
            }
            return null;
        }

        function importExcelData() {
            if (!excelData) {
                alert('No data to import');
                return;
            }

            const importMode = document.querySelector('input[name="import-mode"]:checked').value;
            let importedCount = 0;
            let updatedCount = 0;
            let skippedCount = 0;

            excelData.data.forEach(row => {
                const category = row[columnMapping.category];
                const name = row[columnMapping.name];
                const standardRate = parseFloat(row[columnMapping.standardRate]) || 0;
                const overtimeRate = parseFloat(row[columnMapping.overtimeRate]) || 0;
                const weekendRate = parseFloat(row[columnMapping.weekendRate]) || 0;

                if (!category || !name) {
                    skippedCount++;
                    return;
                }

                // Determine if this is time-based pricing
                const hasTimeBasedPricing = overtimeRate > 0 || weekendRate > 0;
                const isCombined = category.toLowerCase().includes('driver') && category.toLowerCase().includes('vehicle');

                // Map category to system categories
                let systemCategory = 'other';
                if (category.toLowerCase().includes('human')) systemCategory = 'human';
                else if (category.toLowerCase().includes('vehicle') || category.toLowerCase().includes('driver')) systemCategory = 'vehicles';
                else if (category.toLowerCase().includes('material')) systemCategory = 'materials';
                else if (category.toLowerCase().includes('crate')) systemCategory = 'crates';

                // Determine unit
                let unit = 'hour';
                if (systemCategory === 'materials' || systemCategory === 'crates') unit = 'each';
                else if (systemCategory === 'vehicles' && !isCombined) unit = 'day';

                const newResource = {
                    id: 'RES' + Date.now() + Math.random().toString(36).substr(2, 5),
                    name: name,
                    category: systemCategory,
                    netCost: standardRate,
                    unit: unit,
                    timeBasedPricing: hasTimeBasedPricing,
                    standardRate: standardRate,
                    overtimeRate: overtimeRate,
                    weekendRate: weekendRate,
                    isCombined: isCombined,
                    includesDriver: isCombined
                };

                // Check if resource already exists
                const existingResource = db.resources.find(r => r.name.toLowerCase() === name.toLowerCase());

                if (importMode === 'replace' || !existingResource) {
                    if (existingResource) {
                        // Update existing
                        Object.assign(existingResource, newResource);
                        updatedCount++;
                    } else {
                        // Add new
                        db.resources.push(newResource);
                        importedCount++;
                    }
                } else if (importMode === 'add-new') {
                    // Skip existing
                    skippedCount++;
                } else if (importMode === 'update' && existingResource) {
                    // Update existing only
                    Object.assign(existingResource, newResource);
                    updatedCount++;
                }
            });

            saveData();
            updateResourcesList();
            
            alert(`Import completed!\n\n- New resources: ${importedCount}\n- Updated resources: ${updatedCount}\n- Skipped: ${skippedCount}`);
            
            // Reset form
            document.getElementById('excel-file-input').value = '';
            document.getElementById('excel-preview').style.display = 'none';
            excelData = null;
        }

        function cancelExcelImport() {
            document.getElementById('excel-file-input').value = '';
            document.getElementById('excel-preview').style.display = 'none';
            excelData = null;
        }

        function downloadExcelTemplate() {
            // Create CSV content for Excel template
            const headers = [
                'Category',
                'Resource Name',
                'Monday to Friday 0800 to 1700',
                'Monday to Thursday 1700 to 0800',
                'Friday PM, Saturday & Sunday'
            ];
            
            // Sample data rows based on current resources
            const sampleData = [
                ['Human Resources', 'Porter', '12.00', '16.00', '18.00'],
                ['Human Resources', 'Driver', '15.00', '20.00', '22.00'],
                ['Human Resources', 'Fitter', '18.00', '24.00', '27.00'],
                ['Vehicle and Driver', 'Artic Lorry & Driver', '68.28', '79.70', '85.59'],
                ['Vehicle and Driver', '17 Ton Lorry & Driver', '55.10', '65.09', '70.24'],
                ['Vehicle and Driver', '7.5 Ton Lorry & Driver', '48.35', '57.06', '61.54'],
                ['Vehicle and Driver', '3.5 Ton Van & Driver', '35.97', '43.01', '46.64'],
                ['Materials', 'Moving Box - Standard', '2.50', '', ''],
                ['Materials', 'Moving Box - Large', '3.50', '', ''],
                ['Materials', 'Bubble Wrap Roll', '12.00', '', ''],
                ['Crates', 'Wooden Crate - Small', '45.00', '', ''],
                ['Crates', 'Wooden Crate - Medium', '65.00', '', ''],
                ['Crates', 'Wooden Crate - Large', '85.00', '', '']
            ];
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'pricing_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert(' Excel template downloaded successfully!\n\n Instructions:\n1. Open the CSV file in Excel\n2. Fill in your prices in the appropriate columns\n3. Save as Excel format (.xlsx)\n4. Upload back to import your prices\n\n Tips:\n- Leave empty cells for resources without time-based pricing\n- Use decimal numbers (e.g., 12.50)\n- Vehicle+Driver combinations will be detected automatically');
        }

        function populateExportPriceListSelect() {
            const select = document.getElementById('export-price-list-select');
            select.innerHTML = '<option value="">Select Price List...</option>';
            
            if (db.priceLists && db.priceLists.length > 0) {
                // Sort by base name and version
                const sortedPriceLists = [...db.priceLists].sort((a, b) => {
                    if (a.baseName !== b.baseName) {
                        return a.baseName.localeCompare(b.baseName);
                    }
                    return b.version - a.version; // Newer versions first
                });
                
                sortedPriceLists.forEach(pl => {
                    const versionBadge = pl.version ? `v${String(pl.version).padStart(3, '0')}` : 'v001';
                    const statusText = pl.status === 'active' ? ' (Active)' : ' (Inactive)';
                    select.innerHTML += `<option value="${pl.id}">${pl.baseName} - ${versionBadge}${statusText}</option>`;
                });
            }
        }

        function exportCurrentPrices() {
            // Create CSV content with current resources and their prices
            const headers = [
                'Category',
                'Resource Name',
                'Monday to Friday 0800 to 1700',
                'Monday to Thursday 1700 to 0800',
                'Friday PM, Saturday & Sunday',
                'Unit',
                'Time-Based Pricing',
                'Vehicle+Driver'
            ];
            
            // Get current resources and format them
            const currentData = db.resources.map(resource => {
                // Map category to display name
                let categoryName = resource.category;
                if (resource.category === 'human') categoryName = 'Human Resources';
                else if (resource.category === 'vehicles') {
                    categoryName = resource.isCombined ? 'Vehicle and Driver' : 'Vehicles';
                }
                else if (resource.category === 'materials') categoryName = 'Materials';
                else if (resource.category === 'crates') categoryName = 'Crates';
                else if (resource.category === 'other') categoryName = 'Equipment';
                
                return [
                    categoryName,
                    resource.name,
                    resource.timeBasedPricing ? (resource.standardRate || resource.netCost).toFixed(2) : resource.netCost.toFixed(2),
                    resource.timeBasedPricing ? (resource.overtimeRate || '').toFixed(2) : '',
                    resource.timeBasedPricing ? (resource.weekendRate || '').toFixed(2) : '',
                    resource.unit,
                    resource.timeBasedPricing ? 'Yes' : 'No',
                    resource.isCombined ? 'Yes' : 'No'
                ];
            });
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            currentData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `current_prices_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert(` Current prices exported successfully!\n\n Exported ${currentData.length} resources\n Date: ${new Date().toLocaleDateString()}\n\n You can edit this file and import it back to update prices.`);
        }

        function exportPriceList() {
            const selectedPriceListId = document.getElementById('export-price-list-select').value;
            
            if (!selectedPriceListId) {
                alert('Please select a Price List to export!');
                return;
            }
            
            const priceList = db.priceLists.find(pl => pl.id === selectedPriceListId);
            if (!priceList) {
                alert('Selected Price List not found!');
                return;
            }
            
            // Create CSV content with price list data
            const headers = [
                'Category',
                'Resource Name',
                'Monday to Friday 0800 to 1700',
                'Monday to Thursday 1700 to 0800',
                'Friday PM, Saturday & Sunday',
                'Unit',
                'Time-Based Pricing',
                'Vehicle+Driver',
                'Client Price',
                'Margin %'
            ];
            
            // Get price list items and format them
            const priceListData = [];
            
            if (priceList.items && priceList.items.length > 0) {
                priceList.items.forEach(item => {
                    const resource = db.resources.find(r => r.id === item.resourceId);
                    if (resource) {
                        // Map category to display name
                        let categoryName = resource.category;
                        if (resource.category === 'human') categoryName = 'Human Resources';
                        else if (resource.category === 'vehicles') {
                            categoryName = resource.isCombined ? 'Vehicle and Driver' : 'Vehicles';
                        }
                        else if (resource.category === 'materials') categoryName = 'Materials';
                        else if (resource.category === 'crates') categoryName = 'Crates';
                        else if (resource.category === 'other') categoryName = 'Equipment';
                        
                        // Calculate margin
                        const margin = item.clientPrice > 0 ? ((item.clientPrice - resource.netCost) / item.clientPrice * 100) : 0;
                        
                        priceListData.push([
                            categoryName,
                            resource.name,
                            resource.timeBasedPricing ? (resource.standardRate || resource.netCost).toFixed(2) : resource.netCost.toFixed(2),
                            resource.timeBasedPricing ? (resource.overtimeRate || '').toFixed(2) : '',
                            resource.timeBasedPricing ? (resource.weekendRate || '').toFixed(2) : '',
                            resource.unit,
                            resource.timeBasedPricing ? 'Yes' : 'No',
                            resource.isCombined ? 'Yes' : 'No',
                            item.clientPrice.toFixed(2),
                            margin.toFixed(1) + '%'
                        ]);
                    }
                });
            }
            
            if (priceListData.length === 0) {
                alert('This Price List has no items to export!');
                return;
            }
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            priceListData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${priceList.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert(` Price List exported successfully!\n\n Price List: ${priceList.name}\n Items: ${priceListData.length}\n Date: ${new Date().toLocaleDateString()}\n\n This file contains both resource costs and client prices with margins.`);
        }

        function toggleTimeBasedPricing() {
            const enableCheckbox = document.getElementById('enable-time-pricing');
            const fieldsDiv = document.getElementById('time-pricing-fields');
            
            if (enableCheckbox.checked) {
                fieldsDiv.style.display = 'block';
                // Set default values
                const standardRate = document.getElementById('standard-rate');
                if (!standardRate.value) {
                    standardRate.value = document.getElementById('resource-cost').value || '';
                }
            } else {
                fieldsDiv.style.display = 'none';
            }
        }

        // ========================================
        // PRICE LISTS MANAGEMENT
        // ========================================
        
        function createPriceList() {
            const name = document.getElementById('pricelist-name').value.trim();
            if (!name) { alert('Price list name is required!'); return; }
            const version = 1;
            const formattedName = `${name}-${String(version).padStart(3, '0')}`;
            const priceList = {
                id: 'PL' + Date.now(),
                baseName: name, version: version, name: formattedName,
                status: document.getElementById('pricelist-status').value,
                items: [], created: new Date().toISOString()
            };
            db.priceLists.push(priceList);
            saveData();
            alert('Price List "' + formattedName + '" created successfully!');
            viewPriceList(priceList.id);
        }
        function createPriceListVersion() {
            if (!db.currentPriceList) return;
            const baseName = db.currentPriceList.baseName;
            const allVersions = db.priceLists.filter(pl => pl.baseName === baseName);
            const latestVersion = Math.max(...allVersions.map(pl => pl.version));
            const newVersionNumber = latestVersion + 1;
            const newName = `${baseName}-${String(newVersionNumber).padStart(3, '0')}`;
            const newPriceList = JSON.parse(JSON.stringify(db.currentPriceList));
            newPriceList.id = 'PL' + Date.now();
            newPriceList.version = newVersionNumber;
            newPriceList.name = newName;
            newPriceList.status = 'active';
            newPriceList.created = new Date().toISOString();
            db.priceLists.push(newPriceList);
            saveData();
            alert(`Created new version: ${newName}. You can now edit the prices for this version.`);
            viewPriceList(newPriceList.id);
        }
        function editPriceListItem(resourceId) {
            if (!db.currentPriceList) return;
            const item = db.currentPriceList.items.find(i => i.resourceId === resourceId);
            if (!item) return;
            
            const resource = db.resources.find(r => r.id === resourceId);
            const resourceName = resource ? resource.name : 'Unknown Resource';
            
            const newPrice = prompt(`Edit price for: ${resourceName}\n\nCurrent price: ${item.clientPrice}\nEnter new client price:`, item.clientPrice);
            
            if (newPrice !== null && !isNaN(parseFloat(newPrice)) && parseFloat(newPrice) >= 0) {
                const newPriceValue = parseFloat(newPrice);
                
                // If price is different, create new version automatically
                if (newPriceValue !== item.clientPrice) {
                    // Check if price list is used in any quotes
                    const isUsedInQuotes = db.quotes.some(q => q.priceListId === db.currentPriceList.id);
                    
                    if (isUsedInQuotes) {
                        // Create new version automatically
                        const baseName = db.currentPriceList.baseName;
                        const allVersions = db.priceLists.filter(pl => pl.baseName === baseName);
                        const latestVersion = Math.max(...allVersions.map(pl => pl.version));
                        const newVersionNumber = latestVersion + 1;
                        const newName = `${baseName}-${String(newVersionNumber).padStart(3, '0')}`;
                        
                        // Create new price list version
                        const newPriceList = JSON.parse(JSON.stringify(db.currentPriceList));
                        newPriceList.id = 'PL' + Date.now();
                        newPriceList.version = newVersionNumber;
                        newPriceList.name = newName;
                        newPriceList.status = 'active';
                        newPriceList.created = new Date().toISOString();
                        
                        // Update the price in the new version
                        const newItem = newPriceList.items.find(i => i.resourceId === resourceId);
                        if (newItem) {
                            newItem.clientPrice = newPriceValue;
                        }
                        
                        // Deactivate old version
                        db.currentPriceList.status = 'inactive';
                        
                        // Add new version to database
                        db.priceLists.push(newPriceList);
                        
                        saveData();
                        alert(`Price updated! Created new version: ${newName}\n\nOld version (${db.currentPriceList.name}) has been deactivated.\nNew version is now active.`);
                        viewPriceList(newPriceList.id);
                    } else {
                        // No quotes using this price list, safe to edit directly
                        item.clientPrice = newPriceValue;
                        saveData();
                        alert('Price updated successfully!');
                        viewPriceList(db.currentPriceList.id);
                    }
                }
            } else if (newPrice !== null) {
                alert('Invalid price entered. Please enter a valid number.');
            }
        }
        function updatePriceListsTable() {
            const tbody = document.getElementById('pricelist-table');
            tbody.innerHTML = '';
            if (db.priceLists.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No price lists yet</td></tr>';
            } else {
                // Sort by base name first, then by version (newest first)
                db.priceLists.sort((a,b) => {
                    if (a.baseName !== b.baseName) {
                        return a.baseName.localeCompare(b.baseName);
                    }
                    return b.version - a.version; // Newer versions first
                }).forEach(pl => {
                    const itemCount = pl.items ? pl.items.length : 0;
                    const usedInQuotes = db.quotes.filter(q => q.priceListId === pl.id).length;
                    const statusColor = pl.status === 'active' ? 'green' : 'gray';
                    const statusText = pl.status === 'active' ? 'Active' : 'Inactive';
                    const versionBadge = pl.version ? `v${String(pl.version).padStart(3, '0')}` : 'v001';
                    
                    tbody.innerHTML += `<tr>
                        <td>${pl.baseName || pl.name.split('-')[0]}</td>
                        <td><span style="background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.9em;">${versionBadge}</span></td>
                        <td><span style="color: ${statusColor}; font-weight: bold;">${statusText}</span></td>
                        <td>${itemCount} items</td>
                        <td>${usedInQuotes > 0 ? `<span style="color: orange;">${usedInQuotes} quotes</span>` : '<span style="color: #999;">Not used</span>'}</td>
                        <td>
                            <div class="action-btn-group">
                                <button onclick="window.viewPriceList('${pl.id}')" class="secondary">View</button>
                                ${usedInQuotes === 0 ? `<button onclick="window.deletePriceList('${pl.id}')" class="danger">Delete</button>` : `<span style="color: #999; font-size: 0.8em;">In use</span>`}
                            </div>
                        </td>
                    </tr>`;
                });
            }
        }
        function viewPriceList(id) {
            const priceList = db.priceLists.find(pl => pl.id === id);
            if (!priceList) return;
            db.currentPriceList = priceList;
            document.getElementById('pricelist-title').textContent = priceList.name;
            const toggleBtn = document.getElementById('toggle-status');
            toggleBtn.textContent = priceList.status === 'active' ? 'Deactivate' : 'Activate';
            toggleBtn.className = priceList.status === 'active' ? 'danger' : 'success';
            const tbody = document.getElementById('pricelist-items');
            tbody.innerHTML = '';
            if (!priceList.items || priceList.items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No items in this price list</td></tr>';
            } else {
                priceList.items.sort((a,b) => {
                    const resA = db.resources.find(r => r.id === a.resourceId)?.name || '';
                    const resB = db.resources.find(r => r.id === b.resourceId)?.name || '';
                    return resA.localeCompare(resB);
                }).forEach(item => {
                    const resource = db.resources.find(r => r.id === item.resourceId);
                    if (resource) {
                        const margin = item.clientPrice > 0 ? ((item.clientPrice - resource.netCost) / item.clientPrice * 100) : 0;
                        tbody.innerHTML += `<tr><td>${resource.name}</td><td>${resource.category.charAt(0).toUpperCase() + resource.category.slice(1)}</td><td>${resource.unit.charAt(0).toUpperCase() + resource.unit.slice(1)}</td><td>${resource.netCost.toFixed(2)}</td><td>${item.clientPrice.toFixed(2)}</td><td>${margin.toFixed(1)}%</td><td><div class="action-btn-group"><button onclick="window.editPriceListItem('${item.resourceId}')" class="warning" style="padding: 0.4rem 0.8rem;">Edit</button><button onclick="window.removeResourceFromPriceList('${item.resourceId}')" class="danger" style="padding: 0.4rem 0.8rem;">Remove</button></div></td></tr>`;
                    }
                });
            }
            showPage('pricelist-detail');
        }
        function togglePriceListStatus() {
            if (!db.currentPriceList) return;
            
            const newStatus = db.currentPriceList.status === 'active' ? 'inactive' : 'active';
            const actionText = newStatus === 'inactive' ? 'deactivate' : 'activate';
            
            if (newStatus === 'inactive') {
                // Check if this price list is used in any quotes
                const usedInQuotes = db.quotes.filter(q => q.priceListId === db.currentPriceList.id);
                if (usedInQuotes.length > 0) {
                    const quoteNumbers = usedInQuotes.map(q => q.number).slice(0, 3).join(', ');
                    const moreText = usedInQuotes.length > 3 ? ` and ${usedInQuotes.length - 3} more` : '';
                    
                    if (!confirm(`Warning: This price list is used in ${usedInQuotes.length} quote(s): ${quoteNumbers}${moreText}.\n\nDeactivating will prevent it from being selected for new quotes, but existing quotes will keep their data.\n\nContinue with deactivation?`)) {
                        return;
                    }
                }
                
                alert(`Price list "${db.currentPriceList.name}" has been deactivated.\n\nIt will no longer appear in quote creation options, but existing quotes using this price list will continue to work.`);
            } else {
                alert(`Price list "${db.currentPriceList.name}" has been activated.\n\nIt will now be available for creating new quotes.`);
            }
            
            db.currentPriceList.status = newStatus;
            saveData();
            viewPriceList(db.currentPriceList.id);
        }
        function showAddResourceToPriceList() {
            if (!db.currentPriceList) return;
            const categorySelect = document.getElementById('modal-resource-category-select');
            categorySelect.innerHTML = '<option value="">Select category...</option>';
            document.getElementById('modal-resource-item-select').innerHTML = '<option value="">Select resource...</option>';
            const categories = [...new Set(db.resources.map(r => r.category))];
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`;
            });
            document.getElementById('resource-info').style.display = 'none';
            document.getElementById('margin-info').style.display = 'none';
            document.getElementById('modal-client-price').value = '';
            document.getElementById('add-resource-modal').classList.add('active');
        }
        function closeAddResourceModal() { document.getElementById('add-resource-modal').classList.remove('active'); }
        function populateResourceItemsForCategory() {
            const category = document.getElementById('modal-resource-category-select').value;
            const itemSelect = document.getElementById('modal-resource-item-select');
            itemSelect.innerHTML = '<option value="">Select resource...</option>';
            if (category && db.currentPriceList) {
                const existingResourceIds = db.currentPriceList.items.map(item => item.resourceId);
                const availableResources = db.resources.filter(r => r.category === category && !existingResourceIds.includes(r.id));
                availableResources.forEach(resource => {
                    itemSelect.innerHTML += `<option value="${resource.id}">${resource.name}</option>`;
                });
            }
            updateResourceInfo();
        }
        function updateResourceInfo() {
            const selectedResourceId = document.getElementById('modal-resource-item-select').value;
            const infoDiv = document.getElementById('resource-info');
            if (selectedResourceId) {
                const resource = db.resources.find(r => r.id === selectedResourceId);
                if (resource) {
                    infoDiv.innerHTML = `<strong>Category:</strong> ${resource.category.charAt(0).toUpperCase() + resource.category.slice(1)}<br><strong>Net Cost:</strong> ${resource.netCost.toFixed(2)}<br><strong>Unit:</strong> ${resource.unit.charAt(0).toUpperCase() + resource.unit.slice(1)}`;
                    infoDiv.style.display = 'block';
                    document.getElementById('modal-client-price').value = '';
                    document.getElementById('margin-info').style.display = 'none';
                }
            } else {
                infoDiv.style.display = 'none';
                document.getElementById('margin-info').style.display = 'none';
            }
        }
        function calculateMargin() {
            const selectedResourceId = document.getElementById('modal-resource-item-select').value;
            const clientPrice = parseFloat(document.getElementById('modal-client-price').value);
            const marginDiv = document.getElementById('margin-info');
            if (selectedResourceId && clientPrice > 0) {
                const resource = db.resources.find(r => r.id === selectedResourceId);
                if (resource) {
                    const profit = clientPrice - resource.netCost;
                    const margin = (profit / clientPrice * 100).toFixed(1);
                    marginDiv.innerHTML = `<strong>Profit:</strong> ${profit.toFixed(2)}<br><strong>Margin:</strong> ${margin}%`;
                    marginDiv.style.display = 'block';
                }
            } else {
                marginDiv.style.display = 'none';
            }
        }
        function addResourceToPriceList() {
            if (!db.currentPriceList) return;
            const selectedResourceId = document.getElementById('modal-resource-item-select').value;
            const clientPrice = parseFloat(document.getElementById('modal-client-price').value);
            if (!selectedResourceId || isNaN(clientPrice)) {
                alert('Please select a resource and enter a client price!');
                return;
            }
            if (!db.currentPriceList.items) db.currentPriceList.items = [];
            db.currentPriceList.items.push({ resourceId: selectedResourceId, clientPrice: clientPrice });
            saveData();
            closeAddResourceModal();
            viewPriceList(db.currentPriceList.id);
        }
        function removeResourceFromPriceList(resourceId) {
            if (!db.currentPriceList) return;
            if (confirm('Remove this resource from the price list?')) {
                db.currentPriceList.items = db.currentPriceList.items.filter(item => item.resourceId !== resourceId);
                saveData();
                viewPriceList(db.currentPriceList.id);
            }
        }
        function deletePriceList(id) {
            const priceList = db.priceLists.find(pl => pl.id === id);
            if (!priceList) return;
            
            const usedInQuotes = db.quotes.filter(q => q.priceListId === id);
            if (usedInQuotes.length > 0) {
                const quoteNumbers = usedInQuotes.map(q => q.number).slice(0, 3).join(', ');
                const moreText = usedInQuotes.length > 3 ? ` and ${usedInQuotes.length - 3} more` : '';
                alert(`Cannot delete "${priceList.name}"!\n\nThis price list is used in ${usedInQuotes.length} quote(s): ${quoteNumbers}${moreText}.\n\nTo remove this price list, first delete all quotes that use it, or deactivate it instead.`);
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${priceList.name}"?\n\nThis action cannot be undone and will permanently remove:\n- The price list\n- All its pricing data\n- ${priceList.items ? priceList.items.length : 0} price items`)) return;
            
            db.priceLists = db.priceLists.filter(pl => pl.id !== id);
            saveData();
            updatePriceListsTable();
            alert(`Price list "${priceList.name}" has been deleted successfully.`);
        }

        // --- UTILITY FUNCTIONS ---
        function formatDate(dateStr) { if (!dateStr) return '-'; return new Date(dateStr).toLocaleDateString('en-GB'); }
        function formatDateTime(dateStr) { if (!dateStr) return '-'; const date = new Date(dateStr); return date.toLocaleDateString('en-GB') + ' ' + date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); }
        function resetData() { if (confirm('Are you sure you want to reset ALL data? This cannot be undone!')) { if (confirm('This will delete all PC Numbers, Quotes, Activities, and Price Lists. Are you absolutely sure?')) { localStorage.removeItem('crmDB'); location.reload(); } } }

        // EXPOSE ALL FUNCTIONS TO WINDOW
        window.showPage = showPage;
        window.savePC = savePC;
        window.editPC = editPC;
        window.viewPC = viewPC;
        window.addQuoteFromList = addQuoteFromList;
        window.addActivityFromList = addActivityFromList;
        window.filterPCNumbers = filterPCNumbers;
        window.clearPCFilters = clearPCFilters;
        window.filterQuotes = filterQuotes;
        window.clearQuotesFilter = clearQuotesFilter;
        window.filterActivitiesByCompany = filterActivitiesByCompany;
        window.clearActivitiesCompanyFilter = clearActivitiesCompanyFilter;
        window.createQuote = createQuote;
        window.onPriceListChange = onPriceListChange;
        window.addLineItem = addLineItem;
        window.toggleManualPrice = toggleManualPrice;
        window.updateLinePrice = updateLinePrice;
        window.updateLineQty = updateLineQty;
        window.updateLineRate = updateLineRate;
        window.removeLine = removeLine;
        window.addOtherCost = addOtherCost;
        window.updateOtherCost = updateOtherCost;
        window.removeOtherCost = removeOtherCost;
        window.calculateTotal = calculateTotal;
        window.saveQuote = saveQuote;
        window.cancelQuote = cancelQuote;
        window.showNewQuoteModal = showNewQuoteModal;
        window.closeQuoteModal = closeQuoteModal;
        window.proceedToQuoteBuilder = proceedToQuoteBuilder;
        window.viewQuote = viewQuote;
        window.changeQuoteStatus = changeQuoteStatus;
        window.editQuote = editQuote;
        window.editQuoteFromList = editQuoteFromList;
        window.duplicateQuote = duplicateQuote;
        window.createActivityFromCurrentQuote = createActivityFromCurrentQuote;
        window.createActivityFromQuoteList = createActivityFromQuoteList;
        window.showActivityModal = showActivityModal;
        window.saveActivity = saveActivity; 
        window.filterActivities = filterActivities;
        window.clearActivityFilters = clearActivityFilters;
        window.viewActivity = viewActivity; 
        window.editActivity = editActivity;
        window.addActivityNote = addActivityNote; 
        window.loadActivityResources = loadActivityResources;
        window.addResourceRow = addResourceRow;
        window.collectActivityResources = collectActivityResources;
        window.showActivityModalFromList = showActivityModalFromList;
        window.updatePCList = updatePCList;
        window.updateActivitiesList = updateActivitiesList;
        window.updateQuotesList = updateQuotesList;
        window.renderCalendar = renderCalendar;
        window.changeCalendarView = changeCalendarView;
        window.navigateCalendar = navigateCalendar;
        window.viewDayActivities = viewDayActivities;
        window.createPriceList = createPriceList;
        window.createPriceListVersion = createPriceListVersion;
        window.editPriceListItem = editPriceListItem;
        window.viewPriceList = viewPriceList;
        window.togglePriceListStatus = togglePriceListStatus;
        window.showAddResourceToPriceList = showAddResourceToPriceList;
        window.closeAddResourceModal = closeAddResourceModal;
        window.populateResourceItemsForCategory = populateResourceItemsForCategory;
        window.updateResourceInfo = updateResourceInfo;
        window.calculateMargin = calculateMargin;
        window.addResourceToPriceList = addResourceToPriceList;
        window.removeResourceFromPriceList = removeResourceFromPriceList;
        window.deletePriceList = deletePriceList;
        window.resetData = resetData;
        window.showResourceModal = showResourceModal;
        window.closeResourceModal = closeResourceModal;
        window.saveResource = saveResource;
        window.editResource = editResource;
        window.deleteResource = deleteResource;
        window.filterResources = filterResources;
        window.clearResourceFilters = clearResourceFilters;
        window.updateResourcesList = updateResourcesList;
        window.getResourceRate = getResourceRate;
        window.downloadExcelTemplate = downloadExcelTemplate;
        window.exportCurrentPrices = exportCurrentPrices;
        window.exportPriceList = exportPriceList;
        window.populateExportPriceListSelect = populateExportPriceListSelect;
        window.filterCalendarByClient = filterCalendarByClient;
        window.clearCalendarFilter = clearCalendarFilter;

        // === RESOURCE DETAILS FUNCTIONS ===
        
        function updateResourceDetails() {
            updateEmployeesList();
            updateVehiclesList();
            updateVehicleDriverOptions();
        }
        
        // === EMPLOYEE FUNCTIONS ===
        
        function showEmployeeModal(id = null) {
            const modal = document.getElementById('employee-modal');
            const title = document.getElementById('employee-modal-title');
            
            if (id) {
                // Edit mode
                const employee = db.employees.find(e => e.id === id);
                if (!employee) return;
                
                title.textContent = 'Edit Employee';
                db.editingEmployee = employee;
                
                // Populate form
                document.getElementById('employee-name').value = employee.name || '';
                document.getElementById('employee-role').value = employee.role || '';
                document.getElementById('employee-phone').value = employee.phone || '';
                document.getElementById('employee-email').value = employee.email || '';
                document.getElementById('employee-status').value = employee.status || 'active';
                document.getElementById('employee-start-date').value = employee.startDate || '';
                document.getElementById('employee-emergency-name').value = employee.emergencyName || '';
                document.getElementById('employee-emergency-phone').value = employee.emergencyPhone || '';
                document.getElementById('employee-address').value = employee.address || '';
                document.getElementById('employee-notes').value = employee.notes || '';
            } else {
                // Add mode
                title.textContent = 'Add Employee';
                db.editingEmployee = null;
                
                // Clear form
                document.getElementById('employee-name').value = '';
                document.getElementById('employee-role').value = '';
                document.getElementById('employee-phone').value = '';
                document.getElementById('employee-email').value = '';
                document.getElementById('employee-status').value = 'active';
                document.getElementById('employee-start-date').value = '';
                document.getElementById('employee-emergency-name').value = '';
                document.getElementById('employee-emergency-phone').value = '';
                document.getElementById('employee-address').value = '';
                document.getElementById('employee-notes').value = '';
            }
            
            modal.style.display = 'block';
        }
        
        function closeEmployeeModal() {
            document.getElementById('employee-modal').style.display = 'none';
            db.editingEmployee = null;
        }
        
        function saveEmployee() {
            const name = document.getElementById('employee-name').value.trim();
            const role = document.getElementById('employee-role').value;
            const phone = document.getElementById('employee-phone').value.trim();
            const email = document.getElementById('employee-email').value.trim();
            const status = document.getElementById('employee-status').value;
            const startDate = document.getElementById('employee-start-date').value;
            const emergencyName = document.getElementById('employee-emergency-name').value.trim();
            const emergencyPhone = document.getElementById('employee-emergency-phone').value.trim();
            const address = document.getElementById('employee-address').value.trim();
            const notes = document.getElementById('employee-notes').value.trim();
            
            if (!name || !role || !phone) {
                alert('Please fill in all required fields (Name, Role, Phone)');
                return;
            }
            
            if (db.editingEmployee) {
                // Update existing employee
                db.editingEmployee.name = name;
                db.editingEmployee.role = role;
                db.editingEmployee.phone = phone;
                db.editingEmployee.email = email;
                db.editingEmployee.status = status;
                db.editingEmployee.startDate = startDate;
                db.editingEmployee.emergencyName = emergencyName;
                db.editingEmployee.emergencyPhone = emergencyPhone;
                db.editingEmployee.address = address;
                db.editingEmployee.notes = notes;
                db.editingEmployee.updatedAt = new Date().toISOString();
            } else {
                // Create new employee
                const newEmployee = {
                    id: 'emp_' + Date.now(),
                    name: name,
                    role: role,
                    phone: phone,
                    email: email,
                    status: status,
                    startDate: startDate,
                    emergencyName: emergencyName,
                    emergencyPhone: emergencyPhone,
                    address: address,
                    notes: notes,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                db.employees.push(newEmployee);
            }
            
            saveData();
            closeEmployeeModal();
            updateResourceDetails();
        }
        
        function editEmployee(id) {
            showEmployeeModal(id);
        }
        
        function deleteEmployee(id) {
            const employee = db.employees.find(e => e.id === id);
            if (!employee) return;
            
            // Check if employee is assigned to any vehicles
            const assignedVehicles = db.vehicles.filter(v => v.assignedDriver === id);
            if (assignedVehicles.length > 0) {
                const vehicleRegs = assignedVehicles.map(v => v.registration).join(', ');
                if (!confirm(`Employee "${employee.name}" is assigned to vehicle(s): ${vehicleRegs}\n\nDeleting this employee will unassign them from these vehicles. Continue?`)) {
                    return;
                }
                // Unassign from vehicles
                assignedVehicles.forEach(v => v.assignedDriver = '');
            }
            
            if (confirm(`Are you sure you want to delete employee "${employee.name}"?`)) {
                db.employees = db.employees.filter(e => e.id !== id);
                saveData();
                updateResourceDetails();
            }
        }
        
        function updateEmployeesList() {
            const tbody = document.getElementById('employees-list');
            if (!tbody) return;
            
            let employees = [...db.employees];
            
            // Apply filters
            const roleFilter = document.getElementById('employee-role-filter')?.value || '';
            const statusFilter = document.getElementById('employee-status-filter')?.value || '';
            
            if (roleFilter) {
                employees = employees.filter(e => e.role === roleFilter);
            }
            if (statusFilter) {
                employees = employees.filter(e => e.status === statusFilter);
            }
            
            tbody.innerHTML = employees.map(employee => `
                <tr>
                    <td>${employee.name}</td>
                    <td><span class="badge">${employee.role.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></td>
                    <td>${employee.phone}</td>
                    <td>${employee.email || '-'}</td>
                    <td><span class="activity-status ${employee.status}">${employee.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></td>
                    <td>${formatDate(employee.startDate)}</td>
                    <td>
                        <div class="action-btn-group">
                            <button onclick="window.editEmployee('${employee.id}')" class="secondary">Edit</button>
                            <button onclick="window.deleteEmployee('${employee.id}')" class="danger">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterEmployees() {
            updateEmployeesList();
        }
        
        function clearEmployeeFilters() {
            document.getElementById('employee-role-filter').value = '';
            document.getElementById('employee-status-filter').value = '';
            updateEmployeesList();
        }
        
        // === VEHICLE FUNCTIONS ===
        
        function showVehicleModal(id = null) {
            const modal = document.getElementById('vehicle-modal');
            const title = document.getElementById('vehicle-modal-title');
            
            // Update driver options
            updateVehicleDriverOptions();
            
            if (id) {
                // Edit mode
                const vehicle = db.vehicles.find(v => v.id === id);
                if (!vehicle) return;
                
                title.textContent = 'Edit Vehicle';
                db.editingVehicle = vehicle;
                
                // Populate form
                document.getElementById('vehicle-registration').value = vehicle.registration || '';
                document.getElementById('vehicle-type').value = vehicle.type || '';
                document.getElementById('vehicle-make').value = vehicle.make || '';
                document.getElementById('vehicle-model').value = vehicle.model || '';
                document.getElementById('vehicle-year').value = vehicle.year || '';
                document.getElementById('vehicle-capacity').value = vehicle.capacity || '';
                document.getElementById('vehicle-fuel').value = vehicle.fuel || '';
                document.getElementById('vehicle-status').value = vehicle.status || 'active';
                document.getElementById('vehicle-driver').value = vehicle.assignedDriver || '';
                document.getElementById('vehicle-mot-date').value = vehicle.motDate || '';
                document.getElementById('vehicle-insurance-date').value = vehicle.insuranceDate || '';
                document.getElementById('vehicle-service-date').value = vehicle.serviceDate || '';
                document.getElementById('vehicle-notes').value = vehicle.notes || '';
            } else {
                // Add mode
                title.textContent = 'Add Vehicle';
                db.editingVehicle = null;
                
                // Clear form
                document.getElementById('vehicle-registration').value = '';
                document.getElementById('vehicle-type').value = '';
                document.getElementById('vehicle-make').value = '';
                document.getElementById('vehicle-model').value = '';
                document.getElementById('vehicle-year').value = '';
                document.getElementById('vehicle-capacity').value = '';
                document.getElementById('vehicle-fuel').value = '';
                document.getElementById('vehicle-status').value = 'active';
                document.getElementById('vehicle-driver').value = '';
                document.getElementById('vehicle-mot-date').value = '';
                document.getElementById('vehicle-insurance-date').value = '';
                document.getElementById('vehicle-service-date').value = '';
                document.getElementById('vehicle-notes').value = '';
            }
            
            modal.style.display = 'block';
        }
        
        function closeVehicleModal() {
            document.getElementById('vehicle-modal').style.display = 'none';
            db.editingVehicle = null;
        }
        
        function saveVehicle() {
            const registration = document.getElementById('vehicle-registration').value.trim().toUpperCase();
            const type = document.getElementById('vehicle-type').value;
            const make = document.getElementById('vehicle-make').value.trim();
            const model = document.getElementById('vehicle-model').value.trim();
            const year = document.getElementById('vehicle-year').value;
            const capacity = document.getElementById('vehicle-capacity').value.trim();
            const fuel = document.getElementById('vehicle-fuel').value;
            const status = document.getElementById('vehicle-status').value;
            const assignedDriver = document.getElementById('vehicle-driver').value;
            const motDate = document.getElementById('vehicle-mot-date').value;
            const insuranceDate = document.getElementById('vehicle-insurance-date').value;
            const serviceDate = document.getElementById('vehicle-service-date').value;
            const notes = document.getElementById('vehicle-notes').value.trim();
            
            if (!registration || !type) {
                alert('Please fill in all required fields (Registration, Type)');
                return;
            }
            
            // Check for duplicate registration (excluding current vehicle if editing)
            const existingVehicle = db.vehicles.find(v => v.registration === registration && (!db.editingVehicle || v.id !== db.editingVehicle.id));
            if (existingVehicle) {
                alert(`A vehicle with registration "${registration}" already exists!`);
                return;
            }
            
            if (db.editingVehicle) {
                // Update existing vehicle
                db.editingVehicle.registration = registration;
                db.editingVehicle.type = type;
                db.editingVehicle.make = make;
                db.editingVehicle.model = model;
                db.editingVehicle.year = year;
                db.editingVehicle.capacity = capacity;
                db.editingVehicle.fuel = fuel;
                db.editingVehicle.status = status;
                db.editingVehicle.assignedDriver = assignedDriver;
                db.editingVehicle.motDate = motDate;
                db.editingVehicle.insuranceDate = insuranceDate;
                db.editingVehicle.serviceDate = serviceDate;
                db.editingVehicle.notes = notes;
                db.editingVehicle.updatedAt = new Date().toISOString();
            } else {
                // Create new vehicle
                const newVehicle = {
                    id: 'veh_' + Date.now(),
                    registration: registration,
                    type: type,
                    make: make,
                    model: model,
                    year: year,
                    capacity: capacity,
                    fuel: fuel,
                    status: status,
                    assignedDriver: assignedDriver,
                    motDate: motDate,
                    insuranceDate: insuranceDate,
                    serviceDate: serviceDate,
                    notes: notes,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                db.vehicles.push(newVehicle);
            }
            
            saveData();
            closeVehicleModal();
            updateResourceDetails();
        }
        
        function editVehicle(id) {
            showVehicleModal(id);
        }
        
        function deleteVehicle(id) {
            const vehicle = db.vehicles.find(v => v.id === id);
            if (!vehicle) return;
            
            if (confirm(`Are you sure you want to delete vehicle "${vehicle.registration}"?`)) {
                db.vehicles = db.vehicles.filter(v => v.id !== id);
                saveData();
                updateResourceDetails();
            }
        }
        
        function updateVehiclesList() {
            const tbody = document.getElementById('vehicles-list');
            if (!tbody) return;
            
            let vehicles = [...db.vehicles];
            
            // Apply filters
            const typeFilter = document.getElementById('vehicle-type-filter')?.value || '';
            const statusFilter = document.getElementById('vehicle-status-filter')?.value || '';
            
            if (typeFilter) {
                vehicles = vehicles.filter(v => v.type === typeFilter);
            }
            if (statusFilter) {
                vehicles = vehicles.filter(v => v.status === statusFilter);
            }
            
            tbody.innerHTML = vehicles.map(vehicle => {
                const assignedEmployee = vehicle.assignedDriver ? db.employees.find(e => e.id === vehicle.assignedDriver) : null;
                const driverName = assignedEmployee ? assignedEmployee.name : '-';
                const makeModel = [vehicle.make, vehicle.model].filter(Boolean).join(' ') || '-';
                
                return `
                    <tr>
                        <td><strong>${vehicle.registration}</strong></td>
                        <td><span class="badge">${vehicle.type.charAt(0).toUpperCase() + vehicle.type.slice(1)}</span></td>
                        <td>${makeModel}</td>
                        <td>${vehicle.capacity || '-'}</td>
                        <td>${driverName}</td>
                        <td><span class="activity-status ${vehicle.status}">${vehicle.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></td>
                        <td>${formatDate(vehicle.motDate)}</td>
                        <td>
                            <div class="action-btn-group">
                                <button onclick="window.editVehicle('${vehicle.id}')" class="secondary">Edit</button>
                                <button onclick="window.deleteVehicle('${vehicle.id}')" class="danger">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterVehicles() {
            updateVehiclesList();
        }
        
        function clearVehicleFilters() {
            document.getElementById('vehicle-type-filter').value = '';
            document.getElementById('vehicle-status-filter').value = '';
            updateVehiclesList();
        }
        
        function updateVehicleDriverOptions() {
            const driverSelect = document.getElementById('vehicle-driver');
            if (!driverSelect) return;
            
            // Get active drivers
            const drivers = db.employees.filter(e => e.status === 'active' && (e.role === 'driver' || e.role === 'manager' || e.role === 'supervisor'));
            
            driverSelect.innerHTML = '<option value="">Select driver...</option>';
            drivers.forEach(driver => {
                driverSelect.innerHTML += `<option value="${driver.id}">${driver.name}</option>`;
            });
        }

        // === ACTIVITY VERSIONING FUNCTIONS ===
        
        function generateNextActivityVersion(baseId) {
            // Remove existing version suffix if present (e.g., ACT-000001-002 -> ACT-000001)
            const cleanBaseId = baseId.replace(/-\d{3}$/, '');
            
            // Find all versions of this activity
            const existingVersions = db.activities
                .filter(a => (a.crmId || a.id).startsWith(cleanBaseId + '-'))
                .map(a => {
                    const match = (a.crmId || a.id).match(/-(\d{3})$/);
                    return match ? parseInt(match[1]) : 0;
                });
            
            // Also check if the base ID itself exists (version 1)
            const baseExists = db.activities.some(a => (a.crmId || a.id) === cleanBaseId);
            if (baseExists) existingVersions.push(1);
            
            // Find the next version number
            const nextVersion = existingVersions.length > 0 ? Math.max(...existingVersions) + 1 : 2;
            
            return `${cleanBaseId}-${String(nextVersion).padStart(3, '0')}`;
        }
        
        function getActivityVersionNumber(versionId) {
            const match = versionId.match(/-(\d{3})$/);
            return match ? parseInt(match[1]) : 1;
        }
        
        function editActivityFromList(id) {
            const activity = db.activities.find(a => a.id === id);
            if (!activity) return;
            
            // Set up editing mode
            db.editingActivity = activity;
            db.currentPC = db.pcs.find(p => p.id === activity.pcId);
            
            // Open activity modal with existing data
            document.getElementById('activity-modal-title').textContent = `Edit Activity: ${activity.crmId || activity.id}`;
            
            // Initialize client and PC lists for editing
            populateActivityClientList();
            populateActivityPCList();
            
            // Pre-select the client and PC for editing
            if (activity.pcId) {
                const pc = db.pcs.find(p => p.id === activity.pcId);
                if (pc) {
                    document.getElementById('activity-client-search').value = pc.company;
                    document.getElementById('activity-pc-select').value = activity.pcId;
                }
            }
            
            // Populate form with existing data
            document.getElementById('activity-name').value = activity.name || '';
            document.getElementById('activity-type').value = activity.type || '';
            document.getElementById('activity-department').value = activity.department || '';
            document.getElementById('activity-status').value = activity.status || 'Pending';
            document.getElementById('activity-date').value = activity.date || '';
            document.getElementById('activity-time-depot-start').value = activity.timeDepotStart || '';
            document.getElementById('activity-time-site-start').value = activity.timeSiteStart || '';
            document.getElementById('activity-time-site-finish').value = activity.timeSiteFinish || '';
            document.getElementById('activity-time-depot-finish').value = activity.timeDepotFinish || '';
            document.getElementById('activity-hours').value = activity.hours || '';
            document.getElementById('activity-payment-type').value = activity.paymentType || '';
            document.getElementById('activity-instructions').value = activity.instructions || '';
            document.getElementById('activity-parking-required').checked = activity.parkingRequired || false;
            document.getElementById('activity-confirmed').checked = activity.confirmed || false;
            document.getElementById('activity-risk-assessment').checked = activity.riskAssessmentNeeded || false;
            
            // Populate addresses
            if (activity.collectionAddress) {
                document.getElementById('activity-collection-firstname').value = activity.collectionAddress.firstName || '';
                document.getElementById('activity-collection-lastname').value = activity.collectionAddress.lastName || '';
                document.getElementById('activity-collection-email').value = activity.collectionAddress.email || '';
                document.getElementById('activity-collection-phone').value = activity.collectionAddress.phone || '';
                document.getElementById('activity-collection-country').value = activity.collectionAddress.country || '';
                document.getElementById('activity-collection-address').value = activity.collectionAddress.address || '';
            }
            
            if (activity.deliveryAddress) {
                document.getElementById('activity-delivery-firstname').value = activity.deliveryAddress.firstName || '';
                document.getElementById('activity-delivery-lastname').value = activity.deliveryAddress.lastName || '';
                document.getElementById('activity-delivery-email').value = activity.deliveryAddress.email || '';
                document.getElementById('activity-delivery-phone').value = activity.deliveryAddress.phone || '';
                document.getElementById('activity-delivery-country').value = activity.deliveryAddress.country || '';
                document.getElementById('activity-delivery-address').value = activity.deliveryAddress.address || '';
            }
            
            document.getElementById('activity-moveman').value = activity.movemanJob || '';
            
            // Populate quote selection
            const quoteSelect = document.getElementById('activity-quote');
            quoteSelect.innerHTML = '<option value="">Select quote...</option>';
            
            if (activity.pcId) {
                const quotes = db.quotes.filter(q => q.pcId === activity.pcId);
                if (quotes.length > 0) {
                    quoteSelect.disabled = false;
                    quotes.forEach(q => {
                        const selected = q.id === activity.quoteId ? 'selected' : '';
                        quoteSelect.innerHTML += `<option value="${q.id}" ${selected}>${q.number} - ${q.total.toFixed(2)}</option>`;
                    });
                }
            }
            
            // Show modal
            document.getElementById('activity-modal').style.display = 'block';
        }

        // ========================================
        // DATABASE EXPORT/IMPORT MANAGEMENT
        // ========================================
        
        function exportDatabase() {
            try {
                // Prepare data for export
                const exportData = {
                    pcs: db.pcs || [],
                    quotes: db.quotes || [],
                    activities: db.activities || [],
                    priceLists: db.priceLists || [],
                    resources: db.resources || [],
                    employees: db.employees || [],
                    vehicles: db.vehicles || [],
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    systemInfo: {
                        userAgent: navigator.userAgent,
                        timestamp: Date.now(),
                        recordCounts: {
                            pcs: (db.pcs || []).length,
                            quotes: (db.quotes || []).length,
                            activities: (db.activities || []).length,
                            priceLists: (db.priceLists || []).length,
                            resources: (db.resources || []).length,
                            employees: (db.employees || []).length,
                            vehicles: (db.vehicles || []).length
                        }
                    }
                };
                
                // Convert to JSON
                const dataStr = JSON.stringify(exportData, null, 2);
                
                // Create downloadable file
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                // Auto download
                const link = document.createElement('a');
                link.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                link.download = `crm-database-${dateStr}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                const totalRecords = Object.values(exportData.systemInfo.recordCounts).reduce((sum, count) => sum + count, 0);
                alert(` Database exported successfully!\n\nFile: crm-database-${dateStr}.json\nTotal records: ${totalRecords}\n\nExported:\n- ${exportData.systemInfo.recordCounts.pcs} PC Numbers\n- ${exportData.systemInfo.recordCounts.quotes} Quotes\n- ${exportData.systemInfo.recordCounts.activities} Activities\n- ${exportData.systemInfo.recordCounts.priceLists} Price Lists\n- ${exportData.systemInfo.recordCounts.resources} Resources\n- ${exportData.systemInfo.recordCounts.employees} Employees\n- ${exportData.systemInfo.recordCounts.vehicles} Vehicles`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(' Export failed: ' + error.message);
            }
        }
        
        function showImportModal() {
            // Remove existing modal if any
            const existingModal = document.querySelector('.import-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.className = 'modal import-modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h2> Import Database</h2>
                    
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin: 1rem 0; border-left: 4px solid #ffc107;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #856404;"> WARNING</h4>
                        <p style="margin: 0; color: #856404;">This will <strong>REPLACE ALL</strong> existing data with the imported data. This action cannot be undone!</p>
                    </div>
                    
                    <div style="margin: 1rem 0;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Select JSON file:</label>
                        <input type="file" id="import-file" accept=".json" style="width: 100%; padding: 0.5rem; border: 2px dashed #ddd; border-radius: 4px;">
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                            Only JSON files exported from this CRM system are supported
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e9; padding: 1rem; border-radius: 4px; margin: 1rem 0; border-left: 4px solid #4caf50;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2e7d32;"> What will be imported:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin: 0.5rem 0; color: #2e7d32;">
                            <div> PC Numbers</div>
                            <div> Employees</div>
                            <div> Quotes</div>
                            <div> Vehicles</div>
                            <div> Activities</div>
                            <div> Price Lists</div>
                            <div> Resources</div>
                            <div> All settings</div>
                        </div>
                    </div>
                    
                    <div id="import-file-info" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                        <h4 style="margin: 0 0 0.5rem 0;"> File Information:</h4>
                        <div id="import-file-details"></div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button onclick="window.closeImportModal()" class="secondary">Cancel</button>
                        <button onclick="window.importDatabase()" class="danger" id="import-btn" disabled>
                             Import & Replace All Data
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add file input listener
            document.getElementById('import-file').addEventListener('change', function() {
                const file = this.files[0];
                const importBtn = document.getElementById('import-btn');
                const fileInfo = document.getElementById('import-file-info');
                const fileDetails = document.getElementById('import-file-details');
                
                if (file) {
                    if (file.type === 'application/json' || file.name.endsWith('.json')) {
                        // Try to read and validate file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const data = JSON.parse(e.target.result);
                                
                                // Validate structure
                                const requiredFields = ['pcs', 'quotes', 'activities', 'priceLists', 'resources'];
                                const hasRequiredFields = requiredFields.every(field => data.hasOwnProperty(field));
                                
                                if (hasRequiredFields) {
                                    // Show file info
                                    const counts = data.systemInfo?.recordCounts || {
                                        pcs: (data.pcs || []).length,
                                        quotes: (data.quotes || []).length,
                                        activities: (data.activities || []).length,
                                        priceLists: (data.priceLists || []).length,
                                        resources: (data.resources || []).length,
                                        employees: (data.employees || []).length,
                                        vehicles: (data.vehicles || []).length
                                    };
                                    
                                    const totalRecords = Object.values(counts).reduce((sum, count) => sum + count, 0);
                                    const exportDate = data.exportDate ? new Date(data.exportDate).toLocaleDateString() : 'Unknown';
                                    
                                    fileDetails.innerHTML = `
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                                            <div><strong>Export Date:</strong> ${exportDate}</div>
                                            <div><strong>Total Records:</strong> ${totalRecords}</div>
                                            <div><strong>PC Numbers:</strong> ${counts.pcs}</div>
                                            <div><strong>Employees:</strong> ${counts.employees || 0}</div>
                                            <div><strong>Quotes:</strong> ${counts.quotes}</div>
                                            <div><strong>Vehicles:</strong> ${counts.vehicles || 0}</div>
                                            <div><strong>Activities:</strong> ${counts.activities}</div>
                                            <div><strong>Price Lists:</strong> ${counts.priceLists}</div>
                                            <div><strong>Resources:</strong> ${counts.resources}</div>
                                            <div><strong>File Size:</strong> ${(file.size / 1024).toFixed(1)} KB</div>
                                        </div>
                                    `;
                                    
                                    fileInfo.style.display = 'block';
                                    importBtn.disabled = false;
                                    importBtn.style.background = '#dc3545';
                                } else {
                                    fileDetails.innerHTML = '<div style="color: #dc3545;"> Invalid file format. Missing required data fields.</div>';
                                    fileInfo.style.display = 'block';
                                    importBtn.disabled = true;
                                }
                            } catch (error) {
                                fileDetails.innerHTML = '<div style="color: #dc3545;"> Invalid JSON file. Cannot parse file content.</div>';
                                fileInfo.style.display = 'block';
                                importBtn.disabled = true;
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        fileDetails.innerHTML = '<div style="color: #dc3545;"> Please select a JSON file.</div>';
                        fileInfo.style.display = 'block';
                        importBtn.disabled = true;
                    }
                } else {
                    fileInfo.style.display = 'none';
                    importBtn.disabled = true;
                }
            });
        }
        
        function closeImportModal() {
            const modal = document.querySelector('.import-modal');
            if (modal) modal.remove();
        }
        
        function importDatabase() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file!');
                return;
            }
            
            if (!confirm(' FINAL WARNING!\n\nYou are about to PERMANENTLY DELETE all current data and replace it with imported data.\n\nThis includes:\n- All PC Numbers\n- All Quotes\n- All Activities\n- All Price Lists\n- All Resources\n- All Employees\n- All Vehicles\n\nThis action CANNOT be undone!\n\nAre you ABSOLUTELY sure you want to continue?')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    const requiredFields = ['pcs', 'quotes', 'activities', 'priceLists', 'resources'];
                    const missingFields = requiredFields.filter(field => !importedData.hasOwnProperty(field));
                    
                    if (missingFields.length > 0) {
                        throw new Error(`Invalid file format. Missing required fields: ${missingFields.join(', ')}`);
                    }
                    
                    // Create backup before import
                    const backupData = {
                        ...db,
                        backupDate: new Date().toISOString(),
                        backupReason: 'Pre-import backup'
                    };
                    const backupKey = 'crmDB_backup_' + Date.now();
                    localStorage.setItem(backupKey, JSON.stringify(backupData));
                    
                    // Import data
                    db.pcs = Array.isArray(importedData.pcs) ? importedData.pcs : [];
                    db.quotes = Array.isArray(importedData.quotes) ? importedData.quotes : [];
                    db.activities = Array.isArray(importedData.activities) ? importedData.activities : [];
                    db.priceLists = Array.isArray(importedData.priceLists) ? importedData.priceLists : [];
                    db.resources = Array.isArray(importedData.resources) ? importedData.resources : [];
                    db.employees = Array.isArray(importedData.employees) ? importedData.employees : [];
                    db.vehicles = Array.isArray(importedData.vehicles) ? importedData.vehicles : [];
                    
                    // Reset other state
                    db.currentPC = null;
                    db.editingPC = null;
                    db.currentPriceList = null;
                    db.currentActivity = null;
                    db.currentQuote = null;
                    db.currentResource = null;
                    db.currentEmployee = null;
                    db.currentVehicle = null;
                    
                    // Save to localStorage
                    saveData();
                    
                    // Close modal
                    closeImportModal();
                    
                    // Show success message
                    const counts = {
                        pcs: db.pcs.length,
                        quotes: db.quotes.length,
                        activities: db.activities.length,
                        priceLists: db.priceLists.length,
                        resources: db.resources.length,
                        employees: db.employees.length,
                        vehicles: db.vehicles.length
                    };
                    
                    const totalRecords = Object.values(counts).reduce((sum, count) => sum + count, 0);
                    
                    alert(` Database imported successfully!\n\nImported ${totalRecords} total records:\n- ${counts.pcs} PC Numbers\n- ${counts.quotes} Quotes\n- ${counts.activities} Activities\n- ${counts.priceLists} Price Lists\n- ${counts.resources} Resources\n- ${counts.employees} Employees\n- ${counts.vehicles} Vehicles\n\nBackup created: ${backupKey}\n\nPage will refresh now to update all views.`);
                    
                    // Refresh page to update all views
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert(' Import failed!\n\nError: ' + error.message + '\n\nPlease ensure you selected a valid CRM database JSON file exported from this system.');
                }
            };
            
            reader.readAsText(file);
        }

        // Expose new functions to window
        window.updateResourceDetails = updateResourceDetails;
        window.showEmployeeModal = showEmployeeModal;
        window.closeEmployeeModal = closeEmployeeModal;
        window.saveEmployee = saveEmployee;
        window.editEmployee = editEmployee;
        window.deleteEmployee = deleteEmployee;
        window.filterEmployees = filterEmployees;
        window.clearEmployeeFilters = clearEmployeeFilters;
        window.showVehicleModal = showVehicleModal;
        window.closeVehicleModal = closeVehicleModal;
        window.saveVehicle = saveVehicle;
        window.editVehicle = editVehicle;
        window.deleteVehicle = deleteVehicle;
        window.filterVehicles = filterVehicles;
        window.clearVehicleFilters = clearVehicleFilters;
        window.editActivityFromList = editActivityFromList;
        window.exportDatabase = exportDatabase;
        window.showImportModal = showImportModal;
        window.closeImportModal = closeImportModal;
        window.importDatabase = importDatabase;
        
        // === NAVIGATION FUNCTIONS FOR COUNTS ===
        
        function goToQuotesForPC(pcId) {
            // Go to quotes page and filter by PC
            showPage('quotes');
            
            // Wait for page to load then filter
            setTimeout(() => {
                const pc = db.pcs.find(p => p.id === pcId);
                if (pc) {
                    // Filter quotes for this PC
                    const quotesForPC = db.quotes.filter(q => q.pcId === pcId);
                    updateQuotesList(quotesForPC);
                    
                    // Update filter input to show company name
                    const companyFilter = document.getElementById('quotes-company-filter');
                    if (companyFilter) {
                        companyFilter.value = pc.company;
                    }
                    
                    // Update results counter
                    const resultsCount = document.getElementById('quotes-results-count');
                    if (resultsCount) {
                        resultsCount.textContent = `Showing ${quotesForPC.length} quotes for ${pc.company} (${pc.number})`;
                    }
                }
            }, 100);
        }
        
        function goToActivitiesForPC(pcId) {
            // Go to activities page and filter by PC
            showPage('activities');
            
            // Wait for page to load then filter
            setTimeout(() => {
                const pc = db.pcs.find(p => p.id === pcId);
                if (pc) {
                    // Filter activities for this PC
                    const activitiesForPC = db.activities.filter(a => a.pcId === pcId);
                    updateActivitiesList(activitiesForPC);
                    
                    // Update filter input to show company name
                    const companyFilter = document.getElementById('activities-company-filter');
                    if (companyFilter) {
                        companyFilter.value = pc.company;
                    }
                    
                    // Clear other filters
                    const statusFilter = document.getElementById('activities-status-filter');
                    const dateFilter = document.getElementById('activities-date-filter');
                    if (statusFilter) statusFilter.value = '';
                    if (dateFilter) dateFilter.value = '';
                    
                    // Update results counter
                    const resultsCount = document.getElementById('activities-results-count');
                    if (resultsCount) {
                        resultsCount.textContent = `Showing ${activitiesForPC.length} activities for ${pc.company} (${pc.number})`;
                    }
                }
            }, 100);
        }
        
        function goToActivitiesForQuote(quoteId) {
            // Go to activities page and filter by Quote
            showPage('activities');
            
            // Wait for page to load then filter
            setTimeout(() => {
                const quote = db.quotes.find(q => q.id === quoteId);
                if (quote) {
                    const pc = db.pcs.find(p => p.id === quote.pcId);
                    
                    // Filter activities for this quote
                    const activitiesForQuote = db.activities.filter(a => a.quoteId === quoteId);
                    updateActivitiesList(activitiesForQuote);
                    
                    // Update filter input to show company name
                    const companyFilter = document.getElementById('activities-company-filter');
                    if (companyFilter && pc) {
                        companyFilter.value = pc.company;
                    }
                    
                    // Clear other filters
                    const statusFilter = document.getElementById('activities-status-filter');
                    const dateFilter = document.getElementById('activities-date-filter');
                    if (statusFilter) statusFilter.value = '';
                    if (dateFilter) dateFilter.value = '';
                    
                    // Update results counter
                    const resultsCount = document.getElementById('activities-results-count');
                    if (resultsCount) {
                        const companyName = pc ? pc.company : 'Unknown';
                        const quoteName = quote.name ? ` (${quote.name})` : '';
                        resultsCount.textContent = `Showing ${activitiesForQuote.length} activities for quote ${quote.number}${quoteName} (${companyName})`;
                    }
                }
            }, 100);
        }
        
        // === QUOTE MODAL COMPANY FILTERING FUNCTIONS ===
        
        function filterPCNumbersByCompany() {
            const selectedCompany = document.getElementById('quote-modal-company').value;
            const pcSelect = document.getElementById('quote-modal-pc');
            
            // Clear PC info when company changes
            document.getElementById('quote-modal-pc-info').style.display = 'none';
            
            if (!selectedCompany) {
                // Show all PC Numbers when no company selected
                pcSelect.innerHTML = '<option value="">Select PC Number...</option>';
                if (db.pcs && Array.isArray(db.pcs)) {
                    db.pcs.forEach(pc => {
                        pcSelect.innerHTML += `<option value="${pc.id}">${pc.number} - ${pc.company}</option>`;
                    });
                }
            } else {
                // Filter PC Numbers for selected company
                const pcsForCompany = db.pcs.filter(pc => pc.company === selectedCompany);
                
                pcSelect.innerHTML = '<option value="">Select PC Number...</option>';
                
                if (pcsForCompany.length === 0) {
                    pcSelect.innerHTML += '<option value="" disabled>No PC Numbers for this company</option>';
                } else {
                    pcsForCompany.forEach(pc => {
                        pcSelect.innerHTML += `<option value="${pc.id}">${pc.number} - ${pc.reference || 'No reference'}</option>`;
                    });
                }
            }
        }

        // Expose navigation functions to window
        window.goToQuotesForPC = goToQuotesForPC;
        window.goToActivitiesForPC = goToActivitiesForPC;
        window.goToActivitiesForQuote = goToActivitiesForQuote;
        window.filterPCNumbersByCompany = filterPCNumbersByCompany;


        window.copyPC = function(id) {
            const pcToCopy = db.pcs.find(p => p.id === id);
            if (!pcToCopy) return;
            
            const newNumber = prompt("Enter the new PC Number for the copy:", pcToCopy.number + "-COPY");
            if (!newNumber) return;

            const newPC = {
                id: 'pc_' + Date.now(),
                number: newNumber,
                company: pcToCopy.company,
                reference: pcToCopy.reference,
                contactPerson: pcToCopy.contactPerson,
                mobilePhone: pcToCopy.mobilePhone,
                email: pcToCopy.email,
                phone: pcToCopy.phone,
                address: pcToCopy.address,
                info: pcToCopy.info,
                quotes: [] // Don't copy quotes
            };

            db.pcs.push(newPC);
            saveData();
            updatePCList();
            alert(`PC Number ${pcToCopy.number} copied to ${newNumber}.`);
        }

        // ========================================
        // DOCUMENT GENERATION & PDF MANAGEMENT
        // ========================================
        
        function generateQuotePDF() {
            if (!db.currentQuote) {
                alert('No quote selected for PDF generation');
                return;
            }
            
            // Store current quote for document generation
            db.documentQuote = db.currentQuote;
            
            // Generate document preview
            updateDocumentPreview();
            
            // Show document preview page
            showPage('document-preview');
        }
        
        function updateDocumentPreview() {
            if (!db.documentQuote) return;
            
            const quote = db.documentQuote;
            const pc = db.pcs.find(p => p.id === quote.pcId);
            const priceList = db.priceLists.find(pl => pl.id === quote.priceListId);
            
            // Get form values
            const companyName = document.getElementById('doc-company-name').value || 'Relocation Services Ltd';
            const companyAddress = document.getElementById('doc-company-address').value || '123 Business Street\nLondon, UK SW1A 1AA';
            const documentTitle = document.getElementById('doc-title').value || 'QUOTATION';
            const footerText = document.getElementById('doc-footer').value || 'Thank you for your business!';
            
            // Generate HTML content
            const htmlContent = generateQuoteHTML(quote, pc, priceList, {
                companyName,
                companyAddress,
                documentTitle,
                footerText
            });
            
            // Update preview
            document.getElementById('document-content').innerHTML = htmlContent;
        }
        
        function generateQuoteHTML(quote, pc, priceList, settings) {
            // Calculate totals
            let categoryTotals = { human: 0, vehicles: 0, materials: 0, other: 0 };
            const categories = ['human', 'vehicles', 'materials', 'other'];
            
            categories.forEach(cat => {
                if (quote.items[cat]) {
                    quote.items[cat].forEach(item => { 
                        categoryTotals[cat] += item.total || 0; 
                    });
                }
            });
            
            let otherCostsTotal = 0;
            if (quote.otherCosts) {
                quote.otherCosts.forEach(cost => { 
                    otherCostsTotal += cost.amount || 0; 
                });
            }
            
            const subtotal = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0) + otherCostsTotal;
            const discountAmount = subtotal * (quote.discount || 0) / 100;
            const total = subtotal - discountAmount;
            
            // Generate items table
            let itemsHTML = '';
            categories.forEach(cat => {
                if (quote.items[cat] && quote.items[cat].length > 0) {
                    const categoryName = cat === 'human' ? 'Human Resources' : 
                                       cat.charAt(0).toUpperCase() + cat.slice(1);
                    
                    itemsHTML += `
                        <tr style="background: #f8f9fa; font-weight: bold;">
                            <td colspan="4">${categoryName}</td>
                        </tr>
                    `;
                    
                    quote.items[cat].forEach(item => {
                        if (item.name && item.total >= 0) {
                            itemsHTML += `
                                <tr>
                                    <td>${item.name}</td>
                                    <td style="text-align: center;">${item.qty}</td>
                                    <td style="text-align: right;">${item.rate.toFixed(2)}</td>
                                    <td style="text-align: right;">${item.total.toFixed(2)}</td>
                                </tr>
                            `;
                        }
                    });
                }
            });
            
            // Add other costs
            if (quote.otherCosts && quote.otherCosts.length > 0) {
                itemsHTML += `
                    <tr style="background: #f8f9fa; font-weight: bold;">
                        <td colspan="4">Other Costs</td>
                    </tr>
                `;
                
                quote.otherCosts.forEach(cost => {
                    if (cost.description && cost.amount > 0) {
                        itemsHTML += `
                            <tr>
                                <td>${cost.description}</td>
                                <td style="text-align: center;">1</td>
                                <td style="text-align: right;">${cost.amount.toFixed(2)}</td>
                                <td style="text-align: right;">${cost.amount.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                });
            }
            
            return `
                <div class="document-header">
                    <div>
                        <h1 style="color: #2c3e50; margin-bottom: 0.5rem;">${settings.companyName}</h1>
                        <div class="company-info" style="white-space: pre-line;">${settings.companyAddress}</div>
                    </div>
                    <div class="company-info">
                        <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                        <div><strong>Quote #:</strong> ${quote.number}</div>
                        ${quote.name ? `<div><strong>Quote Name:</strong> ${quote.name}</div>` : ''}
                        <div><strong>PC #:</strong> ${pc ? pc.number : 'N/A'}</div>
                    </div>
                </div>
                
                <div class="document-title">${settings.documentTitle}</div>
                
                <div class="client-section">
                    <h3>Client Details</h3>
                    <div><strong>Company:</strong> ${pc ? pc.company : 'N/A'}</div>
                    <div><strong>Contact:</strong> ${pc ? pc.contactPerson : 'N/A'}</div>
                    <div><strong>Email:</strong> ${pc ? pc.email : 'N/A'}</div>
                    <div><strong>Phone:</strong> ${pc ? pc.mobilePhone || pc.phone : 'N/A'}</div>
                    <div><strong>Address:</strong> ${pc ? pc.address : 'N/A'}</div>
                    ${pc && pc.reference ? `<div><strong>Reference:</strong> ${pc.reference}</div>` : ''}
                    ${quote.description ? `<div><strong>Description:</strong> ${quote.description}</div>` : ''}
                </div>
                
                <div class="quote-section">
                    <h3>Quote Details</h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th style="text-align: center;">Quantity</th>
                                <th style="text-align: right;">Rate</th>
                                <th style="text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                </div>
                
                <div class="totals-section">
                    <div class="total-line">
                        <span>Subtotal:</span>
                        <span>${subtotal.toFixed(2)}</span>
                    </div>
                    ${quote.discount > 0 ? `
                        <div class="total-line">
                            <span>Discount (${quote.discount}%):</span>
                            <span>-${discountAmount.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="total-line final">
                        <span>Total:</span>
                        <span>${total.toFixed(2)}</span>
                    </div>
                </div>
                
                ${generateResourcesActivitiesSection()}
                
                <div class="document-footer">
                    <p>${settings.footerText}</p>
                    <p><small>This quotation is valid for 30 days from the date of issue.</small></p>
                </div>
            `;
        }
        
        function generateResourcesActivitiesSection() {
            const includeRA = document.getElementById('include-resources-activities').checked;
            
            if (!includeRA || window.resourcesActivitiesData.length === 0) {
                return '';
            }
            
            const startDate = document.getElementById('project-start-date').value;
            const startDateObj = startDate ? new Date(startDate) : new Date();
            
            let raHTML = `
                <div class="ra-schedule-section">
                    <h3> Resources & Activities Schedule</h3>
                    <p><strong>Project Start Date:</strong> ${startDateObj.toLocaleDateString()}</p>
                    
                    <table class="ra-schedule-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Day</th>
                                <th style="width: 15%;">Date</th>
                                <th style="width: 35%;">Tasks & Activities</th>
                                <th style="width: 35%;">Resources Required</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            window.resourcesActivitiesData.forEach(day => {
                const dayDate = new Date(startDateObj);
                dayDate.setDate(dayDate.getDate() + (day.dayNumber - 1));
                
                raHTML += `
                    <tr>
                        <td class="ra-day-header">Day ${day.dayNumber}</td>
                        <td class="ra-day-header">${dayDate.toLocaleDateString()}</td>
                        <td>
                            <ul class="ra-tasks-list">
                                ${day.tasks.map(task => `<li>${task}</li>`).join('')}
                            </ul>
                        </td>
                        <td>
                            <ul class="ra-resources-list">
                                ${day.resources.map(resource => `<li>${resource}</li>`).join('')}
                            </ul>
                        </td>
                    </tr>
                `;
            });
            
            raHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return raHTML;
        }
        
        function generatePDFFromPreview() {
            console.log(' Starting PDF generation...');
            
            // Check if libraries are loaded
            if (typeof window.jspdf === 'undefined') {
                console.error(' jsPDF library not loaded');
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }
            
            if (typeof html2canvas === 'undefined') {
                console.error(' html2canvas library not loaded');
                alert('HTML2Canvas library not loaded. Please refresh the page and try again.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            console.log(' Libraries loaded successfully');
            
            const element = document.getElementById('document-content');
            
            if (!element) {
                console.error(' Document content element not found');
                alert('No document content to export');
                return;
            }
            
            console.log(' Document content found, generating canvas...');
            
            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pdf-loading';
            loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 10000; font-size: 1.2rem;';
            loadingDiv.textContent = 'Generating PDF... Please wait';
            document.body.appendChild(loadingDiv);
            
            // Use the document preview container for better capture
            const captureElement = document.querySelector('.document-preview');
            
            html2canvas(captureElement || element, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: captureElement ? captureElement.offsetWidth : element.offsetWidth,
                height: captureElement ? captureElement.offsetHeight : element.offsetHeight,
                logging: true // Enable logging for debugging
            }).then(canvas => {
                console.log(' Canvas generated successfully');
                console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);
                
                // Remove loading message
                const loading = document.getElementById('pdf-loading');
                if (loading) loading.remove();
                
                if (canvas.width === 0 || canvas.height === 0) {
                    console.error(' Canvas has zero dimensions');
                    alert('Error: Generated canvas is empty. Please try again.');
                    return;
                }
                
                const imgData = canvas.toDataURL('image/png');
                console.log(' Image data generated, creating PDF...');
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 0;
                
                console.log(' Adding content to PDF...');
                console.log('Image dimensions for PDF:', imgWidth, 'x', imgHeight);
                
                // Add first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    console.log(' Added additional page');
                }
                
                // Generate filename
                const quote = db.documentQuote;
                const pc = db.pcs.find(p => p.id === quote.pcId);
                const quoteName = quote.name ? `_${quote.name.replace(/[^a-zA-Z0-9]/g, '_')}` : '';
                const filename = `Quote_${quote.number}${quoteName}_${pc ? pc.company.replace(/[^a-zA-Z0-9]/g, '_') : 'Unknown'}.pdf`;
                
                console.log(' Saving PDF as:', filename);
                
                // Save PDF
                pdf.save(filename);
                
                console.log(' PDF generated successfully!');
                alert(` PDF generated successfully!\n\nFilename: ${filename}`);
                
            }).catch(error => {
                // Remove loading message
                const loading = document.getElementById('pdf-loading');
                if (loading) loading.remove();
                
                console.error(' PDF generation error:', error);
                alert(` Error generating PDF: ${error.message}\n\nPlease check the browser console for more details.`);
            });
        }
        
        // Alternative simple PDF generation method (fallback)
        function generateSimplePDF() {
            console.log(' Using simple PDF generation method...');
            
            if (typeof window.jspdf === 'undefined') {
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            if (!db.documentQuote) {
                alert('No quote data available');
                return;
            }
            
            const quote = db.documentQuote;
            const pc = db.pcs.find(p => p.id === quote.pcId);
            
            // Add content using text methods (fallback)
            pdf.setFontSize(20);
            pdf.text('QUOTATION', 105, 30, { align: 'center' });
            
            pdf.setFontSize(12);
            pdf.text(`Quote Number: ${quote.number}`, 20, 50);
            let yPos = 60;
            if (quote.name) {
                pdf.text(`Quote Name: ${quote.name}`, 20, yPos);
                yPos = 70;
            }
            pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, yPos);
            
            if (pc) {
                pdf.text(`Company: ${pc.company}`, 20, 80);
                pdf.text(`Contact: ${pc.contactPerson}`, 20, 90);
                pdf.text(`Email: ${pc.email}`, 20, 100);
            }
            if (quote.description) {
                pdf.text(`Description: ${quote.description}`, 20, 120);
                pdf.text(`Total: ${quote.total.toFixed(2)}`, 20, 130);
            } else {
                pdf.text(`Total: ${quote.total.toFixed(2)}`, 20, 120);
            }
            
            // Generate filename
            const quoteName = quote.name ? `_${quote.name.replace(/[^a-zA-Z0-9]/g, '_')}` : '';
            const filename = `Quote_${quote.number}${quoteName}_${pc ? pc.company.replace(/[^a-zA-Z0-9]/g, '_') : 'Unknown'}_Simple.pdf`;
            
                         pdf.save(filename);
             alert(` Simple PDF generated: ${filename}`);
         }
         
         // Debug function to check library status
         function debugPDFLibraries() {
             console.log(' Debugging PDF Libraries...');
             
             let report = ' PDF Libraries Debug Report:\n\n';
             
             // Check jsPDF
             if (typeof window.jspdf !== 'undefined') {
                 report += ' jsPDF: Loaded successfully\n';
                 report += `   Version: ${window.jspdf.version || 'Unknown'}\n`;
                 report += `   Available: ${typeof window.jspdf.jsPDF}\n`;
             } else {
                 report += ' jsPDF: NOT LOADED\n';
             }
             
             // Check html2canvas
             if (typeof html2canvas !== 'undefined') {
                 report += ' html2canvas: Loaded successfully\n';
                 report += `   Version: ${html2canvas.version || 'Unknown'}\n`;
             } else {
                 report += ' html2canvas: NOT LOADED\n';
             }
             
             // Check document elements
             const docContent = document.getElementById('document-content');
             const docPreview = document.querySelector('.document-preview');
             
             report += '\n Document Elements:\n';
             report += `   document-content: ${docContent ? ' Found' : ' Missing'}\n`;
             report += `   document-preview: ${docPreview ? ' Found' : ' Missing'}\n`;
             
             if (docContent) {
                 report += `   Content length: ${docContent.innerHTML.length} characters\n`;
                 report += `   Dimensions: ${docContent.offsetWidth}x${docContent.offsetHeight}px\n`;
             }
             
             // Check current quote
             report += '\n Quote Data:\n';
             report += `   Current Quote: ${db.currentQuote ? ' Available' : ' Missing'}\n`;
             report += `   Document Quote: ${db.documentQuote ? ' Available' : ' Missing'}\n`;
             
             if (db.documentQuote) {
                 report += `   Quote Number: ${db.documentQuote.number}\n`;
                 if (db.documentQuote.name) {
                     report += `   Quote Name: ${db.documentQuote.name}\n`;
                 }
                 report += `   Quote Total: ${db.documentQuote.total}\n`;
             }
             
             console.log(report);
             alert(report);
         }
        
                 // === RESOURCES & ACTIVITIES FUNCTIONS ===
         
         // Global variable to store R&A data
         window.resourcesActivitiesData = [];
         
         function toggleResourcesActivities() {
             const checkbox = document.getElementById('include-resources-activities');
             const section = document.getElementById('resources-activities-section');
             
             if (checkbox.checked) {
                 section.style.display = 'block';
                 // Initialize with one day if empty
                 if (window.resourcesActivitiesData.length === 0) {
                     addActivityDay();
                 }
             } else {
                 section.style.display = 'none';
             }
         }
         
         function addActivityDay() {
             const dayNumber = window.resourcesActivitiesData.length + 1;
             const dayId = 'day_' + Date.now();
             
             const dayData = {
                 id: dayId,
                 dayNumber: dayNumber,
                 tasks: ['Site preparation'],
                 resources: ['Team Leader x1', 'Porter x2']
             };
             
             window.resourcesActivitiesData.push(dayData);
             renderActivityDays();
         }
         
         function removeActivityDay(dayId) {
             window.resourcesActivitiesData = window.resourcesActivitiesData.filter(day => day.id !== dayId);
             // Renumber days
             window.resourcesActivitiesData.forEach((day, index) => {
                 day.dayNumber = index + 1;
             });
             renderActivityDays();
         }
         
         function clearActivityDays() {
             window.resourcesActivitiesData = [];
             renderActivityDays();
         }
         
         function renderActivityDays() {
             const container = document.getElementById('activity-days-container');
             container.innerHTML = '';
             
             window.resourcesActivitiesData.forEach(day => {
                 const dayDiv = document.createElement('div');
                 dayDiv.className = 'activity-day-item';
                 dayDiv.innerHTML = `
                     <div class="activity-day-header">
                         <span> Day ${day.dayNumber}</span>
                         <button onclick="window.removeActivityDay('${day.id}')" class="remove-task-btn">Remove Day</button>
                     </div>
                     
                     <div class="activity-day-content">
                         <div class="activity-tasks">
                             <h5> Tasks & Activities</h5>
                             <div id="tasks-${day.id}">
                                 ${day.tasks.map((task, index) => `
                                     <div class="task-item">
                                         <input type="text" class="task-input" value="${task}" 
                                                onchange="window.updateTask('${day.id}', ${index}, this.value)">
                                         <button onclick="window.removeTask('${day.id}', ${index})" class="remove-task-btn"></button>
                                     </div>
                                 `).join('')}
                             </div>
                             <button onclick="window.addTask('${day.id}')" class="add-task-btn">+ Add Task</button>
                         </div>
                         
                         <div class="activity-resources">
                             <h5> Resources Required</h5>
                             <div id="resources-${day.id}">
                                 ${day.resources.map((resource, index) => `
                                     <div class="resource-item-ra">
                                         <input type="text" class="resource-input" value="${resource}" 
                                                onchange="window.updateResource('${day.id}', ${index}, this.value)">
                                         <button onclick="window.removeResource('${day.id}', ${index})" class="remove-resource-btn"></button>
                                     </div>
                                 `).join('')}
                             </div>
                             <button onclick="window.addResource('${day.id}')" class="add-resource-btn">+ Add Resource</button>
                         </div>
                     </div>
                 `;
                 container.appendChild(dayDiv);
             });
         }
         
         function addTask(dayId) {
             const day = window.resourcesActivitiesData.find(d => d.id === dayId);
             if (day) {
                 day.tasks.push('New task');
                 renderActivityDays();
             }
         }
         
         function removeTask(dayId, taskIndex) {
             const day = window.resourcesActivitiesData.find(d => d.id === dayId);
             if (day) {
                 day.tasks.splice(taskIndex, 1);
                 renderActivityDays();
             }
         }
         
         function updateTask(dayId, taskIndex, newValue) {
             const day = window.resourcesActivitiesData.find(d => d.id === dayId);
             if (day) {
                 day.tasks[taskIndex] = newValue;
             }
         }
         
         function addResource(dayId) {
             const day = window.resourcesActivitiesData.find(d => d.id === dayId);
             if (day) {
                 day.resources.push('New resource');
                 renderActivityDays();
             }
         }
         
         function removeResource(dayId, resourceIndex) {
             const day = window.resourcesActivitiesData.find(d => d.id === dayId);
             if (day) {
                 day.resources.splice(resourceIndex, 1);
                 renderActivityDays();
             }
         }
         
         function updateResource(dayId, resourceIndex, newValue) {
             const day = window.resourcesActivitiesData.find(d => d.id === dayId);
             if (day) {
                 day.resources[resourceIndex] = newValue;
             }
         }
         
         // Expose document generation functions
         window.generateQuotePDF = generateQuotePDF;
         window.updateDocumentPreview = updateDocumentPreview;
         window.generatePDFFromPreview = generatePDFFromPreview;
         window.generateSimplePDF = generateSimplePDF;
         window.debugPDFLibraries = debugPDFLibraries;
         
         // Expose R&A functions
         window.toggleResourcesActivities = toggleResourcesActivities;
         window.addActivityDay = addActivityDay;
         window.removeActivityDay = removeActivityDay;
         window.clearActivityDays = clearActivityDays;
         window.addTask = addTask;
         window.removeTask = removeTask;
         window.updateTask = updateTask;
         window.addResource = addResource;
         window.removeResource = removeResource;
         window.updateResource = updateResource;



        // ========== AUTHENTICATION SYSTEM ==========
        
        // User database - will be loaded from users.json
        let USERS_DB = {
            'WIRE001': {
                name: 'John Smith',
                password: 'Alpha2025!',
                role: 'tester',
                active: false,
                lastActivity: null,
                sessionId: null,
                loginCount: 0,
                createdAt: '2025-01-03T10:00:00.000Z',
                createdBy: 'system'
            },
            'WIRE002': {
                name: 'Sarah Johnson',
                password: 'Beta2025#',
                role: 'tester',
                active: false,
                lastActivity: null,
                sessionId: null,
                loginCount: 0,
                createdAt: '2025-01-03T10:00:00.000Z',
                createdBy: 'system'
            },
            'WIRE003': {
                name: 'Mike Wilson',
                password: 'Gamma2025$',
                role: 'tester',
                active: false,
                lastActivity: null,
                sessionId: null,
                loginCount: 0,
                createdAt: '2025-01-03T10:00:00.000Z',
                createdBy: 'system'
            },
            'ADMIN': {
                name: 'Administrator',
                password: 'AdminSecure2025!',
                role: 'admin',
                active: false,
                lastActivity: null,
                sessionId: null,
                loginCount: 0,
                createdAt: '2025-01-03T10:00:00.000Z',
                createdBy: 'system'
            }
        };

        // Session management
        let currentUser = null;
        let sessionStartTime = null;
        let activityTimer = null;
        let securityLogs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
        let adminClickCount = 0;
        let adminClickTimer = null;
        let usersLoaded = false;

        // Security logging
        function logSecurityEvent(type, userId, details) {
            const event = {
                timestamp: new Date().toISOString(),
                type: type,
                userId: userId,
                details: details,
                userAgent: navigator.userAgent.substring(0, 100)
            };
            
            securityLogs.push(event);
            
            // Keep only last 1000 logs
            if (securityLogs.length > 1000) {
                securityLogs = securityLogs.slice(-1000);
            }
            
            localStorage.setItem('securityLogs', JSON.stringify(securityLogs));
            updateAdminStats();
        }

        // ========== USERS JSON MANAGEMENT ==========
        
        // Load users from users.json file
        async function loadUsersFromJSON() {
            try {
                const response = await fetch('./users.json');
                if (response.ok) {
                    const users = await response.json();
                    USERS_DB = users;
                    usersLoaded = true;
                    console.log(' Users loaded from users.json');
                    return true;
                } else {
                    console.warn(' Could not load users.json, using defaults');
                    usersLoaded = true;
                    return false;
                }
            } catch (error) {
                console.warn(' Error loading users.json:', error);
                usersLoaded = true;
                return false;
            }
        }

        // Save users to users.json file (simulated - would need backend)
        async function saveUsersToJSON() {
            try {
                // In a real backend, this would make a POST request to save the file
                // For now, we'll use localStorage as backup and show instructions
                localStorage.setItem('usersBackup', JSON.stringify(USERS_DB));
                
                console.log(' Users data saved to localStorage backup');
                console.log(' To update users.json file, copy this data:');
                console.log(JSON.stringify(USERS_DB, null, 2));
                
                // Show admin notification
                if (currentUser && currentUser.role === 'admin') {
                    showSaveNotification();
                }
                
                return true;
            } catch (error) {
                console.error(' Error saving users data:', error);
                return false;
            }
        }

        // Show save notification to admin
        function showSaveNotification() {
            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'save-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(39, 174, 96, 0.3);
                z-index: 20000;
                font-size: 0.9rem;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span></span>
                    <div>
                        <strong>Users Updated!</strong>
                        <br><small>Data saved to localStorage backup</small>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: auto;"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Load users backup from localStorage if available
        function loadUsersBackup() {
            try {
                const backup = localStorage.getItem('usersBackup');
                if (backup) {
                    const backupUsers = JSON.parse(backup);
                    // Merge with current users, preserving any new ones
                    Object.assign(USERS_DB, backupUsers);
                    console.log(' Users backup loaded from localStorage');
                    return true;
                }
            } catch (error) {
                console.warn(' Error loading users backup:', error);
            }
            return false;
        }

        // Generate unique session ID
        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Check for duplicate sessions
        function checkDuplicateLogin(userId) {
            const user = USERS_DB[userId];
            if (user && user.active && user.sessionId) {
                return true;
            }
            return false;
        }

        // ========================================
        // AUTHENTICATION & SECURITY
        // ========================================
        
        // Attempt login
        function attemptLogin() {
            const userId = document.getElementById('auth-user-id').value.trim().toUpperCase();
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('auth-error');
            
            // Clear previous errors
            errorDiv.style.display = 'none';
            
            // Validate input
            if (!userId || !password) {
                showAuthError('Please enter both User ID and Access Code');
                return;
            }
            
            // Check if user exists
            if (!USERS_DB[userId]) {
                logSecurityEvent('LOGIN_FAILED', userId, 'Invalid user ID');
                showAuthError('Invalid credentials. Contact administrator.');
                return;
            }
            
            const user = USERS_DB[userId];
            
            // Check password
            if (user.password !== password) {
                logSecurityEvent('LOGIN_FAILED', userId, 'Wrong password');
                showAuthError('Invalid credentials. Contact administrator.');
                return;
            }
            
            // Check for duplicate session
            if (checkDuplicateLogin(userId)) {
                logSecurityEvent('DUPLICATE_LOGIN', userId, 'Multiple login attempt detected');
                showAuthError('This account is already active in another session. Contact administrator if this is unexpected.');
                return;
            }
            
            // Successful login
            const sessionId = generateSessionId();
            user.active = true;
            user.lastActivity = new Date().toISOString();
            user.sessionId = sessionId;
            user.loginCount++;
            
            currentUser = {
                id: userId,
                name: user.name,
                role: user.role,
                sessionId: sessionId
            };
            
            sessionStartTime = Date.now();
            
            logSecurityEvent('LOGIN_SUCCESS', userId, 'User logged in successfully');
            
            // Hide auth overlay and show main app
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-navbar').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'block';
            
            // Update user info in navbar
            document.getElementById('current-user-info').textContent = ` ${user.name} (${userId})`;
            
            // Start activity monitoring
            startActivityMonitoring();
            
            // Load main app
            init();
        }

        // Show authentication error
        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Start activity monitoring
        function startActivityMonitoring() {
            // Update activity every 30 seconds
            activityTimer = setInterval(() => {
                if (currentUser) {
                    const user = USERS_DB[currentUser.id];
                    if (user && user.active) {
                        user.lastActivity = new Date().toISOString();
                    }
                }
            }, 30000);
            
            // Listen for user activity
            ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
                document.addEventListener(event, updateLastActivity, { passive: true });
            });
        }

        // Update last activity
        function updateLastActivity() {
            if (currentUser) {
                const user = USERS_DB[currentUser.id];
                if (user && user.active) {
                    user.lastActivity = new Date().toISOString();
                }
            }
        }

        // Logout user
        function logoutUser() {
            if (currentUser) {
                const user = USERS_DB[currentUser.id];
                if (user) {
                    user.active = false;
                    user.sessionId = null;
                    
                    const sessionDuration = Math.round((Date.now() - sessionStartTime) / 1000 / 60);
                    logSecurityEvent('LOGOUT', currentUser.id, `Session duration: ${sessionDuration} minutes`);
                }
                
                // Clear activity timer
                if (activityTimer) {
                    clearInterval(activityTimer);
                }
                
                currentUser = null;
                sessionStartTime = null;
            }
            
            // Clear session storage
            localStorage.removeItem('currentSession');
            
            // Show auth overlay
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('main-navbar').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // Clear form
            document.getElementById('auth-user-id').value = '';
            document.getElementById('auth-password').value = '';
            document.getElementById('auth-error').style.display = 'none';
        }

        // Handle logo click for admin access
        function handleLogoClick() {
            adminClickCount++;
            
            if (adminClickTimer) {
                clearTimeout(adminClickTimer);
            }
            
            adminClickTimer = setTimeout(() => {
                adminClickCount = 0;
            }, 2000);
            
            // 5 rapid clicks within 2 seconds
            if (adminClickCount >= 5) {
                adminClickCount = 0;
                
                if (currentUser && currentUser.role === 'admin') {
                    openAdminPanel();
                } else {
                    alert('Admin access required');
                }
            }
        }

        // ========== ADMIN PANEL ==========
        
        // Open admin panel
        function openAdminPanel() {
            document.getElementById('admin-panel').style.display = 'flex';
            updateAdminStats();
            updateUserTable();
        }

        // Close admin panel
        function closeAdminPanel() {
            document.getElementById('admin-panel').style.display = 'none';
        }

        // Update admin statistics
        function updateAdminStats() {
            const activeUsers = Object.values(USERS_DB).filter(user => user.active).length;
            const todayLogs = securityLogs.filter(log => {
                const logDate = new Date(log.timestamp).toDateString();
                const today = new Date().toDateString();
                return logDate === today;
            });
            const sessionCount = todayLogs.filter(log => log.type === 'LOGIN_SUCCESS').length;
            const alertCount = todayLogs.filter(log => log.type.includes('FAILED') || log.type.includes('DUPLICATE')).length;
            
            // Only update DOM if elements exist
            const activeCountEl = document.getElementById('admin-active-count');
            const sessionCountEl = document.getElementById('admin-session-count');
            const alertCountEl = document.getElementById('admin-alert-count');
            
            if (activeCountEl) activeCountEl.textContent = activeUsers;
            if (sessionCountEl) sessionCountEl.textContent = sessionCount;
            if (alertCountEl) alertCountEl.textContent = alertCount;
        }

        // Update user table
        function updateUserTable() {
            const tbody = document.getElementById('admin-user-body');
            tbody.innerHTML = '';
            
            Object.entries(USERS_DB).forEach(([userId, user]) => {
                const row = document.createElement('tr');
                
                const statusClass = user.active ? 'status-online' : 'status-offline';
                const statusText = user.active ? 'Online' : 'Offline';
                
                const lastActivity = user.lastActivity 
                    ? new Date(user.lastActivity).toLocaleString()
                    : 'Never';
                
                row.innerHTML = `
                    <td><strong>${userId}</strong></td>
                    <td>${user.name}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${lastActivity}</td>
                    <td>
                        <button class="table-action-btn edit" onclick="showEditUserModal('${userId}')">Edit</button>
                        ${user.active ? 
                            `<button class="table-action-btn kick" onclick="kickUser('${userId}')">Kick</button>` : 
                            ''
                        }
                        <button class="table-action-btn reset" onclick="resetUserPassword('${userId}')">Reset</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Kick user
        function kickUser(userId) {
            if (confirm(`Kick user ${userId}? They will be logged out immediately.`)) {
                const user = USERS_DB[userId];
                if (user && user.active) {
                    user.active = false;
                    user.sessionId = null;
                    
                    logSecurityEvent('USER_KICKED', userId, `Kicked by admin: ${currentUser.id}`);
                    
                    // If it's the current user, logout
                    if (currentUser && currentUser.id === userId) {
                        logoutUser();
                        return;
                    }
                    
                    updateAdminStats();
                    updateUserTable();
                    
                    alert(`User ${userId} has been kicked successfully.`);
                }
            }
        }

        // Reset user password
        function resetUserPassword(userId) {
            const newPassword = prompt(`Enter new password for ${userId}:`);
            if (newPassword && newPassword.length >= 8) {
                USERS_DB[userId].password = newPassword;
                logSecurityEvent('PASSWORD_RESET', userId, `Password reset by admin: ${currentUser.id}`);
                alert(`Password for ${userId} has been updated to: ${newPassword}`);
            } else if (newPassword !== null) {
                alert('Password must be at least 8 characters long.');
            }
        }

        // Generate new passwords for all users
        function generateNewPasswords() {
            if (confirm('Generate new passwords for ALL users? This will log out all active sessions.')) {
                const newPasswords = {};
                
                Object.keys(USERS_DB).forEach(userId => {
                    const newPassword = generateRandomPassword();
                    USERS_DB[userId].password = newPassword;
                    USERS_DB[userId].active = false;
                    USERS_DB[userId].sessionId = null;
                    newPasswords[userId] = newPassword;
                });
                
                logSecurityEvent('BULK_PASSWORD_RESET', currentUser.id, 'All passwords regenerated');
                
                // Show new passwords
                let message = 'New passwords generated:\n\n';
                Object.entries(newPasswords).forEach(([userId, password]) => {
                    message += `${userId}: ${password}\n`;
                });
                
                alert(message);
                
                // Logout current user if not admin
                if (currentUser.role !== 'admin') {
                    logoutUser();
                } else {
                    updateAdminStats();
                    updateUserTable();
                }
            }
        }

        // Generate random password
        function generateRandomPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Kick all users
        function kickAllUsers() {
            if (confirm('Kick ALL users? This will log out everyone except you.')) {
                Object.entries(USERS_DB).forEach(([userId, user]) => {
                    if (userId !== currentUser.id && user.active) {
                        user.active = false;
                        user.sessionId = null;
                    }
                });
                
                logSecurityEvent('BULK_USER_KICK', currentUser.id, 'All users kicked');
                
                updateAdminStats();
                updateUserTable();
                
                alert('All other users have been logged out.');
            }
        }

        // Export security logs
        function exportLogs() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Timestamp,Type,User ID,Details,User Agent\n" +
                securityLogs.map(log => 
                    `"${log.timestamp}","${log.type}","${log.userId}","${log.details}","${log.userAgent}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `security_logs_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Clear security logs
        function clearSecurityLogs() {
            if (confirm('Clear all security logs? This action cannot be undone.')) {
                securityLogs = [];
                localStorage.removeItem('securityLogs');
                logSecurityEvent('LOGS_CLEARED', currentUser.id, 'Security logs cleared by admin');
                updateAdminStats();
                alert('Security logs have been cleared.');
            }
        }

        // Export users JSON file
        function exportUsersJSON() {
            const jsonContent = JSON.stringify(USERS_DB, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `users_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            logSecurityEvent('USERS_EXPORTED', currentUser.id, 'Users database exported by admin');
            alert(' Users database exported successfully!\n\nReplace the users.json file on your server with the downloaded file.');
        }

        // Save session to localStorage
        function saveSession() {
            if (currentUser) {
                const sessionData = {
                    userId: currentUser.id,
                    sessionId: currentUser.sessionId,
                    startTime: sessionStartTime
                };
                localStorage.setItem('currentSession', JSON.stringify(sessionData));
            }
        }

        // Update session saving
        setInterval(() => {
            if (currentUser) {
                saveSession();
            }
        }, 10000); // Save every 10 seconds

        // ========== ADDRESS LOOKUP FUNCTIONS ==========
        
        // GetAddress.io API configuration
        // NOTE: If you get "API key is invalid or expired" errors, you need to:
        // 1. Go to https://getaddress.io/
        // 2. Sign up/login to your account
        // 3. Get a new API key from your dashboard
        // 4. Replace the key below
        // 
        // IMPORTANT: Make sure your getAddress.io account has access to the Find API
        // The free tier might not include postcode searches - you may need a paid plan
        // Using domain token for better security (restricted to specific domains)
        const GETADDRESS_API_KEY = 'dtoken_hEDzcyiWMr2CCCGf8zsGNE2SHHEfm6rX_XAatK12IRgrboFsWd-B241eyhADhPZyUYZJTCBnZBkt05Up_-Tkv6zsKi2cxas1E8AeLWSosp-1jN0psTNtvHhuicZMg-998ZuJOgY_oEyxk3Aw4_ZrM48_Cu-UzYqG1s-3bgoj_Va1rWjD7m4E5AA5jnYnrokAqXYERNg4EJwyiCLtHZEylg';
        const GETADDRESS_BASE_URL = 'https://api.getaddress.io/find';
        
        // Find address based on postcode
        async function findAddress(type) {
            const postcodeField = document.getElementById(`pc-${type}-postcode`);
            const postcode = postcodeField.value.trim().replace(/\s+/g, '');
            
            if (!postcode) {
                alert('Please enter a postcode first.');
                return;
            }
            
            // Show loading state
            const button = postcodeField.parentElement.querySelector('button');
            const originalText = button.textContent;
            button.textContent = 'Searching...';
            button.disabled = true;
            
            try {
                // According to getAddress.io documentation, use the Find API for postcode searches
                const response = await fetch(`${GETADDRESS_BASE_URL}/${postcode}?api-key=${GETADDRESS_API_KEY}&format=true&sort=true&expand=true`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (response.status === 401) {
                        throw new Error('Domain token is unauthorized. Please check that your domain is authorized in getAddress.io dashboard.');
                    } else if (response.status === 404) {
                        if (errorData.Message === 'Not Found') {
                            throw new Error('API key is invalid or account doesn\'t have access to Find API. Please check your getAddress.io subscription.');
                        } else {
                            throw new Error('No addresses found for this postcode.');
                        }
                    } else {
                        throw new Error(`API error: ${response.status} - ${errorData.Message || 'Unknown error'}`);
                    }
                }
                
                const data = await response.json();
                console.log('getAddress.io API response:', data);
                
                // Handle both possible response formats from getAddress.io
                let addresses = [];
                if (data.addresses && Array.isArray(data.addresses)) {
                    addresses = data.addresses;
                } else if (data && Array.isArray(data)) {
                    addresses = data;
                }
                
                if (addresses.length > 0) {
                    showAddressSelector(type, addresses, postcode);
                } else {
                    alert('No addresses found for this postcode.');
                }
                
            } catch (error) {
                console.error('Error fetching addresses:', error);
                const shouldContinue = confirm(`Address lookup error: ${error.message}\n\nWould you like to continue with manual address entry?`);
                if (!shouldContinue) {
                    return;
                }
            } finally {
                // Restore button state
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Show address selector dropdown
        function showAddressSelector(type, addresses, postcode) {
            // Remove existing selector if any
            const existingSelector = document.getElementById('address-selector');
            if (existingSelector) {
                existingSelector.remove();
            }
            
            // Create selector container
            const selector = document.createElement('div');
            selector.id = 'address-selector';
            selector.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 2px solid var(--primary-color);
                border-radius: 8px;
                padding: 1.5rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            selector.innerHTML = `
                <h3 style="margin: 0 0 1rem 0; color: var(--primary-color);">Select Address for ${postcode}</h3>
                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">Found ${addresses.length} address(es):</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                    ${addresses.map((address, index) => `
                        <button onclick="selectAddress('${type}', '${address.replace(/'/g, "\\'")}', ${index})" 
                                style="text-align: left; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; transition: all 0.2s;">
                            ${address}
                        </button>
                    `).join('')}
                </div>
                <button onclick="closeAddressSelector()" style="width: 100%; padding: 0.75rem; background: var(--secondary-200); color: var(--secondary-700); border: 1px solid var(--secondary-300); border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
            `;
            
            // Add overlay
            const overlay = document.createElement('div');
            overlay.id = 'address-selector-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;
            overlay.onclick = closeAddressSelector;
            
            document.body.appendChild(overlay);
            document.body.appendChild(selector);
        }
        
        // Select address and fill form fields
        function selectAddress(type, address, index) {
            // Parse address components
            const addressParts = address.split(', ');
            
            // Fill address fields based on type
            if (type === 'collection') {
                document.getElementById('pc-collection-address-1').value = addressParts[0] || '';
                document.getElementById('pc-collection-address-2').value = addressParts[1] || '';
                document.getElementById('pc-collection-address-3').value = addressParts[2] || '';
                document.getElementById('pc-collection-address-4').value = addressParts[3] || '';
            } else if (type === 'delivery') {
                document.getElementById('pc-delivery-address-1').value = addressParts[0] || '';
                document.getElementById('pc-delivery-address-2').value = addressParts[1] || '';
                document.getElementById('pc-delivery-address-3').value = addressParts[2] || '';
                document.getElementById('pc-delivery-address-4').value = addressParts[3] || '';
            }
            
            closeAddressSelector();
        }
        
        // Close address selector
        function closeAddressSelector() {
            const selector = document.getElementById('address-selector');
            const overlay = document.getElementById('address-selector-overlay');
            
            if (selector) selector.remove();
            if (overlay) overlay.remove();
        }

        // ========== USER MANAGEMENT FUNCTIONS ==========

        // Show add user modal
        function showAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'flex';
            // Clear form
            document.getElementById('new-user-id').value = '';
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-role').value = 'tester';
        }

        // Close add user modal
        function closeAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'none';
        }

        // Add new user
        function addNewUser() {
            const userId = document.getElementById('new-user-id').value.trim().toUpperCase();
            const name = document.getElementById('new-user-name').value.trim();
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;

            // Validation
            if (!userId || !name || !password) {
                alert('Please fill in all required fields.');
                return;
            }

            if (userId.length < 3) {
                alert('User ID must be at least 3 characters long.');
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters long.');
                return;
            }

            if (USERS_DB[userId]) {
                alert('User ID already exists. Please choose a different ID.');
                return;
            }

            // Create new user
            USERS_DB[userId] = {
                name: name,
                password: password,
                role: role,
                active: false,
                lastActivity: null,
                sessionId: null,
                loginCount: 0
            };

            logSecurityEvent('USER_CREATED', userId, `New user created by admin: ${currentUser.id}`);

            // Close modal and refresh
            closeAddUserModal();
            updateUserTable();
            updateAdminStats();

            alert(` User ${userId} (${name}) has been created successfully!`);
        }

        // Show edit user modal
        function showEditUserModal(userId) {
            const user = USERS_DB[userId];
            if (!user) return;

            document.getElementById('edit-user-modal').style.display = 'flex';
            
            // Fill form with current data
            document.getElementById('edit-user-original-id').value = userId;
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-password').value = '';
            document.getElementById('edit-user-role').value = user.role;

            // Fill stats
            document.getElementById('edit-user-login-count').textContent = user.loginCount;
            document.getElementById('edit-user-last-activity').textContent = 
                user.lastActivity ? new Date(user.lastActivity).toLocaleString() : 'Never';
            document.getElementById('edit-user-status').textContent = user.active ? 'Online' : 'Offline';
        }

        // Close edit user modal
        function closeEditUserModal() {
            document.getElementById('edit-user-modal').style.display = 'none';
        }

        // Save user changes
        function saveUserChanges() {
            const originalId = document.getElementById('edit-user-original-id').value;
            const newId = document.getElementById('edit-user-id').value.trim().toUpperCase();
            const name = document.getElementById('edit-user-name').value.trim();
            const password = document.getElementById('edit-user-password').value;
            const role = document.getElementById('edit-user-role').value;

            if (!newId || !name) {
                alert('User ID and Name are required.');
                return;
            }

            if (newId.length < 3) {
                alert('User ID must be at least 3 characters long.');
                return;
            }

            if (password && password.length < 8) {
                alert('Password must be at least 8 characters long.');
                return;
            }

            // Check if new ID already exists (and it's different from original)
            if (newId !== originalId && USERS_DB[newId]) {
                alert('User ID already exists. Please choose a different ID.');
                return;
            }

            const user = USERS_DB[originalId];
            
            // If ID changed, create new entry and delete old one
            if (newId !== originalId) {
                USERS_DB[newId] = { ...user };
                delete USERS_DB[originalId];
                
                // Update current user reference if editing self
                if (currentUser && currentUser.id === originalId) {
                    currentUser.id = newId;
                }
                
                logSecurityEvent('USER_ID_CHANGED', newId, `User ID changed from ${originalId} to ${newId} by admin: ${currentUser.id}`);
            }

            // Update user data
            const targetUser = USERS_DB[newId];
            targetUser.name = name;
            targetUser.role = role;
            
            if (password) {
                targetUser.password = password;
                logSecurityEvent('PASSWORD_CHANGED', newId, `Password changed by admin: ${currentUser.id}`);
            }

            logSecurityEvent('USER_UPDATED', newId, `User data updated by admin: ${currentUser.id}`);

            // Close modal and refresh
            closeEditUserModal();
            updateUserTable();
            updateAdminStats();

            // Update navbar if current user was edited
            if (currentUser && currentUser.id === newId) {
                document.getElementById('current-user-info').textContent = ` ${name} (${newId})`;
                currentUser.name = name;
            }

            alert(` User ${newId} has been updated successfully!`);
        }

        // Delete user
        function deleteUser() {
            const userId = document.getElementById('edit-user-original-id').value;
            const user = USERS_DB[userId];

            if (!user) return;

            // Prevent deleting self
            if (currentUser && currentUser.id === userId) {
                alert('You cannot delete your own account.');
                return;
            }

            // Prevent deleting last admin
            const adminCount = Object.values(USERS_DB).filter(u => u.role === 'admin').length;
            if (user.role === 'admin' && adminCount <= 1) {
                alert('Cannot delete the last administrator account.');
                return;
            }

            if (confirm(` Are you sure you want to delete user ${userId} (${user.name})?\n\nThis action cannot be undone.`)) {
                // Log out user if active
                if (user.active) {
                    user.active = false;
                    user.sessionId = null;
                }

                delete USERS_DB[userId];
                
                logSecurityEvent('USER_DELETED', userId, `User deleted by admin: ${currentUser.id}`);

                closeEditUserModal();
                updateUserTable();
                updateAdminStats();

                alert(` User ${userId} has been deleted successfully.`);
            }
        }

        // Expose auth functions to global scope
        window.attemptLogin = attemptLogin;
        window.logoutUser = logoutUser;
        window.handleLogoClick = handleLogoClick;
        window.openAdminPanel = openAdminPanel;
        window.closeAdminPanel = closeAdminPanel;
        window.kickUser = kickUser;
        window.resetUserPassword = resetUserPassword;
        window.generateNewPasswords = generateNewPasswords;
        window.kickAllUsers = kickAllUsers;
        window.exportLogs = exportLogs;
        window.clearSecurityLogs = clearSecurityLogs;
        window.exportUsersJSON = exportUsersJSON;

        // Expose user management functions
        window.showAddUserModal = showAddUserModal;
        window.closeAddUserModal = closeAddUserModal;
        window.addNewUser = addNewUser;
        window.showEditUserModal = showEditUserModal;
        window.closeEditUserModal = closeEditUserModal;
        window.saveUserChanges = saveUserChanges;
        window.deleteUser = deleteUser;

        // ========== PRICE LIST IMPORT/EXPORT FUNCTIONS ==========
        
        // Download Excel template for price list import
        function downloadPriceListTemplate() {
            const template = [
                ['Name', 'Category', 'Unit', 'Standard Rate', 'OT Rate', 'WE Rate', 'Is Combined', 'Included Resources'],
                ['Senior Porter', 'human', 'hour', '25.00', '30.00', '35.00', 'false', ''],
                ['Van 3.5t', 'vehicles', 'hour', '35.00', '40.00', '45.00', 'false', ''],
                ['Combined Driver + Van', 'vehicles', 'hour', '45.00', '50.00', '55.00', 'true', 'Driver,Van 3.5t'],
                ['Packing Materials', 'materials', 'each', '15.00', '15.00', '15.00', 'false', ''],
                ['Furniture Dolly', 'equipment', 'day', '20.00', '20.00', '20.00', 'false', '']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Price List Template');
            
            XLSX.writeFile(wb, 'price_list_template.xlsx');
        }
        
        // Handle price list import from Excel
        function handlePriceListImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Remove header row
                    const rows = jsonData.slice(1);
                    
                    // Validate and process data
                    const processedData = [];
                    const errors = [];
                    
                    rows.forEach((row, index) => {
                        if (row.length >= 4 && row[0] && row[1] && row[2] && row[3]) {
                            const item = {
                                name: row[0].toString().trim(),
                                category: row[1].toString().toLowerCase().trim(),
                                unit: row[2].toString().toLowerCase().trim(),
                                standardRate: parseFloat(row[3]) || 0,
                                otRate: parseFloat(row[4]) || parseFloat(row[3]) || 0,
                                weRate: parseFloat(row[5]) || parseFloat(row[3]) || 0,
                                isCombined: row[6] === 'true' || row[6] === true,
                                includedResources: row[7] ? row[7].toString().split(',').map(r => r.trim()) : []
                            };
                            
                            // Validate category
                            if (!['human', 'vehicles', 'materials', 'equipment'].includes(item.category)) {
                                errors.push(`Row ${index + 2}: Invalid category "${item.category}"`);
                            }
                            
                            // Validate unit
                            if (!['hour', 'day', 'each'].includes(item.unit)) {
                                errors.push(`Row ${index + 2}: Invalid unit "${item.unit}"`);
                            }
                            
                            processedData.push(item);
                        } else if (row.length > 0 && row.some(cell => cell)) {
                            errors.push(`Row ${index + 2}: Incomplete data`);
                        }
                    });
                    
                    if (errors.length > 0) {
                        alert(' Import errors found:\n\n' + errors.join('\n'));
                        return;
                    }
                    
                    if (processedData.length === 0) {
                        alert(' No valid data found in the file.');
                        return;
                    }
                    
                    // Show preview modal
                    showPriceListImportPreview(processedData);
                    
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    alert(' Error processing Excel file. Please check the file format.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Show preview modal for price list import
        function showPriceListImportPreview(data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                    <h2>Import Price List Preview</h2>
                    <p>Review the data before importing. This will update your resource database.</p>
                    
                    <div style="max-height: 400px; overflow-y: auto; margin: 1rem 0;">
                        <table style="width: 100%; font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Unit</th>
                                    <th>Standard Rate</th>
                                    <th>OT Rate</th>
                                    <th>WE Rate</th>
                                    <th>Combined</th>
                                    <th>Included</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.category}</td>
                                        <td>${item.unit}</td>
                                        <td>${item.standardRate.toFixed(2)}</td>
                                        <td>${item.otRate.toFixed(2)}</td>
                                        <td>${item.weRate.toFixed(2)}</td>
                                        <td>${item.isCombined ? 'Yes' : 'No'}</td>
                                        <td>${item.includedResources.join(', ') || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button onclick="importPriceListData(${JSON.stringify(data).replace(/"/g, '&quot;')})" class="success"> Import Data</button>
                        <button onclick="closePriceListImportPreview()" class="secondary"> Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Close price list import preview
        function closePriceListImportPreview() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Import price list data to database
        function importPriceListData(data) {
            try {
                let importedCount = 0;
                let updatedCount = 0;
                
                data.forEach(item => {
                    // Check if resource already exists
                    const existingIndex = db.resources.findIndex(r => 
                        r.name.toLowerCase() === item.name.toLowerCase() && 
                        r.category === item.category
                    );
                    
                    const resourceData = {
                        id: existingIndex >= 0 ? db.resources[existingIndex].id : generateId(),
                        name: item.name,
                        category: item.category,
                        unit: item.unit,
                        netCost: item.standardRate * 0.7, // Estimate 70% of client price as cost
                        standardRate: item.standardRate,
                        otRate: item.otRate,
                        weRate: item.weRate,
                        isCombined: item.isCombined,
                        includedResources: item.includedResources,
                        status: 'active'
                    };
                    
                    if (existingIndex >= 0) {
                        // Update existing resource
                        db.resources[existingIndex] = { ...db.resources[existingIndex], ...resourceData };
                        updatedCount++;
                    } else {
                        // Add new resource
                        db.resources.push(resourceData);
                        importedCount++;
                    }
                });
                
                // Save to database
                saveDatabase();
                
                // Close modal
                closePriceListImportPreview();
                
                // Show success message
                alert(` Import completed successfully!\n\n New resources: ${importedCount}\n Updated resources: ${updatedCount}\n\nYour resource database has been updated.`);
                
                // Refresh views
                if (currentPage === 'resources') {
                    updateResourcesTable();
                }
                
            } catch (error) {
                console.error('Error importing price list data:', error);
                alert(' Error importing data. Please try again.');
            }
        }
        
        // Expose price list functions to global scope
        window.downloadPriceListTemplate = downloadPriceListTemplate;
        window.handlePriceListImport = handlePriceListImport;
        window.showPriceListImportPreview = showPriceListImportPreview;
        window.closePriceListImportPreview = closePriceListImportPreview;
        window.importPriceListData = importPriceListData;

        // ========================================
        // EVENT HANDLERS & INITIALIZATION
        // ========================================
        
        // Enhanced DOMContentLoaded handler - LOGIN DISABLED
        document.addEventListener('DOMContentLoaded', async function() {
            // Load users from JSON file first
            console.log(' Loading users from users.json...');
            await loadUsersFromJSON();
            
            // Load backup if available
            loadUsersBackup();
            
            // BYPASS LOGIN - Go directly to main app
            console.log(' Login bypass enabled - loading main app directly');
            
            // Hide auth overlay and show main app immediately
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-navbar').style.display = 'flex';
            // DON'T set inline style on dashboard - let CSS classes control it
            
            // Set dummy user info (no login required)
            document.getElementById('current-user-info').textContent = ' Guest User';
            
            // Load main app directly
            init();
        });
    </script>
</body>
</html>